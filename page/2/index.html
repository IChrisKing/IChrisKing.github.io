<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>IChrisKing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="IChrisKing">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="IChrisKing">
<meta property="og:locale" content="zh-Hant-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="IChrisKing">
  
    <link rel="alternate" href="/atom.xml" title="IChrisKing" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">IChrisKing</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">#IMNOTCHRISLEE</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-about-iptables" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/27/about-iptables/" class="article-date">
  <time datetime="2017-04-27T03:20:05.000Z" itemprop="datePublished">2017-04-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/net/">net</a>►<a class="article-category-link" href="/categories/net/iptables/">iptables</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/27/about-iptables/">iptables在anet项目中的运用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="关于iptables"><a href="#关于iptables" class="headerlink" title="关于iptables"></a>关于iptables</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>iptables是linux平台的网络访问控制管理系统，是一个包过滤防火墙。<br>它会检查数据包的相关信息，如源地址，目的地址，源端口，目的端口，协议类型等，结合规则的设置，来决定数据包的处理方法。</p>
<h3 id="规则表（table）与规则链（chains）"><a href="#规则表（table）与规则链（chains）" class="headerlink" title="规则表（table）与规则链（chains）"></a>规则表（table）与规则链（chains）</h3><h4 id="规则链"><a href="#规则链" class="headerlink" title="规则链"></a>规则链</h4><p>数据包会在如下五个位置经受检查：</p>
<ol>
<li>内核空间中：从一个网络接口进来，到另一个网络接口去</li>
<li>数据包从内核流向用户空间</li>
<li>数据包从用户空间流出</li>
<li>进入/离开本机的外网接口</li>
<li>进入/离开本机的内网接口<br>这五个位置对应着iptables的五个规则链</li>
<li>PREROUTING (路由前)</li>
<li>INPUT (数据包流入口)</li>
<li>FORWARD (转发管卡)</li>
<li>OUTPUT(数据包出口)</li>
<li>POSTROUTING（路由后）</li>
</ol>
<p>从数据流向的角度来看，任何一个数据包，只要经过本机，一定会经过这五个链中的一个。<br><img src="/assets/img/about-iptables/links.png" alt="image"> </p>
<ul>
<li><p>第一种情况：入站数据流向</p>
<pre><code>从外界到达防火墙的数据包，先被PREROUTING规则链处理（是否修改数据包地址等），之后会进行路由选择（判断该数据包应该发往何处），如果数据包 的目标主机是防火墙本机（比如说Internet用户访问防火墙主机中的web服务器的数据包），那么内核将其传给INPUT链进行处理（决定是否允许通 过等），通过以后再交给系统上层的应用程序（比如Apache服务器）进行响应。
</code></pre></li>
<li><p>第二冲情况：转发数据流向</p>
<pre><code>来自外界的数据包到达防火墙后，首先被PREROUTING规则链处理，之后会进行路由选择，如果数据包的目标地址是其它外部地址（比如局域网用户通过网 关访问QQ站点的数据包），则内核将其传递给FORWARD链进行处理（是否转发或拦截），然后再交给POSTROUTING规则链（是否修改数据包的地 址等）进行处理。
</code></pre></li>
<li><p>第三种情况：出站数据流向</p>
<pre><code>防火墙本机向外部地址发送的数据包（比如在防火墙主机中测试公网DNS服务器时），首先被OUTPUT规则链处理，之后进行路由选择，然后传递给POSTROUTING规则链（是否修改数据包的地址等）进行处理。
</code></pre><p>比如，一个进入本机的数据包，首先进入PREROUTING链，然后进入INPUT链；离开本机的数据包，会经过OUTPUT链，然后进入POSTROUTING链；如果本机作为网络的网关，连接内外网，则经过本机的数据会进入FORWARD链。</p>
</li>
</ul>
<h4 id="规则表tables"><a href="#规则表tables" class="headerlink" title="规则表tables"></a>规则表tables</h4><p><img src="/assets/img/about-iptables/tables.png" alt=" " title="image"></p>
<p>iptables内置了4个表，即filter表、nat表、mangle表和raw表，分别用于实现包过滤，网络地址转换、包重构(修改)和数据跟踪处理。<br> Iptables采用“表”和“链”的分层结构。在REHL4中是三张表五个链。REHL5中是四张表五个链。</p>
<h5 id="规则表："><a href="#规则表：" class="headerlink" title="规则表："></a>规则表：</h5><ol>
<li>filter表——三个链：INPUT、FORWARD、OUTPUT<br>作用：过滤数据包  内核模块：iptables_filter.</li>
<li>Nat表——三个链：PREROUTING、POSTROUTING、OUTPUT<br>作用：用于网络地址转换（IP、端口） 内核模块：iptable_nat</li>
<li>Mangle表——五个链：PREROUTING、POSTROUTING、INPUT、OUTPUT、FORWARD<br>作用：修改数据包的服务类型、TTL、并且可以配置路由实现QOS内核模块：iptable_mangle(别看这个表这么麻烦，咱们设置策略时几乎都不会用到它)</li>
<li>Raw表——两个链：OUTPUT、PREROUTING<br>作用：决定数据包是否被状态跟踪机制处理  内核模块：iptable_raw<br>(这个是REHL4没有的，不过用的不多)</li>
</ol>
<p><strong> 规则表之间的优先顺序：</strong><br>Raw——mangle——nat——filter</p>
<h3 id="基本规则语法"><a href="#基本规则语法" class="headerlink" title="基本规则语法"></a>基本规则语法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">iptables [-t filter] [-AI INPUT,OUTPUT,FORWARD] [-io interface]</div><div class="line">      [-p tcp,udp.icmp,all] [-s ip/nerwork] [--sport ports]</div><div class="line">      [-d ip/netword] [--dport ports] [-j ACCEPT DROP]</div></pre></td></tr></table></figure>
<p>常用命令列表：<br>命令 -A, –append<br>范例 iptables -A INPUT …<br>说明 新增规则到某个规则链中，该规则将会成为规则链中的最后一条规则。<br>命令 -D, –delete<br>范例 iptables -D INPUT –dport 80 -j DROP<br>iptables -D INPUT 1<br>说明 从某个规则链中删除一条规则，可以输入完整规则，或直接指定规则编号加以删除。<br>命令 -R, –replace<br>范例 iptables -R INPUT 1 -s 192.168.0.1 -j DROP<br>说明 取代现行规则，规则被取代后并不会改变顺序。<br>命令 -I, –insert<br>范例 iptables -I INPUT 1 –dport 80 -j ACCEPT<br>说明 插入一条规则，原本该位置上的规则将会往后移动一个顺位。<br>命令 -L, –list<br>范例 iptables -L INPUT<br>说明 列出某规则链中的所有规则。<br>命令 -F, –flush<br>范例 iptables -F INPUT<br>说明 删除某规则链中的所有规则。<br>命令 -Z, –zero<br>范例 iptables -Z INPUT<br>说明 将封包计数器归零。封包计数器是用来计算同一封包出现次数，是过滤阻断式攻击不可或缺的工具。<br>命令 -N, –new-chain<br>范例 iptables -N allowed<br>说明 定义新的规则链。<br>命令 -X, –delete-chain<br>范例 iptables -X allowed<br>说明 删除某个规则链。<br>命令 -P, –policy<br>范例 iptables -P INPUT DROP<br>说明 定义过滤政策。 也就是未符合过滤条件之封包，预设的处理方式。<br>命令 -E, –rename-chain<br>范例 iptables -E allowed disallowed<br>说明 修改某自订规则链的名称。<br>常用封包比对参数：<br>参数 -p, –protocol<br>范例 iptables -A INPUT -p tcp<br>说明 比对通讯协议类型是否相符，可以使用 ! 运算子进行反向比对，例如：-p ! tcp ，意思是指除 tcp 以外的其它类型，包含udp、icmp …等。如果要比对所有类型，则可以使用 all 关键词，例如：-p all。<br>参数 -s, –src, –source<br>范例 iptables -A INPUT -s 192.168.1.1<br>说明 用来比对封包的来源 IP，可以比对单机或网络，比对网络时请用数字来表示屏蔽，例如：-s 192.168.0.0/24，比对 IP 时可以使用 ! 运算子进行反向比对，例如：-s ! 192.168.0.0/24。<br>参数 -d, –dst, –destination<br>范例 iptables -A INPUT -d 192.168.1.1<br>说明 用来比对封包的目的地 IP，设定方式同上。<br>参数 -i, –in-interface<br>范例 iptables -A INPUT -i eth0<br>说明 用来比对封包是从哪片网卡进入，可以使用通配字符 + 来做大范围比对，例如：-i eth+ 表示所有的 ethernet 网卡，也以使用 ! 运算子进行反向比对，例如：-i ! eth0。<br>参数 -o, –out-interface<br>范例 iptables -A FORWARD -o eth0<br>说明 用来比对封包要从哪片网卡送出，设定方式同上。<br>参数 –sport, –source-port<br>范例 iptables -A INPUT -p tcp –sport 22<br>说明 用来比对封包的来源埠号，可以比对单一埠，或是一个范围，例如：–sport 22:80，表示从 22 到 80 埠之间都算是符合件，如果要比对不连续的多个埠，则必须使用 –multiport 参数，详见后文。比对埠号时，可以使用 ! 运算子进行反向比对。<br>参数 –dport, –destination-port<br>范例 iptables -A INPUT -p tcp –dport 22<br>说明 用来比对封包的目的地埠号，设定方式同上。<br>参数 –tcp-flags<br>范例 iptables -p tcp –tcp-flags SYN,FIN,ACK SYN<br>说明 比对 TCP 封包的状态旗号，参数分为两个部分，第一个部分列举出想比对的旗号，第二部分则列举前述旗号中哪些有被设，未被列举的旗号必须是空的。TCP 状态旗号包括：SYN（同步）、ACK（应答）、FIN（结束）、RST（重设）、URG（紧急）<br>PSH（强迫推送） 等均可使用于参数中，除此之外还可以使用关键词 ALL 和 NONE 进行比对。比对旗号时，可以使用 ! 运算子行反向比对。<br>参数 –syn<br>范例 iptables -p tcp –syn<br>说明 用来比对是否为要求联机之 TCP 封包，与 iptables -p tcp –tcp-flags SYN,FIN,ACK SYN 的作用完全相同，如果使用 !运算子，可用来比对非要求联机封包。<br>参数 -m multiport –source-port<br>范例 iptables -A INPUT -p tcp -m multiport –source-port 22,53,80,110<br>说明 用来比对不连续的多个来源埠号，一次最多可以比对 15 个埠，可以使用 ! 运算子进行反向比对。<br>参数 -m multiport –destination-port<br>范例 iptables -A INPUT -p tcp -m multiport –destination-port 22,53,80,110<br>说明 用来比对不连续的多个目的地埠号，设定方式同上。<br>参数 -m multiport –port<br>范例 iptables -A INPUT -p tcp -m multiport –port 22,53,80,110<br>说明 这个参数比较特殊，用来比对来源埠号和目的埠号相同的封包，设定方式同上。注意：在本范例中，如果来源端口号为 80 目的地埠号为 110，这种封包并不算符合条件。<br>参数 –icmp-type<br>范例 iptables -A INPUT -p icmp –icmp-type 8<br>说明 用来比对 ICMP 的类型编号，可以使用代码或数字编号来进行比对。请打 iptables -p icmp –help 来查看有哪些代码可用。<br>参数 -m limit –limit<br>范例 iptables -A INPUT -m limit –limit 3/hour<br>说明 用来比对某段时间内封包的平均流量，上面的例子是用来比对：每小时平均流量是否超过一次 3 个封包。 除了每小时平均次外，也可以每秒钟、每分钟或每天平均一次，默认值为每小时平均一次，参数如后： /second、 /minute、/day。 除了进行封<br>数量的比对外，设定这个参数也会在条件达成时，暂停封包的比对动作，以避免因骇客使用洪水攻击法，导致服务被阻断。<br>参数 –limit-burst<br>范例 iptables -A INPUT -m limit –limit-burst 5<br>说明 用来比对瞬间大量封包的数量，上面的例子是用来比对一次同时涌入的封包是否超过 5 个（这是默认值），超过此上限的封将被直接丢弃。使用效果同上。<br>参数 -m mac –mac-source<br>范例 iptables -A INPUT -m mac –mac-source 00:00:00:00:00:01<br>说明 用来比对封包来源网络接口的硬件地址，这个参数不能用在 OUTPUT 和 Postrouting 规则炼上，这是因为封包要送出到网后，才能由网卡驱动程序透过 ARP 通讯协议查出目的地的 MAC 地址，所以 iptables 在进行封包比对时，并不知道封包会送到个网络接口去。<br>参数 –mark<br>范例 iptables -t mangle -A INPUT -m mark –mark 1<br>说明 用来比对封包是否被表示某个号码，当封包被比对成功时，我们可以透过 MARK 处理动作，将该封包标示一个号码，号码最不可以超过 4294967296。<br>参数 -m owner –uid-owner<br>范例 iptables -A OUTPUT -m owner –uid-owner 500<br>说明 用来比对来自本机的封包，是否为某特定使用者所产生的，这样可以避免服务器使用 root 或其它身分将敏感数据传送出，可以降低系统被骇的损失。可惜这个功能无法比对出来自其它主机的封包。<br>参数 -m owner –gid-owner<br>范例 iptables -A OUTPUT -m owner –gid-owner 0<br>说明 用来比对来自本机的封包，是否为某特定使用者群组所产生的，使用时机同上。<br>参数 -m owner –pid-owner<br>范例 iptables -A OUTPUT -m owner –pid-owner 78<br>说明 用来比对来自本机的封包，是否为某特定行程所产生的，使用时机同上。<br>参数 -m owner –sid-owner<br>范例 iptables -A OUTPUT -m owner –sid-owner 100<br>说明 用来比对来自本机的封包，是否为某特定联机（Session ID）的响应封包，使用时机同上。<br>参数 -m state –state<br>范例 iptables -A INPUT -m state –state RELATED,ESTABLISHED<br>说明 用来比对联机状态，联机状态共有四种：INVALID、ESTABLISHED、NEW 和 RELATED。</p>
<p>INVALID 表示该封包的联机编号（Session ID）无法辨识或编号不正确。<br>ESTABLISHED 表示该封包属于某个已经建立的联机。<br>NEW 表示该封包想要起始一个联机（重设联机或将联机重导向）。<br>RELATED 表示该封包是属于某个已经建立的联机，所建立的新联机。例如：FTP-DATA 联机必定是源自某个 FTP 联机。</p>
<p>常用的处理动作：<br>-j 参数用来指定要进行的处理动作，常用的处理动作包括：ACCEPT、REJECT、DROP、REDIRECT、MASQUERADE、LOG、DNAT、</p>
<p>SNAT、MIRROR、QUEUE、RETURN、MARK，分别说明如下：<br>ACCEPT 将封包放行，进行完此处理动作后，将不再比对其它规则，直接跳往下一个规则炼（natostrouting）。<br>REJECT 拦阻该封包，并传送封包通知对方，可以传送的封包有几个选择：ICMP port-unreachable、ICMP echo-reply 或是<br>tcp-reset（这个封包会要求对方关闭联机），进行完此处理动作后，将不再比对其它规则，直接 中断过滤程序。 范例如下：<br>iptables -A FORWARD -p TCP –dport 22 -j REJECT –reject-with tcp-reset<br>DROP 丢弃封包不予处理，进行完此处理动作后，将不再比对其它规则，直接中断过滤程序。<br>REDIRECT 将封包重新导向到另一个端口（PNAT），进行完此处理动作后，将 会继续比对其它规则。 这个功能可以用来实作通透式<br>porxy 或用来保护 web 服务器。例如：iptables -t nat -A PREROUTING -p tcp –dport 80 -j REDIRECT –to-ports 8080<br>MASQUERADE 改写封包来源 IP 为防火墙 NIC IP，可以指定 port 对应的范围，进行完此处理动作后，直接跳往下一个规则（mangleostrouting）。这个功能与 SNAT 略有不同，当进行 IP 伪装时，不需指定要伪装成哪个 IP，IP 会从网卡直接读，当使用拨接连线时，IP 通常是由 ISP 公司的 DHCP 服务器指派的，这个时候 MASQUERADE 特别有用。范例如下：<br>iptables -t nat -A POSTROUTING -p TCP -j MASQUERADE –to-ports 1024-31000<br>LOG 将封包相关讯息纪录在 /var/log 中，详细位置请查阅 /etc/syslog.conf 组态档，进行完此处理动作后，将会继续比对其规则。例如：<br>iptables -A INPUT -p tcp -j LOG –log-prefix “INPUT packets”<br>SNAT 改写封包来源 IP 为某特定 IP 或 IP 范围，可以指定 port 对应的范围，进行完此处理动作后，将直接跳往下一个规则（mangleostrouting）。范例如下：<br>iptables -t nat -A POSTROUTING -p tcp-o eth0 -j SNAT –to-source 194.236.50.155-194.236.50.160:1024-32000<br>DNAT 改写封包目的地 IP 为某特定 IP 或 IP 范围，可以指定 port 对应的范围，进行完此处理动作后，将会直接跳往下一个规炼（filter:input 或 filter:forward）。范例如下：<br>iptables -t nat -A PREROUTING -p tcp -d 15.45.23.67 –dport 80 -j DNAT –to-destination<br>192.168.1.1-192.168.1.10:80-100<br>MIRROR 镜射封包，也就是将来源 IP 与目的地 IP 对调后，将封包送回，进行完此处理动作后，将会中断过滤程序。<br>QUEUE 中断过滤程序，将封包放入队列，交给其它程序处理。透过自行开发的处理程序，可以进行其它应用，例如：计算联机费…….等。<br>RETURN 结束在目前规则炼中的过滤程序，返回主规则炼继续过滤，如果把自订规则炼看成是一个子程序，那么这个动作，就相当提早结束子程序并返回到主程序中。<br>MARK 将封包标上某个代号，以便提供作为后续过滤的条件判断依据，进行完此处理动作后，将会继续比对其它规则。范例如下：<br>iptables -t mangle -A PREROUTING -p tcp –dport 22 -j MARK –set-mark 2</p>
<h3 id="自定义规则链"><a href="#自定义规则链" class="headerlink" title="自定义规则链"></a>自定义规则链</h3><p>自定义链，最终要应用于默认链上，才能起作用。<br>iptables -N ANET_INPUT    –自定义一条名为ANET_INPUT的规则链<br>iptables -I INPUT -j ANET_INPUT;  –将ANET_INPUT应用到INPUT规则链上</p>
<h2 id="anet项目中的应用"><a href="#anet项目中的应用" class="headerlink" title="anet项目中的应用"></a>anet项目中的应用</h2><h3 id="rule-flush方法中的使用"><a href="#rule-flush方法中的使用" class="headerlink" title="rule_flush方法中的使用"></a>rule_flush方法中的使用</h3><h4 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">static int Policy_firewall_flush_linux(struct Policy_pvt* policy)</div><div class="line">&#123;</div><div class="line">    int ret = 0;</div><div class="line">    if (policy-&gt;ifName == NULL) &#123;</div><div class="line">        return ret;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* Remove all old rules */</div><div class="line">    const char* flushAll = &quot;iptables -F ANET_INPUT;&quot;</div><div class="line">                         &quot;iptables -D INPUT -j ANET_INPUT;&quot;</div><div class="line">                         &quot;iptables -X ANET_INPUT;&quot;</div><div class="line">                         &quot;iptables -F ANET_OUTPUT;&quot;</div><div class="line">                         &quot;iptables -D OUTPUT -j ANET_OUTPUT;&quot;</div><div class="line">                         &quot;iptables -X ANET_OUTPUT;&quot;</div><div class="line">                         &quot;ip6tables -F ANET_INPUT;&quot;</div><div class="line">                         &quot;ip6tables -D INPUT -j ANET_INPUT;&quot;</div><div class="line">                         &quot;ip6tables -X ANET_INPUT;&quot;</div><div class="line">                         &quot;ip6tables -F ANET_OUTPUT;&quot;</div><div class="line">                         &quot;ip6tables -D OUTPUT -j ANET_OUTPUT;&quot;</div><div class="line">                         &quot;ip6tables -X ANET_OUTPUT;&quot;;</div><div class="line">    ret = system(flushAll);</div><div class="line">    return ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="命令分析"><a href="#命令分析" class="headerlink" title="命令分析"></a>命令分析</h4><ul>
<li>iptables -F ANET_INPUT;<br>删除ANET_INPUT规则链中的所有规则</li>
<li>iptables -D INPUT -j ANET_INPUT;<br>将ANET_INPUT规则链从INPUT规则链上删除</li>
<li>iptables -X ANET_INPUT;<br>删除ANET_INPUT规则链<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">iptables -F ANET_OUTPUT;</div><div class="line">iptables -D OUTPUT -j ANET_OUTPUT;</div><div class="line">iptables -X ANET_OUTPUT;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>与上面三条类似<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&quot;ip6tables -F ANET_INPUT;&quot;</div><div class="line">&quot;ip6tables -D INPUT -j ANET_INPUT;&quot;</div><div class="line">&quot;ip6tables -X ANET_INPUT;&quot;</div><div class="line">&quot;ip6tables -F ANET_OUTPUT;&quot;</div><div class="line">&quot;ip6tables -D OUTPUT -j ANET_OUTPUT;&quot;</div><div class="line">&quot;ip6tables -X ANET_OUTPUT;&quot;;</div></pre></td></tr></table></figure></p>
<p>与上面六条类似，但作用于ipv6</p>
<h3 id="rule-apply方法中的使用"><a href="#rule-apply方法中的使用" class="headerlink" title="rule_apply方法中的使用"></a>rule_apply方法中的使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div></pre></td><td class="code"><pre><div class="line">static int Policy_firewall_linux(struct Policy_pvt* policy,</div><div class="line">                                  struct Policy_RuleList* rules)</div><div class="line">&#123;</div><div class="line">    int ret = 0;</div><div class="line">    if (policy-&gt;ifName == NULL) &#123;</div><div class="line">        return ret;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* Remove all old rules */</div><div class="line">    const char* initAll = &quot;iptables -F ANET_INPUT;&quot;</div><div class="line">                         &quot;iptables -D INPUT -j ANET_INPUT;&quot;</div><div class="line">                         &quot;iptables -X ANET_INPUT;&quot;</div><div class="line">                         &quot;iptables -N ANET_INPUT;&quot;</div><div class="line">                         &quot;iptables -I INPUT -j ANET_INPUT;&quot;</div><div class="line">                         &quot;iptables -F ANET_OUTPUT;&quot;</div><div class="line">                         &quot;iptables -D OUTPUT -j ANET_OUTPUT;&quot;</div><div class="line">                         &quot;iptables -N ANET_OUTPUT;&quot;</div><div class="line">                         &quot;iptables -I OUTPUT -j ANET_OUTPUT;&quot;</div><div class="line">                         &quot;ip6tables -F ANET_INPUT;&quot;</div><div class="line">                         &quot;ip6tables -D INPUT -j ANET_INPUT;&quot;</div><div class="line">                         &quot;ip6tables -X ANET_INPUT;&quot;</div><div class="line">                         &quot;ip6tables -N ANET_INPUT;&quot;</div><div class="line">                         &quot;ip6tables -I INPUT -j ANET_INPUT;&quot;</div><div class="line">                         &quot;ip6tables -F ANET_OUTPUT;&quot;</div><div class="line">                         &quot;ip6tables -D OUTPUT -j ANET_OUTPUT;&quot;</div><div class="line">                         &quot;ip6tables -X ANET_OUTPUT;&quot;</div><div class="line">                         &quot;ip6tables -N ANET_OUTPUT;&quot;</div><div class="line">                         &quot;ip6tables -I OUTPUT -j ANET_OUTPUT;&quot;;</div><div class="line">    ret = system(initAll);</div><div class="line"></div><div class="line">    const char* fmt = &quot;%s -A %s %s -s %s -d %s -j %s&quot;;</div><div class="line">    char buff[4096];</div><div class="line">    char ip[40];</div><div class="line">    char addr[64];</div><div class="line">    char iface[256], oface[256];</div><div class="line">    char* localip = NULL;</div><div class="line">    char* remoteip = NULL;</div><div class="line">    char* action;</div><div class="line">    char* dir;</div><div class="line">    char* cmd;</div><div class="line">    char* intf;</div><div class="line"></div><div class="line">    Bits_memset(iface, 0, sizeof(iface));</div><div class="line">    Bits_memset(oface, 0, sizeof(iface));</div><div class="line">    snprintf(iface, sizeof(iface) - 1, &quot;-i %s&quot;, policy-&gt;ifName-&gt;bytes);</div><div class="line">    snprintf(oface, sizeof(oface) - 1, &quot;-o %s&quot;, policy-&gt;ifName-&gt;bytes);</div><div class="line"></div><div class="line">    for (int i = 0; i &lt; rules-&gt;length; ++i) &#123;</div><div class="line">        struct Rule* rule = rules-&gt;rules[i];</div><div class="line">        if (rule-&gt;location == Policy_INPUT) &#123;</div><div class="line">            dir = &quot;ANET_INPUT&quot;;</div><div class="line">            intf = iface;</div><div class="line">        &#125; else &#123;</div><div class="line">            dir = &quot;ANET_OUTPUT&quot;;</div><div class="line">            intf = oface;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (rule-&gt;elem.af == Sockaddr_AF_INET) &#123;</div><div class="line">            cmd = &quot;iptables&quot;;</div><div class="line">        &#125; else if (rule-&gt;elem.af == Sockaddr_AF_INET6)&#123;</div><div class="line">            cmd = &quot;ip6tables&quot;;</div><div class="line">        &#125; else &#123;</div><div class="line">            continue;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (rule-&gt;elem.sprefix == 0) &#123;</div><div class="line">            if (rule-&gt;elem.af == Sockaddr_AF_INET) &#123;</div><div class="line">                localip = &quot;0.0.0.0/0&quot;;</div><div class="line">            &#125; else &#123;</div><div class="line">                localip = &quot;::/0&quot;;</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            Bits_memset(ip, 0, sizeof(ip));</div><div class="line">            if (rule-&gt;elem.af == Sockaddr_AF_INET) &#123;</div><div class="line">                snprintf(addr, sizeof(addr), &quot;%u.%u.%u.%u/%u&quot;,</div><div class="line">                         ((uint8_t *)&amp;rule-&gt;elem.src)[0],</div><div class="line">                         ((uint8_t *)&amp;rule-&gt;elem.src)[1],</div><div class="line">                         ((uint8_t *)&amp;rule-&gt;elem.src)[2],</div><div class="line">                         ((uint8_t *)&amp;rule-&gt;elem.src)[3],</div><div class="line">                         rule-&gt;elem.sprefix);</div><div class="line">                localip = addr;</div><div class="line">            &#125; else if (rule-&gt;elem.af == Sockaddr_AF_INET6) &#123;</div><div class="line">                AddrTools_printIp(ip, rule-&gt;elem.src.ip);</div><div class="line">                snprintf(addr, sizeof(addr), &quot;%s/%u&quot;, ip, rule-&gt;elem.sprefix);</div><div class="line">                localip = addr;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if (rule-&gt;elem.dprefix == 0) &#123;</div><div class="line">            if (rule-&gt;elem.af == Sockaddr_AF_INET) &#123;</div><div class="line">                remoteip = &quot;0.0.0.0/0&quot;;</div><div class="line">            &#125; else &#123;</div><div class="line">                remoteip = &quot;::/0&quot;;</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            Bits_memset(ip, 0, sizeof(ip));</div><div class="line">            if (rule-&gt;elem.af == Sockaddr_AF_INET) &#123;</div><div class="line">                snprintf(addr, sizeof(addr), &quot;%u.%u.%u.%u/%u&quot;,</div><div class="line">                         ((uint8_t *)&amp;rule-&gt;elem.dst)[0],</div><div class="line">                         ((uint8_t *)&amp;rule-&gt;elem.dst)[1],</div><div class="line">                         ((uint8_t *)&amp;rule-&gt;elem.dst)[2],</div><div class="line">                         ((uint8_t *)&amp;rule-&gt;elem.dst)[3],</div><div class="line">                         rule-&gt;elem.dprefix);</div><div class="line">                remoteip = addr;</div><div class="line">            &#125; else if (rule-&gt;elem.af == Sockaddr_AF_INET6) &#123;</div><div class="line">                AddrTools_printIp(ip, rule-&gt;elem.dst.ip);</div><div class="line">                snprintf(addr, sizeof(addr), &quot;%s/%u&quot;, ip, rule-&gt;elem.dprefix);</div><div class="line">                remoteip = addr;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if (rule-&gt;action == Rule_ACCEPT) &#123;</div><div class="line">            action = &quot;ACCEPT&quot;;</div><div class="line">        &#125; else &#123;</div><div class="line">            action = &quot;DROP&quot;;</div><div class="line">        &#125;</div><div class="line">        snprintf(buff, sizeof(buff), fmt, cmd, dir, intf, localip, remoteip, action);</div><div class="line">        ret = system(buff);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* firewall header */</div><div class="line">    snprintf(buff, sizeof(buff),</div><div class="line">             &quot;iptables -I ANET_INPUT %s -m state --state RELATED,ESTABLISHED -j ACCEPT&quot;,</div><div class="line">             iface);</div><div class="line">    ret = system(buff);</div><div class="line">    snprintf(buff, sizeof(buff),</div><div class="line">             &quot;ip6tables -I ANET_INPUT %s -m state --state RELATED,ESTABLISHED -j ACCEPT&quot;,</div><div class="line">             iface);</div><div class="line">    ret = system(buff);</div><div class="line">    snprintf(buff, sizeof(buff),</div><div class="line">             &quot;iptables -I ANET_OUTPUT %s -m state --state RELATED,ESTABLISHED -j ACCEPT&quot;,</div><div class="line">             oface);</div><div class="line">    ret = system(buff);</div><div class="line">    snprintf(buff, sizeof(buff),</div><div class="line">             &quot;ip6tables -I ANET_OUTPUT %s -m state --state RELATED,ESTABLISHED -j ACCEPT&quot;,</div><div class="line">             oface);</div><div class="line">    ret = system(buff);</div><div class="line"></div><div class="line">    /* firewall footer */</div><div class="line">    if (policy-&gt;pub.defaultAction == Policy_ACCEPT) &#123;</div><div class="line">        action = &quot;ACCEPT&quot;;</div><div class="line">    &#125; else &#123;</div><div class="line">        action = &quot;DROP&quot;;</div><div class="line">    &#125;</div><div class="line">    snprintf(buff, sizeof(buff), &quot;iptables -A ANET_INPUT %s -j %s&quot;, iface, action);</div><div class="line">    ret = system(buff);</div><div class="line">    snprintf(buff, sizeof(buff), &quot;ip6tables -A ANET_INPUT %s -j %s&quot;, iface, action);</div><div class="line">    ret = system(buff);</div><div class="line">    snprintf(buff, sizeof(buff), &quot;iptables -A ANET_OUTPUT %s -j %s&quot;, oface, action);</div><div class="line">    ret = system(buff);</div><div class="line">    snprintf(buff, sizeof(buff), &quot;ip6tables -A ANET_OUTPUT %s -j %s&quot;, oface, action);</div><div class="line">    ret = system(buff);</div><div class="line"></div><div class="line">    return ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个方法中，对于iptables命令的使用，主要分为四块：</p>
<h4 id="Remove-all-old-rules"><a href="#Remove-all-old-rules" class="headerlink" title="Remove all old rules"></a>Remove all old rules</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&quot;iptables -F ANET_INPUT;&quot;</div><div class="line">&quot;iptables -D INPUT -j ANET_INPUT;&quot;</div><div class="line">&quot;iptables -X ANET_INPUT;&quot;</div><div class="line">&quot;iptables -N ANET_INPUT;&quot;</div><div class="line">&quot;iptables -I INPUT -j ANET_INPUT;&quot;</div><div class="line">&quot;iptables -F ANET_OUTPUT;&quot;</div><div class="line">&quot;iptables -D OUTPUT -j ANET_OUTPUT;&quot;</div><div class="line">&quot;iptables -N ANET_OUTPUT;&quot;</div><div class="line">&quot;iptables -I OUTPUT -j ANET_OUTPUT;&quot;</div><div class="line">&quot;ip6tables -F ANET_INPUT;&quot;</div><div class="line">&quot;ip6tables -D INPUT -j ANET_INPUT;&quot;</div><div class="line">&quot;ip6tables -X ANET_INPUT;&quot;</div><div class="line">&quot;ip6tables -N ANET_INPUT;&quot;</div><div class="line">&quot;ip6tables -I INPUT -j ANET_INPUT;&quot;</div><div class="line">&quot;ip6tables -F ANET_OUTPUT;&quot;</div><div class="line">&quot;ip6tables -D OUTPUT -j ANET_OUTPUT;&quot;</div><div class="line">&quot;ip6tables -X ANET_OUTPUT;&quot;</div><div class="line">&quot;ip6tables -N ANET_OUTPUT;&quot;</div><div class="line">&quot;ip6tables -I OUTPUT -j ANET_OUTPUT;&quot;;</div></pre></td></tr></table></figure>
<p>以ANET_INPUT为例，这一部分首先做了和rule_flush一样的操作，删除相关数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&quot;iptables -F ANET_INPUT;&quot;</div><div class="line">&quot;iptables -D INPUT -j ANET_INPUT;&quot;</div><div class="line">&quot;iptables -X ANET_INPUT;&quot;</div></pre></td></tr></table></figure></p>
<p>然后，<br>新建自定义规则链ANET_INPUT<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -N ANET_INPUT;</div></pre></td></tr></table></figure></p>
<p>将它应用到INPUT规则链上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -I INPUT -j ANET_INPUT;</div></pre></td></tr></table></figure></p>
<h4 id="根据规则，拼接iptables命令"><a href="#根据规则，拼接iptables命令" class="headerlink" title="根据规则，拼接iptables命令"></a>根据规则，拼接iptables命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line">const char* fmt = &quot;%s -A %s %s -s %s -d %s -j %s&quot;;</div><div class="line">char buff[4096];</div><div class="line">char ip[40];</div><div class="line">char addr[64];</div><div class="line">char iface[256], oface[256];</div><div class="line">char* localip = NULL;</div><div class="line">char* remoteip = NULL;</div><div class="line">char* action;</div><div class="line">char* dir;</div><div class="line">char* cmd;</div><div class="line">char* intf;</div><div class="line"></div><div class="line">Bits_memset(iface, 0, sizeof(iface));</div><div class="line">Bits_memset(oface, 0, sizeof(iface));</div><div class="line">snprintf(iface, sizeof(iface) - 1, &quot;-i %s&quot;, policy-&gt;ifName-&gt;bytes);</div><div class="line">snprintf(oface, sizeof(oface) - 1, &quot;-o %s&quot;, policy-&gt;ifName-&gt;bytes);</div><div class="line"></div><div class="line">for (int i = 0; i &lt; rules-&gt;length; ++i) &#123;</div><div class="line">    struct Rule* rule = rules-&gt;rules[i];</div><div class="line">    if (rule-&gt;location == Policy_INPUT) &#123;</div><div class="line">        dir = &quot;ANET_INPUT&quot;;</div><div class="line">        intf = iface;</div><div class="line">    &#125; else &#123;</div><div class="line">        dir = &quot;ANET_OUTPUT&quot;;</div><div class="line">        intf = oface;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (rule-&gt;elem.af == Sockaddr_AF_INET) &#123;</div><div class="line">        cmd = &quot;iptables&quot;;</div><div class="line">    &#125; else if (rule-&gt;elem.af == Sockaddr_AF_INET6)&#123;</div><div class="line">        cmd = &quot;ip6tables&quot;;</div><div class="line">    &#125; else &#123;</div><div class="line">        continue;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (rule-&gt;elem.sprefix == 0) &#123;</div><div class="line">        if (rule-&gt;elem.af == Sockaddr_AF_INET) &#123;</div><div class="line">            localip = &quot;0.0.0.0/0&quot;;</div><div class="line">        &#125; else &#123;</div><div class="line">            localip = &quot;::/0&quot;;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        Bits_memset(ip, 0, sizeof(ip));</div><div class="line">        if (rule-&gt;elem.af == Sockaddr_AF_INET) &#123;</div><div class="line">            snprintf(addr, sizeof(addr), &quot;%u.%u.%u.%u/%u&quot;,</div><div class="line">                     ((uint8_t *)&amp;rule-&gt;elem.src)[0],</div><div class="line">                     ((uint8_t *)&amp;rule-&gt;elem.src)[1],</div><div class="line">                     ((uint8_t *)&amp;rule-&gt;elem.src)[2],</div><div class="line">                     ((uint8_t *)&amp;rule-&gt;elem.src)[3],</div><div class="line">                     rule-&gt;elem.sprefix);</div><div class="line">            localip = addr;</div><div class="line">        &#125; else if (rule-&gt;elem.af == Sockaddr_AF_INET6) &#123;</div><div class="line">            AddrTools_printIp(ip, rule-&gt;elem.src.ip);</div><div class="line">            snprintf(addr, sizeof(addr), &quot;%s/%u&quot;, ip, rule-&gt;elem.sprefix);</div><div class="line">            localip = addr;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    if (rule-&gt;elem.dprefix == 0) &#123;</div><div class="line">        if (rule-&gt;elem.af == Sockaddr_AF_INET) &#123;</div><div class="line">            remoteip = &quot;0.0.0.0/0&quot;;</div><div class="line">        &#125; else &#123;</div><div class="line">            remoteip = &quot;::/0&quot;;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        Bits_memset(ip, 0, sizeof(ip));</div><div class="line">        if (rule-&gt;elem.af == Sockaddr_AF_INET) &#123;</div><div class="line">            snprintf(addr, sizeof(addr), &quot;%u.%u.%u.%u/%u&quot;,</div><div class="line">                     ((uint8_t *)&amp;rule-&gt;elem.dst)[0],</div><div class="line">                     ((uint8_t *)&amp;rule-&gt;elem.dst)[1],</div><div class="line">                     ((uint8_t *)&amp;rule-&gt;elem.dst)[2],</div><div class="line">                     ((uint8_t *)&amp;rule-&gt;elem.dst)[3],</div><div class="line">                     rule-&gt;elem.dprefix);</div><div class="line">            remoteip = addr;</div><div class="line">        &#125; else if (rule-&gt;elem.af == Sockaddr_AF_INET6) &#123;</div><div class="line">            AddrTools_printIp(ip, rule-&gt;elem.dst.ip);</div><div class="line">            snprintf(addr, sizeof(addr), &quot;%s/%u&quot;, ip, rule-&gt;elem.dprefix);</div><div class="line">            remoteip = addr;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    if (rule-&gt;action == Rule_ACCEPT) &#123;</div><div class="line">        action = &quot;ACCEPT&quot;;</div><div class="line">    &#125; else &#123;</div><div class="line">        action = &quot;DROP&quot;;</div><div class="line">    &#125;</div><div class="line">    snprintf(buff, sizeof(buff), fmt, cmd, dir, intf, localip, remoteip, action);</div><div class="line">    ret = system(buff);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这一过程中，会根据策略规则，获取相关信息，最终拼接出格式如下的规则。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A ANET_INPUT -i tun0 -s srcip/srcport -d dstip/dstport -j ACCEPT</div></pre></td></tr></table></figure></p>
<h4 id="firewall-header"><a href="#firewall-header" class="headerlink" title="firewall header"></a>firewall header</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">snprintf(buff, sizeof(buff),</div><div class="line">         &quot;iptables -I ANET_INPUT %s -m state --state RELATED,ESTABLISHED -j ACCEPT&quot;,</div><div class="line">         iface);</div><div class="line">ret = system(buff);</div><div class="line">snprintf(buff, sizeof(buff),</div><div class="line">         &quot;ip6tables -I ANET_INPUT %s -m state --state RELATED,ESTABLISHED -j ACCEPT&quot;,</div><div class="line">         iface);</div><div class="line">ret = system(buff);</div><div class="line">snprintf(buff, sizeof(buff),</div><div class="line">         &quot;iptables -I ANET_OUTPUT %s -m state --state RELATED,ESTABLISHED -j ACCEPT&quot;,</div><div class="line">         oface);</div><div class="line">ret = system(buff);</div><div class="line">snprintf(buff, sizeof(buff),</div><div class="line">         &quot;ip6tables -I ANET_OUTPUT %s -m state --state RELATED,ESTABLISHED -j ACCEPT&quot;,</div><div class="line">         oface);</div><div class="line">ret = system(buff);</div></pre></td></tr></table></figure>
<p>-I 参数的规则默认是插入到规则表最上面的，也就是说，这四条规则是最先进行匹配的。<br>从这四条规则可以看出，连接一旦进入RELATED或ESTABLISHED状态，就ACCEPT，不再进行策略审查。换言之，策略检查都是针对NEW状态的连接数据包的。</p>
<h4 id="firewall-footer"><a href="#firewall-footer" class="headerlink" title="firewall footer"></a>firewall footer</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">if (policy-&gt;pub.defaultAction == Policy_ACCEPT) &#123;</div><div class="line">    action = &quot;ACCEPT&quot;;</div><div class="line">&#125; else &#123;</div><div class="line">    action = &quot;DROP&quot;;</div><div class="line">&#125;</div><div class="line">snprintf(buff, sizeof(buff), &quot;iptables -A ANET_INPUT %s -j %s&quot;, iface, action);</div><div class="line">ret = system(buff);</div><div class="line">snprintf(buff, sizeof(buff), &quot;ip6tables -A ANET_INPUT %s -j %s&quot;, iface, action);</div><div class="line">ret = system(buff);</div><div class="line">snprintf(buff, sizeof(buff), &quot;iptables -A ANET_OUTPUT %s -j %s&quot;, oface, action);</div><div class="line">ret = system(buff);</div><div class="line">snprintf(buff, sizeof(buff), &quot;ip6tables -A ANET_OUTPUT %s -j %s&quot;, oface, action);</div><div class="line">ret = system(buff);</div></pre></td></tr></table></figure>
<p>最后这四条用于设置默认操作，-A参数保证它们会加入到规则表的最后。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/04/27/about-iptables/" data-id="cje6pjw0u0013weyxnapymre2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iptables/">iptables</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-how-to-build-git-on-raspberry" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/21/how-to-build-git-on-raspberry/" class="article-date">
  <time datetime="2017-04-21T02:50:04.000Z" itemprop="datePublished">2017-04-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/树莓派/">树莓派</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/21/how-to-build-git-on-raspberry/">在树莓派上搭建私有git</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="在树莓派上搭建git"><a href="#在树莓派上搭建git" class="headerlink" title="在树莓派上搭建git"></a>在树莓派上搭建git</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ol>
<li><p>安装ssh服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install ssh</div></pre></td></tr></table></figure>
</li>
<li><p>安装git服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install git-core</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="搭建git"><a href="#搭建git" class="headerlink" title="搭建git"></a>搭建git</h3><h4 id="创建git用户"><a href="#创建git用户" class="headerlink" title="创建git用户"></a>创建git用户</h4><ol>
<li><p>新建用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo adduser --system --shell /bin/bash --gecos &apos;git version control by pi&apos; --group --home /home/git git</div></pre></td></tr></table></figure>
</li>
<li><p>修改passwd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo passwd git</div></pre></td></tr></table></figure>
</li>
<li><p>赋su权限<br>如果不赋su权限，会出现无法ssh 登录，无法git clone</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo vim /etc/sudoers</div><div class="line">添加一行</div><div class="line">git ALL=(ALL) ALL</div></pre></td></tr></table></figure>
</li>
<li><p>切换到git</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">su git</div></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="新建git项目"><a href="#新建git项目" class="headerlink" title="新建git项目"></a>新建git项目</h4><ol>
<li><p>进入git目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cd /home/git</div></pre></td></tr></table></figure>
</li>
<li><p>创建git项目并初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir test.git</div><div class="line">cd test.git</div><div class="line">git --bare init</div></pre></td></tr></table></figure>
</li>
</ol>
<p>创建完成后，目录长这样<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git@raspberrypi_chris:~/test.git$ ls</div><div class="line">branches  config  description  HEAD  hooks  info  objects  refs</div></pre></td></tr></table></figure></p>
<ol>
<li>新增远程主机<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git remote add pi git@RASPBERRY&apos;S IP:/home/git/test.git</div></pre></td></tr></table></figure>
</li>
</ol>
<p>其中RASPBERRY‘S IP是树莓派的ip地址，支持ip6。<br>查看一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">git@raspberrypi_chris:~/test.git$ git remote</div><div class="line">pi</div><div class="line"></div><div class="line">git@raspberrypi_chris:~/test.git$ git remote show pi</div><div class="line">git@pi-raspberry&apos;s password: </div><div class="line">* 远程 pi</div><div class="line">  获取地址：git@pi-raspberry:/home/git/test.git</div><div class="line">  推送地址：git@pi-raspberry:/home/git/test.git</div><div class="line">  HEAD分支：master</div><div class="line">  远程分支：</div><div class="line">    master 新的（下一次获取将存储于 remotes/pi）</div><div class="line">  为 &apos;git push&apos; 配置的本地引用：</div><div class="line">    master 推送至 master (最新)</div></pre></td></tr></table></figure></p>
<h3 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h3><p>git搭建完毕，接下来找一个别的机器，来使用它。都是常规的git操作，本人使用linux，所以windows小伙伴自行摸索。</p>
<h4 id="clone项目"><a href="#clone项目" class="headerlink" title="clone项目"></a>clone项目</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git clone git@PASPBERRY&apos;S IP:/home/git/test.git</div></pre></td></tr></table></figure>
<h4 id="与服务器同步"><a href="#与服务器同步" class="headerlink" title="与服务器同步"></a>与服务器同步</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git pull</div></pre></td></tr></table></figure>
<h4 id="对项目做修改并递交"><a href="#对项目做修改并递交" class="headerlink" title="对项目做修改并递交"></a>对项目做修改并递交</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">jinwh@jinwh-office ~/respberry/git/test $ echo &quot;test test test git&quot; &gt; test</div><div class="line">jinwh@jinwh-office ~/respberry/git/test $ git status</div><div class="line">On branch master</div><div class="line">Your branch is up-to-date with &apos;origin/master&apos;.</div><div class="line">Changes not staged for commit:</div><div class="line">  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)</div><div class="line">  (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)</div><div class="line"></div><div class="line">	modified:   test</div><div class="line"></div><div class="line">no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)</div><div class="line">jinwh@jinwh-office ~/respberry/git/test $ git add test</div><div class="line">jinwh@jinwh-office ~/respberry/git/test $ git commit -m &quot;test git&quot;</div><div class="line">[master 1132719] test git</div><div class="line"> 1 file changed, 1 insertion(+), 1 deletion(-)</div><div class="line">jinwh@jinwh-office ~/respberry/git/test $ git push origin master </div><div class="line">git@pi-raspberry&apos;s password: </div><div class="line">Counting objects: 3, done.</div><div class="line">Writing objects: 100% (3/3), 250 bytes | 0 bytes/s, done.</div><div class="line">Total 3 (delta 0), reused 0 (delta 0)</div><div class="line">To git@pi-raspberry:/home/git/test.git</div><div class="line">   c60ed7b..1132719  master -&gt; master</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/04/21/how-to-build-git-on-raspberry/" data-id="cje6pjw1c002cweyxntk314xx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/git/">git</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/树莓派raspberry/">树莓派raspberry</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-raspberry-add-camera-dev" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/15/raspberry-add-camera-dev/" class="article-date">
  <time datetime="2017-03-15T11:15:13.000Z" itemprop="datePublished">2017-03-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/树莓派/">树莓派</a>►<a class="article-category-link" href="/categories/树莓派/配置/">配置</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/15/raspberry-add-camera-dev/">树莓派摄像头没有/dev/video0设备节点的问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="安装mjpg-streamer"><a href="#安装mjpg-streamer" class="headerlink" title="安装mjpg-streamer"></a>安装mjpg-streamer</h2><h3 id="安装依赖库"><a href="#安装依赖库" class="headerlink" title="安装依赖库"></a>安装依赖库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo apt-get update</div><div class="line">sudo apt-get install libjpeg8-dev imagemagick libv4l-dev cmake</div></pre></td></tr></table></figure>
<h3 id="下载mjpg-streamer"><a href="#下载mjpg-streamer" class="headerlink" title="下载mjpg-streamer"></a>下载mjpg-streamer</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mkdir mjpg-streamer</div><div class="line">cd mjpg-streamer</div><div class="line">wget https://codeload.github.com/jacksonliam/mjpg-streamer/zip/master</div><div class="line">mv master mjpg-streamer-master.zip</div><div class="line">unzip mjpg-streamer-master.zip</div></pre></td></tr></table></figure>
<h3 id="安装mjpg-streamer-1"><a href="#安装mjpg-streamer-1" class="headerlink" title="安装mjpg-streamer"></a>安装mjpg-streamer</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cd mjpg-streamer-master/mjpg-streamer-experimental</div><div class="line">sudo make clean all</div><div class="line">sudo cp mjpg_streamer /usr/local/bin</div><div class="line">sudo cp output_http.so input_uvc.so /usr/local/lib/</div><div class="line">sudo cp -R www /usr/local/www</div></pre></td></tr></table></figure>
<h3 id="配置PATH"><a href="#配置PATH" class="headerlink" title="配置PATH"></a>配置PATH</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo vim /etc/profile</div></pre></td></tr></table></figure>
<p>加上两行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#mjpg-streamer</div><div class="line">export LD_LIBRARY_PATH=/opt/mjpg-streamer/</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">source profile</div></pre></td></tr></table></figure>
<h3 id="启动mjpg-streamer"><a href="#启动mjpg-streamer" class="headerlink" title="启动mjpg-streamer"></a>启动mjpg-streamer</h3><ul>
<li>方法1：LD_LIBRARY_PATH=/usr/local/lib mjpg_streamer -i “input_uvc.so” -o “output_http.so -w /usr/local/www”</li>
<li>方法2：配置好PATH之后，执行 mjpg_streamer -i “/usr/local/lib/input_uvc.so” -o “/usr/local/lib/output_http.so -w /usr/local/www”</li>
</ul>
<h3 id="查看效果"><a href="#查看效果" class="headerlink" title="查看效果"></a>查看效果</h3><p>浏览器打开 192.168.2.58:8080/stream.html  (ip换成自己的)</p>
<h3 id="填坑1：找不到-dev-video0"><a href="#填坑1：找不到-dev-video0" class="headerlink" title="填坑1：找不到/dev/video0"></a>填坑1：找不到/dev/video0</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">MJPG Streamer Version.: 2.0</div><div class="line"> i: Using V4L2 device.: /dev/video0</div><div class="line"> i: Desired Resolution: 640 x 480</div><div class="line"> i: Frames Per Second.: -1</div><div class="line"> i: Format............: JPEG</div><div class="line"> i: TV-Norm...........: DEFAULT</div><div class="line">ERROR opening V4L interface: No such file or directory</div><div class="line"> Init v4L2 failed !! exit fatal </div><div class="line"> i: init_VideoIn failed</div></pre></td></tr></table></figure>
<p>这个报错，是因为使用直接插到树莓派视频CSI接口的摄像头造成的。如果使用usb摄像头，则会在/dev目录下出现相关的设备。而直接插到树莓派视频CSI接口的摄像头，使用的是树莓派中的camera module，它是放在/boot/目录下以固件的形式加载的，不是一个标准的v4l2的摄像头ko驱动，所以加载起来之后会找不到/dev/video0的设备节点，这是因为这个驱动是在底层的，v4l2这个驱动框架还没有加载，所以要在/etc/modules里面添加一行bcm2835-v4l2,这句话意思是在系统启动之后会加载这个文件中模块名，这个模块会在树莓派系统的/lib/modules/xxx/xxx/xxx下面，添加之后重启系统，就会在/dev/下面发现video0设备节点了。这个文件名可能不是叫/etc/modules，较早的版本是/etc/modules-load.d/rpi-camera.conf.</p>
<p>然后，重启一下。</p>
<h2 id="配置nginx来转发视频数据流"><a href="#配置nginx来转发视频数据流" class="headerlink" title="配置nginx来转发视频数据流"></a>配置nginx来转发视频数据流</h2><h3 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install nginx</div></pre></td></tr></table></figure>
<h3 id="编写nginx配置文件"><a href="#编写nginx配置文件" class="headerlink" title="编写nginx配置文件"></a>编写nginx配置文件</h3><p>在/etc/nginx/sites-available/ 目录下新建配置文档mjpg，添加如下内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">upstream backend&#123;</div><div class="line">        ip_hash;</div><div class="line">        server 127.0.0.1:8080; ##mjpg-streamer监听的端口是8080</div><div class="line">&#125;</div><div class="line">server &#123;</div><div class="line">        listen 8000 default_server;##另外找一个端口来转发，比如8000</div><div class="line">        listen [::]:8000 default_server ipv6only=on; ##记得配上ipv6的8000端口</div><div class="line">        root /home/pi/;##配好root地址</div><div class="line">        # Make site accessible from http://localhost/</div><div class="line">        charset utf-8;</div><div class="line">        access_log  /var/log/nginx/mjpg.access.log;</div><div class="line">        location / &#123;</div><div class="line">            proxy_pass http://backend;</div><div class="line">            proxy_set_header Host $host;</div><div class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd /etc/nginx/sites-enabled</div><div class="line">sudo ln -s /etc/nginx/sites-available/mjpg mjpg</div><div class="line">sudo service nginx restart</div></pre></td></tr></table></figure>
<h3 id="查看效果-1"><a href="#查看效果-1" class="headerlink" title="查看效果"></a>查看效果</h3><p>首先，浏览器要支持ipv6<br>查看 [fb72:e349:2cd8:52e0:f9d0:e1bf:fb76:1def]:8080/stream.html<br>应该可以看到监控图像。<br>如果看不到，检查mjpg-streamer和nginx是否都打开了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/15/raspberry-add-camera-dev/" data-id="cje6pjw2t0064weyxvffdqzza" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/raspberry配置/">raspberry配置</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/树莓派raspberry/">树莓派raspberry</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ping-pong" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/12/ping-pong/" class="article-date">
  <time datetime="2017-01-12T09:50:41.000Z" itemprop="datePublished">2017-01-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/cjdns/">cjdns</a>►<a class="article-category-link" href="/categories/cjdns/cjdns源码分析/">cjdns源码分析</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/12/ping-pong/">cjdns源码分析--SwitchPing的发送，接收与回复</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="总体概述"><a href="#总体概述" class="headerlink" title="总体概述"></a>总体概述</h2><h3 id="源码位置"><a href="#源码位置" class="headerlink" title="源码位置"></a>源码位置</h3><p>SwitchPing相关的代码多数在net目录下，主要包括<br>ControlHandler.c<br>ControlHandler.h<br>InterfaceController.c<br>InterfaceController.h<br>SwitchPinger.c<br>SwitchPinger.h<br>还有一些在util目录下<br>Pinger.c<br>Pinger.h</p>
<h3 id="调用过程"><a href="#调用过程" class="headerlink" title="调用过程"></a>调用过程</h3><p>ping操作的调用过程<br><img src="/assets/img/ping_pong/ping.png" alt="image"><br>pong操作的调用过程<br><img src="/assets/img/ping_pong/pong.png" alt="image"> </p>
<h2 id="ping发送"><a href="#ping发送" class="headerlink" title="ping发送"></a>ping发送</h2><h3 id="sendPing"><a href="#sendPing" class="headerlink" title="sendPing"></a>sendPing</h3><p>net/InterfaceController.c<br>static void sendPing(struct Peer* ep)  发送ping<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">static void sendPing(struct Peer* ep)</div><div class="line">&#123;</div><div class="line">    struct InterfaceController_pvt* ic = Identity_check(ep-&gt;ici-&gt;ic);</div><div class="line"></div><div class="line">    ep-&gt;pingCount++;</div><div class="line"></div><div class="line">    struct SwitchPinger_Ping* ping =</div><div class="line">        SwitchPinger_newPing(ep-&gt;addr.path,</div><div class="line">                             String_CONST(&quot;&quot;),</div><div class="line">                             ic-&gt;timeoutMilliseconds,</div><div class="line">                             onPingResponse,</div><div class="line">                             ep-&gt;alloc,</div><div class="line">                             ic-&gt;switchPinger);</div><div class="line"></div><div class="line">    if (Defined(Log_DEBUG)) &#123;</div><div class="line">        uint8_t key[56];</div><div class="line">        Base32_encode(key, 56, ep-&gt;caSession-&gt;herPublicKey, 32);</div><div class="line">        if (!ping) &#123;</div><div class="line">            Log_debug(ic-&gt;logger, &quot;Failed to ping [%s.k], out of ping slots&quot;, key);</div><div class="line">        &#125; else &#123;</div><div class="line">            Log_debug(ic-&gt;logger, &quot;SwitchPing [%s.k]&quot;, key);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (ping) &#123;</div><div class="line">        ping-&gt;onResponseContext = ep;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>参数是Peer* ep，说明在发送ping的时候，肯定是知道对方的信息的。</p>
<p>最后<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">if (ping) &#123;</div><div class="line">    ping-&gt;onResponseContext = ep;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>看来整个ping的过程都在SwitchPinger_newPing当中了，查看这个函数</p>
<h3 id="SwitchPinger-newPing"><a href="#SwitchPinger-newPing" class="headerlink" title="SwitchPinger_newPing"></a>SwitchPinger_newPing</h3><p>net/SwitchPinger.c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">struct SwitchPinger_Ping* SwitchPinger_newPing(uint64_t label,</div><div class="line">                                               String* data,</div><div class="line">                                               uint32_t timeoutMilliseconds,</div><div class="line">                                               SwitchPinger_ResponseCallback onResponse,</div><div class="line">                                               struct Allocator* alloc,</div><div class="line">                                               struct SwitchPinger* context)</div></pre></td></tr></table></figure>
<p>先结合调用过程，看一下参数。</p>
<ol>
<li>uint64_t label – ep-&gt;addr.path<br>是address的path部分，形如0000.0000.0000.0023</li>
<li>String* data – String_CONST(“”)<br>携带的数据，ping时，携带的数据是””，即没数据。</li>
<li>uint32_t timeoutMilliseconds – ic-&gt;timeoutMilliseconds<br>超时时间</li>
<li>SwitchPinger_ResponseCallback onResponse – onPingResponse<br>SwitchPinger_ResponseCallback是一个回调函数，它的类型定义在Switchinger.h中<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">typedef void (* SwitchPinger_ResponseCallback)(struct SwitchPinger_Response* resp, void* userData);</div></pre></td></tr></table></figure>
</li>
</ol>
<p>它的实现在InterfaceController.c中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">static void onPingResponse(struct SwitchPinger_Response* resp, void* onResponseContext)</div><div class="line">&#123;</div><div class="line">    if (SwitchPinger_Result_OK != resp-&gt;res) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    struct Peer* ep = Identity_check((struct Peer*) onResponseContext);</div><div class="line">    struct InterfaceController_pvt* ic = Identity_check(ep-&gt;ici-&gt;ic);</div><div class="line"></div><div class="line">    ep-&gt;addr.protocolVersion = resp-&gt;version;</div><div class="line"></div><div class="line">    if (Defined(Log_DEBUG)) &#123;</div><div class="line">        String* addr = Address_toString(&amp;ep-&gt;addr, resp-&gt;ping-&gt;pingAlloc);</div><div class="line">        if (!Version_isCompatible(Version_CURRENT_PROTOCOL, resp-&gt;version)) &#123;</div><div class="line">            Log_debug(ic-&gt;logger, &quot;got switch pong from node [%s] with incompatible version&quot;,</div><div class="line">                                  addr-&gt;bytes);</div><div class="line">        &#125; else if (ep-&gt;addr.path != resp-&gt;label) &#123;</div><div class="line">            uint8_t sl[20];</div><div class="line">            AddrTools_printPath(sl, resp-&gt;label);</div><div class="line">            Log_debug(ic-&gt;logger, &quot;got switch pong from node [%s] mismatch label [%s]&quot;,</div><div class="line">                                  addr-&gt;bytes, sl);</div><div class="line">        &#125; else &#123;</div><div class="line">            Log_debug(ic-&gt;logger, &quot;got switch pong from node [%s]&quot;, addr-&gt;bytes);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (!Version_isCompatible(Version_CURRENT_PROTOCOL, resp-&gt;version)) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (ep-&gt;state == InterfaceController_PeerState_ESTABLISHED) &#123;</div><div class="line">        sendPeer(0xffffffff, PFChan_Core_PEER, ep);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ep-&gt;timeOfLastPing = Time_currentTimeMilliseconds(ic-&gt;eventBase);</div><div class="line"></div><div class="line">    if (Defined(Log_DEBUG)) &#123;</div><div class="line">        String* addr = Address_toString(&amp;ep-&gt;addr, resp-&gt;ping-&gt;pingAlloc);</div><div class="line">        Log_debug(ic-&gt;logger, &quot;Received [%s] from lazy endpoint [%s]&quot;,</div><div class="line">                  SwitchPinger_resultString(resp-&gt;res)-&gt;bytes, addr-&gt;bytes);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>struct Allocator* alloc – ep-&gt;alloc</li>
<li>struct SwitchPinger* context – ic-&gt;switchPinger<br>SwitchPinger的定义在SwitchPinger.h中。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">struct SwitchPinger</div><div class="line">&#123;</div><div class="line">    struct Iface controlHandlerIf;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>接下来分析SwitchPinger_newPing的内容。</p>
<h3 id="SwitchPinger-newPing-1"><a href="#SwitchPinger-newPing-1" class="headerlink" title="SwitchPinger_newPing"></a>SwitchPinger_newPing</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">struct SwitchPinger_Ping* SwitchPinger_newPing(uint64_t label,</div><div class="line">                                               String* data,</div><div class="line">                                               uint32_t timeoutMilliseconds,</div><div class="line">                                               SwitchPinger_ResponseCallback onResponse,</div><div class="line">                                               struct Allocator* alloc,</div><div class="line">                                               struct SwitchPinger* context)</div><div class="line">&#123;</div><div class="line">    struct SwitchPinger_pvt* ctx = Identity_check((struct SwitchPinger_pvt*)context);</div><div class="line">    if (data &amp;&amp; data-&gt;len &gt; Control_Ping_MAX_SIZE) &#123;</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (ctx-&gt;outstandingPings &gt; ctx-&gt;maxConcurrentPings) &#123;</div><div class="line">        Log_debug(ctx-&gt;logger, &quot;Skipping switch ping because there are already [%d] outstanding&quot;,</div><div class="line">                  ctx-&gt;outstandingPings);</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    struct Pinger_Ping* pp =</div><div class="line">        Pinger_newPing(data, onPingResponse, sendPing, timeoutMilliseconds, alloc, ctx-&gt;pinger);</div><div class="line"></div><div class="line">    struct Ping* ping = Allocator_clone(pp-&gt;pingAlloc, (&amp;(struct Ping) &#123;</div><div class="line">        .pub = &#123;</div><div class="line">            .pingAlloc = pp-&gt;pingAlloc</div><div class="line">        &#125;,</div><div class="line">        .label = label,</div><div class="line">        .data = String_clone(data, pp-&gt;pingAlloc),</div><div class="line">        .context = ctx,</div><div class="line">        .onResponse = onResponse,</div><div class="line">        .pingerPing = pp</div><div class="line">    &#125;));</div><div class="line">    Identity_set(ping);</div><div class="line">    Allocator_onFree(pp-&gt;pingAlloc, onPingFree, ping);</div><div class="line">    pp-&gt;context = ping;</div><div class="line">    ctx-&gt;outstandingPings++;</div><div class="line"></div><div class="line">    return &amp;ping-&gt;pub;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>先看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">struct Pinger_Ping* pp =</div><div class="line">        Pinger_newPing(data, onPingResponse, sendPing, timeoutMilliseconds, alloc, ctx-&gt;pinger);</div></pre></td></tr></table></figure></p>
<h4 id="Pinger-newPing"><a href="#Pinger-newPing" class="headerlink" title="Pinger_newPing"></a>Pinger_newPing</h4><p>util/Pinger.c<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">struct Pinger_Ping* Pinger_newPing(String* data,</div><div class="line">                                   Pinger_ON_RESPONSE(onResponse),</div><div class="line">                                   Pinger_SEND_PING(sendPing),</div><div class="line">                                   uint32_t timeoutMilliseconds,</div><div class="line">                                   struct Allocator* allocator,</div><div class="line">                                   struct Pinger* pinger)</div></pre></td></tr></table></figure></p>
<p>首先也分析一下参数</p>
<ol>
<li>String* data – data<br>ping时携带的数据</li>
<li>Pinger_ON_RESPONSE(onResponse) – onPingResponse<br>Pinger_SEND_PING(sendPing) – sendPing<br>这是两个函数，定义在Pinger.h<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#define Pinger_ON_RESPONSE(x) \</div><div class="line">    void (* x)(String* data, uint32_t milliseconds, void* context)</div><div class="line"></div><div class="line">#define Pinger_SEND_PING(x) void (* x)(String* data, void* context)</div></pre></td></tr></table></figure>
</li>
</ol>
<p>实现在SwitchPinger.c，暂时不分析具体实现代码。</p>
<ol>
<li>struct Pinger* pinger –  ctx-&gt;pinger</li>
</ol>
<p>接下来分析代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">struct Pinger_Ping* Pinger_newPing(String* data,</div><div class="line">                                   Pinger_ON_RESPONSE(onResponse),</div><div class="line">                                   Pinger_SEND_PING(sendPing),</div><div class="line">                                   uint32_t timeoutMilliseconds,</div><div class="line">                                   struct Allocator* allocator,</div><div class="line">                                   struct Pinger* pinger)</div><div class="line">&#123;</div><div class="line">    struct Allocator* alloc = Allocator_child(allocator);</div><div class="line"></div><div class="line">    struct Ping* ping = Allocator_clone(alloc, (&amp;(struct Ping) &#123;</div><div class="line">        .pub = &#123;</div><div class="line">            .pingAlloc = alloc,</div><div class="line">        &#125;,</div><div class="line">        .sendPing = sendPing,</div><div class="line">        .pinger = pinger,</div><div class="line">        .timeSent = Time_currentTimeMilliseconds(pinger-&gt;eventBase),</div><div class="line">        .onResponse = onResponse</div><div class="line">    &#125;));</div><div class="line">    Identity_set(ping);</div><div class="line"></div><div class="line">    int pingIndex = Map_OutstandingPings_put(&amp;ping, &amp;pinger-&gt;outstandingPings);</div><div class="line">    ping-&gt;pub.handle = pinger-&gt;outstandingPings.handles[pingIndex] + pinger-&gt;baseHandle;</div><div class="line"></div><div class="line">    ping-&gt;cookie = Random_uint64(pinger-&gt;rand);</div><div class="line"></div><div class="line">    // Prefix the data with the handle and cookie</div><div class="line">    String* toSend = String_newBinary(NULL, ((data) ? data-&gt;len : 0) + 12, alloc);</div><div class="line">    Bits_memcpy(toSend-&gt;bytes, &amp;ping-&gt;pub.handle, 4);</div><div class="line">    Bits_memcpy(&amp;toSend-&gt;bytes[4], &amp;ping-&gt;cookie, 8);</div><div class="line">    if (data) &#123;</div><div class="line">        Bits_memcpy(toSend-&gt;bytes + 12, data-&gt;bytes, data-&gt;len);</div><div class="line">    &#125;</div><div class="line">    ping-&gt;data = toSend;</div><div class="line"></div><div class="line">    Allocator_onFree(alloc, freePing, ping);</div><div class="line"></div><div class="line">    ping-&gt;timeout =</div><div class="line">        Timeout_setTimeout(timeoutCallback, ping, timeoutMilliseconds, pinger-&gt;eventBase, alloc);</div><div class="line"></div><div class="line">    Timeout_setTimeout(asyncSendPing, ping, 0, pinger-&gt;eventBase, alloc);</div><div class="line"></div><div class="line">    return &amp;ping-&gt;pub;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>主要完成的事情就是构造了一个Ping* ping，发送ping的函数是sendPing,接受response的函数是onResponse,这两个函数的实现都在SwitchPinger.c中。<br>发送ping的动作在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Timeout_setTimeout(asyncSendPing, ping, 0, pinger-&gt;eventBase, alloc);</div></pre></td></tr></table></figure></p>
<p>的asyncSendPing中，这是一个函数，</p>
<h3 id="asyncSendPing"><a href="#asyncSendPing" class="headerlink" title="asyncSendPing"></a>asyncSendPing</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">static void asyncSendPing(void* vping)</div><div class="line">&#123;</div><div class="line">    struct Ping* p = Identity_check((struct Ping*) vping);</div><div class="line">    //Log_debug(p-&gt;pinger-&gt;logger, &quot;Sending ping [%u]&quot;, p-&gt;pub.handle);</div><div class="line">    p-&gt;sendPing(p-&gt;data, p-&gt;pub.context);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到它是调用了p-&gt;sendPing(p-&gt;data, p-&gt;pub.context);方法，也就是SwitchPinger.c中的sendPing方法。</p>
<h4 id="Allocator-clone-pp-gt-pingAlloc-amp-struct-Ping-…"><a href="#Allocator-clone-pp-gt-pingAlloc-amp-struct-Ping-…" class="headerlink" title="Allocator_clone(pp-&gt;pingAlloc, (&amp;(struct Ping)….."></a>Allocator_clone(pp-&gt;pingAlloc, (&amp;(struct Ping)…..</h4><p>接下来回到SwitchPinger_newPing函数中，查看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">struct Ping* ping = Allocator_clone(pp-&gt;pingAlloc, (&amp;(struct Ping) &#123;</div><div class="line">        .pub = &#123;</div><div class="line">            .pingAlloc = pp-&gt;pingAlloc</div><div class="line">        &#125;,</div><div class="line">        .label = label,</div><div class="line">        .data = String_clone(data, pp-&gt;pingAlloc),</div><div class="line">        .context = ctx,</div><div class="line">        .onResponse = onResponse,</div><div class="line">        .pingerPing = pp</div><div class="line">    &#125;));</div></pre></td></tr></table></figure></p>
<p>这个函数主要构造了一个Ping<em> ping。它的pingering是上一步获得的Pinger_Ping</em> pp；它的onResponse是InterfaceController.c中的函数onPingResponse。</p>
<h3 id="SwitchPinger-c中的sendPing函数"><a href="#SwitchPinger-c中的sendPing函数" class="headerlink" title="SwitchPinger.c中的sendPing函数"></a>SwitchPinger.c中的sendPing函数</h3><p>上面提到sendPing会最终调用到SwitchPinger.c中的sendPing函数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">static void sendPing(String* data, void* sendPingContext)</div><div class="line">&#123;</div><div class="line">    struct Ping* p = Identity_check((struct Ping*) sendPingContext);</div><div class="line"></div><div class="line">    struct Message* msg = Message_new(0, data-&gt;len + 512, p-&gt;pub.pingAlloc);</div><div class="line"></div><div class="line">    while (((uintptr_t)msg-&gt;bytes - data-&gt;len) % 4) &#123;</div><div class="line">        Message_push8(msg, 0, NULL);</div><div class="line">    &#125;</div><div class="line">    msg-&gt;length = 0;</div><div class="line"></div><div class="line">    Message_push(msg, data-&gt;bytes, data-&gt;len, NULL);</div><div class="line">    Assert_true(!((uintptr_t)msg-&gt;bytes % 4) &amp;&amp; &quot;alignment fault&quot;);</div><div class="line"></div><div class="line">    if (p-&gt;pub.keyPing) &#123;</div><div class="line">        Message_shift(msg, Control_KeyPing_HEADER_SIZE, NULL);</div><div class="line">        struct Control_KeyPing* keyPingHeader = (struct Control_KeyPing*) msg-&gt;bytes;</div><div class="line">        keyPingHeader-&gt;magic = Control_KeyPing_MAGIC;</div><div class="line">        keyPingHeader-&gt;version_be = Endian_hostToBigEndian32(Version_CURRENT_PROTOCOL);</div><div class="line">        Bits_memcpy(keyPingHeader-&gt;key, p-&gt;context-&gt;myAddr-&gt;key, 32);</div><div class="line">    &#125; else &#123;</div><div class="line">        Message_shift(msg, Control_Ping_HEADER_SIZE, NULL);</div><div class="line">        struct Control_Ping* pingHeader = (struct Control_Ping*) msg-&gt;bytes;</div><div class="line">        pingHeader-&gt;magic = Control_Ping_MAGIC;</div><div class="line">        pingHeader-&gt;version_be = Endian_hostToBigEndian32(Version_CURRENT_PROTOCOL);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Message_shift(msg, Control_Header_SIZE, NULL);</div><div class="line">    struct Control* ctrl = (struct Control*) msg-&gt;bytes;</div><div class="line">    ctrl-&gt;header.checksum_be = 0;</div><div class="line">    ctrl-&gt;header.type_be = (p-&gt;pub.keyPing) ? Control_KEYPING_be : Control_PING_be;</div><div class="line">    ctrl-&gt;header.checksum_be = Checksum_engine(msg-&gt;bytes, msg-&gt;length);</div><div class="line"></div><div class="line">    struct RouteHeader rh;</div><div class="line">    Bits_memset(&amp;rh, 0, RouteHeader_SIZE);</div><div class="line">    rh.flags |= RouteHeader_flags_CTRLMSG;</div><div class="line">    rh.sh.label_be = Endian_hostToBigEndian64(p-&gt;label);</div><div class="line">    SwitchHeader_setVersion(&amp;rh.sh, SwitchHeader_CURRENT_VERSION);</div><div class="line"></div><div class="line">    Message_push(msg, &amp;rh, RouteHeader_SIZE, NULL);</div><div class="line"></div><div class="line">    Iface_send(&amp;p-&gt;context-&gt;pub.controlHandlerIf, msg);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>构造message，把ping需要的内容放入其中。最后调用Iface_send(&amp;p-&gt;context-&gt;pub.controlHandlerIf, msg);发送这个message。</p>
<h3 id="incomingFromSwitchPinger"><a href="#incomingFromSwitchPinger" class="headerlink" title="incomingFromSwitchPinger"></a>incomingFromSwitchPinger</h3><p>这个函数的实现，在ControlHandler.c中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">static Iface_DEFUN incomingFromSwitchPinger(struct Message* msg, struct Iface* switchPingerIf)</div><div class="line">&#123;</div><div class="line">    struct ControlHandler_pvt* ch =</div><div class="line">        Identity_containerOf(switchPingerIf, struct ControlHandler_pvt, pub.switchPingerIf);</div><div class="line">    return Iface_next(&amp;ch-&gt;pub.coreIf, msg);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="收到ping-发回pong"><a href="#收到ping-发回pong" class="headerlink" title="收到ping,发回pong"></a>收到ping,发回pong</h2><p>按照log来看，收到ping和pong的处理，都是在ControlHandler.c的中incomingFromCore当中。</p>
<h3 id="收到ping和pong"><a href="#收到ping和pong" class="headerlink" title="收到ping和pong"></a>收到ping和pong</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">static Iface_DEFUN incomingFromCore(struct Message* msg, struct Iface* coreIf)</div><div class="line">&#123;</div><div class="line">    struct ControlHandler_pvt* ch = Identity_check((struct ControlHandler_pvt*) coreIf);</div><div class="line"></div><div class="line">    struct RouteHeader routeHdr;</div><div class="line">    Message_pop(msg, &amp;routeHdr, RouteHeader_SIZE, NULL);</div><div class="line">    uint8_t labelStr[20];</div><div class="line">    uint64_t label = Endian_bigEndianToHost64(routeHdr.sh.label_be);</div><div class="line">    AddrTools_printPath(labelStr, label);</div><div class="line">    Log_debug(ch-&gt;log, &quot;ctrl packet from [%s]&quot;, labelStr);</div><div class="line"></div><div class="line">    if (msg-&gt;length &lt; 4 + Control_Header_SIZE) &#123;</div><div class="line">        Log_info(ch-&gt;log, &quot;DROP runt ctrl packet from [%s]&quot;, labelStr);</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Assert_true(routeHdr.flags &amp; RouteHeader_flags_CTRLMSG);</div><div class="line"></div><div class="line">    if (Checksum_engine(msg-&gt;bytes, msg-&gt;length)) &#123;</div><div class="line">        Log_info(ch-&gt;log, &quot;DROP ctrl packet from [%s] with invalid checksum&quot;, labelStr);</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    struct Control* ctrl = (struct Control*) msg-&gt;bytes;</div><div class="line"></div><div class="line">    if (ctrl-&gt;header.type_be == Control_ERROR_be) &#123;</div><div class="line">        return handleError(msg, ch, label, labelStr);</div><div class="line"></div><div class="line">    &#125; else if (ctrl-&gt;header.type_be == Control_KEYPING_be</div><div class="line">            || ctrl-&gt;header.type_be == Control_PING_be)</div><div class="line">    &#123;</div><div class="line">        return handlePing(msg, ch, label, labelStr, ctrl-&gt;header.type_be);</div><div class="line"></div><div class="line">    &#125; else if (ctrl-&gt;header.type_be == Control_KEYPONG_be</div><div class="line">            || ctrl-&gt;header.type_be == Control_PONG_be)</div><div class="line">    &#123;</div><div class="line">        Log_debug(ch-&gt;log, &quot;got switch pong from [%s]&quot;, labelStr);</div><div class="line">        Message_push(msg, &amp;routeHdr, RouteHeader_SIZE, NULL);</div><div class="line">        return Iface_next(&amp;ch-&gt;pub.switchPingerIf, msg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Log_info(ch-&gt;log, &quot;DROP control packet of unknown type from [%s], type [%d]&quot;,</div><div class="line">             labelStr, Endian_bigEndianToHost16(ctrl-&gt;header.type_be));</div><div class="line"></div><div class="line">    return NULL;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>处理ping消息调用到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">return handlePing(msg, ch, label, labelStr, ctrl-&gt;header.type_be);</div></pre></td></tr></table></figure></p>
<p>查看这个方法</p>
<h3 id="handlePing"><a href="#handlePing" class="headerlink" title="handlePing"></a>handlePing</h3> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"> static Iface_DEFUN handlePing(struct Message* msg,</div><div class="line">                              struct ControlHandler_pvt* ch,</div><div class="line">                              uint64_t label,</div><div class="line">                              uint8_t* labelStr,</div><div class="line">                              uint16_t messageType_be)</div><div class="line">&#123;</div><div class="line">    if (msg-&gt;length &lt; handlePing_MIN_SIZE) &#123;</div><div class="line">        Log_info(ch-&gt;log, &quot;DROP runt ping&quot;);</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    struct Control* ctrl = (struct Control*) msg-&gt;bytes;</div><div class="line">    Message_shift(msg, -Control_Header_SIZE, NULL);</div><div class="line"></div><div class="line">    // Ping and keyPing share version location</div><div class="line">    struct Control_Ping* ping = (struct Control_Ping*) msg-&gt;bytes;</div><div class="line">    uint32_t herVersion = Endian_bigEndianToHost32(ping-&gt;version_be);</div><div class="line">    if (!Version_isCompatible(Version_CURRENT_PROTOCOL, herVersion)) &#123;</div><div class="line">        Log_debug(ch-&gt;log, &quot;DROP ping from incompatible version [%d]&quot;, herVersion);</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (messageType_be == Control_KEYPING_be) &#123;</div><div class="line">        Log_debug(ch-&gt;log, &quot;got switch keyPing from [%s]&quot;, labelStr);</div><div class="line">        if (msg-&gt;length &lt; Control_KeyPing_HEADER_SIZE) &#123;</div><div class="line">            // min keyPing size is longer</div><div class="line">            Log_debug(ch-&gt;log, &quot;DROP runt keyPing&quot;);</div><div class="line">            return NULL;</div><div class="line">        &#125;</div><div class="line">        if (msg-&gt;length &gt; Control_KeyPing_MAX_SIZE) &#123;</div><div class="line">            Log_debug(ch-&gt;log, &quot;DROP long keyPing&quot;);</div><div class="line">            return NULL;</div><div class="line">        &#125;</div><div class="line">        if (ping-&gt;magic != Control_KeyPing_MAGIC) &#123;</div><div class="line">            Log_debug(ch-&gt;log, &quot;DROP keyPing (bad magic)&quot;);</div><div class="line">            return NULL;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        struct Control_KeyPing* keyPing = (struct Control_KeyPing*) msg-&gt;bytes;</div><div class="line">        keyPing-&gt;magic = Control_KeyPong_MAGIC;</div><div class="line">        ctrl-&gt;header.type_be = Control_KEYPONG_be;</div><div class="line">        Bits_memcpy(keyPing-&gt;key, ch-&gt;myPublicKey, 32);</div><div class="line"></div><div class="line">    &#125; else if (messageType_be == Control_PING_be) &#123;</div><div class="line">        Log_debug(ch-&gt;log, &quot;got switch ping from [%s]&quot;, labelStr);</div><div class="line">        if (ping-&gt;magic != Control_Ping_MAGIC) &#123;</div><div class="line">            Log_debug(ch-&gt;log, &quot;DROP ping (bad magic)&quot;);</div><div class="line">            return NULL;</div><div class="line">        &#125;</div><div class="line">        ping-&gt;magic = Control_Pong_MAGIC;</div><div class="line">        ctrl-&gt;header.type_be = Control_PONG_be;</div><div class="line"></div><div class="line">    &#125; else &#123;</div><div class="line">        Assert_failure(&quot;2+2=5&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ping-&gt;version_be = Endian_hostToBigEndian32(Version_CURRENT_PROTOCOL);</div><div class="line"></div><div class="line">    Message_shift(msg, Control_Header_SIZE, NULL);</div><div class="line"></div><div class="line">    ctrl-&gt;header.checksum_be = 0;</div><div class="line">    ctrl-&gt;header.checksum_be = Checksum_engine(msg-&gt;bytes, msg-&gt;length);</div><div class="line"></div><div class="line">    Message_shift(msg, RouteHeader_SIZE, NULL);</div><div class="line"></div><div class="line">    struct RouteHeader* routeHeader = (struct RouteHeader*) msg-&gt;bytes;</div><div class="line">    Bits_memset(routeHeader, 0, RouteHeader_SIZE);</div><div class="line">    SwitchHeader_setVersion(&amp;routeHeader-&gt;sh, SwitchHeader_CURRENT_VERSION);</div><div class="line">    routeHeader-&gt;sh.label_be = Endian_hostToBigEndian64(label);</div><div class="line">    routeHeader-&gt;flags |= RouteHeader_flags_CTRLMSG;</div><div class="line"></div><div class="line">    return Iface_next(&amp;ch-&gt;pub.coreIf, msg);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先看这一段<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">else if (messageType_be == Control_PING_be) &#123;</div><div class="line">        Log_debug(ch-&gt;log, &quot;got switch ping from [%s]&quot;, labelStr);</div><div class="line">        if (ping-&gt;magic != Control_Ping_MAGIC) &#123;</div><div class="line">            Log_debug(ch-&gt;log, &quot;DROP ping (bad magic)&quot;);</div><div class="line">            return NULL;</div><div class="line">        &#125;</div><div class="line">        ping-&gt;magic = Control_Pong_MAGIC;</div><div class="line">        ctrl-&gt;header.type_be = Control_PONG_be;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，在收到ping之后，将ctrl的header.type_be设置为Control_PONG_be，也就是说，接下来，我们会发回一个pong<br>最后的return Iface_next(&amp;ch-&gt;pub.coreIf, msg);是调用到了SwitchPinger.c中的messageFromControlHandler</p>
<h3 id="messageFromControlHandler"><a href="#messageFromControlHandler" class="headerlink" title="messageFromControlHandler"></a>messageFromControlHandler</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line">static Iface_DEFUN messageFromControlHandler(struct Message* msg, struct Iface* iface)</div><div class="line">&#123;</div><div class="line">    struct SwitchPinger_pvt* ctx = Identity_check((struct SwitchPinger_pvt*) iface);</div><div class="line">    struct RouteHeader rh;</div><div class="line">    Message_pop(msg, &amp;rh, RouteHeader_SIZE, NULL);</div><div class="line">    ctx-&gt;incomingLabel = Endian_bigEndianToHost64(rh.sh.label_be);</div><div class="line">    ctx-&gt;incomingVersion = 0;</div><div class="line"></div><div class="line">    struct Control* ctrl = (struct Control*) msg-&gt;bytes;</div><div class="line">    if (ctrl-&gt;header.type_be == Control_PONG_be) &#123;</div><div class="line">        Message_shift(msg, -Control_Header_SIZE, NULL);</div><div class="line">        ctx-&gt;error = Error_NONE;</div><div class="line">        if (msg-&gt;length &gt;= Control_Pong_MIN_SIZE) &#123;</div><div class="line">            struct Control_Ping* pongHeader = (struct Control_Ping*) msg-&gt;bytes;</div><div class="line">            ctx-&gt;incomingVersion = Endian_bigEndianToHost32(pongHeader-&gt;version_be);</div><div class="line">            if (pongHeader-&gt;magic != Control_Pong_MAGIC) &#123;</div><div class="line">                Log_debug(ctx-&gt;logger, &quot;dropped invalid switch pong&quot;);</div><div class="line">                return NULL;</div><div class="line">            &#125;</div><div class="line">            Message_shift(msg, -Control_Pong_HEADER_SIZE, NULL);</div><div class="line">        &#125; else &#123;</div><div class="line">            Log_debug(ctx-&gt;logger, &quot;got runt pong message, length: [%d]&quot;, msg-&gt;length);</div><div class="line">            return NULL;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125; else if (ctrl-&gt;header.type_be == Control_KEYPONG_be) &#123;</div><div class="line">        Message_shift(msg, -Control_Header_SIZE, NULL);</div><div class="line">        ctx-&gt;error = Error_NONE;</div><div class="line">        if (msg-&gt;length &gt;= Control_KeyPong_HEADER_SIZE &amp;&amp; msg-&gt;length &lt;= Control_KeyPong_MAX_SIZE) &#123;</div><div class="line">            struct Control_KeyPing* pongHeader = (struct Control_KeyPing*) msg-&gt;bytes;</div><div class="line">            ctx-&gt;incomingVersion = Endian_bigEndianToHost32(pongHeader-&gt;version_be);</div><div class="line">            if (pongHeader-&gt;magic != Control_KeyPong_MAGIC) &#123;</div><div class="line">                Log_debug(ctx-&gt;logger, &quot;dropped invalid switch key-pong&quot;);</div><div class="line">                return NULL;</div><div class="line">            &#125;</div><div class="line">            Bits_memcpy(ctx-&gt;incomingKey, pongHeader-&gt;key, 32);</div><div class="line">            Message_shift(msg, -Control_KeyPong_HEADER_SIZE, NULL);</div><div class="line">        &#125; else if (msg-&gt;length &gt; Control_KeyPong_MAX_SIZE) &#123;</div><div class="line">            Log_debug(ctx-&gt;logger, &quot;got overlong key-pong message, length: [%d]&quot;, msg-&gt;length);</div><div class="line">            return NULL;</div><div class="line">        &#125; else &#123;</div><div class="line">            Log_debug(ctx-&gt;logger, &quot;got runt key-pong message, length: [%d]&quot;, msg-&gt;length);</div><div class="line">            return NULL;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125; else if (ctrl-&gt;header.type_be == Control_ERROR_be) &#123;</div><div class="line">        Message_shift(msg, -Control_Header_SIZE, NULL);</div><div class="line">        Assert_true((uint8_t*)&amp;ctrl-&gt;content.error.errorType_be == msg-&gt;bytes);</div><div class="line">        if (msg-&gt;length &lt; (Control_Error_HEADER_SIZE + SwitchHeader_SIZE + Control_Header_SIZE)) &#123;</div><div class="line">            Log_debug(ctx-&gt;logger, &quot;runt error packet&quot;);</div><div class="line">            return NULL;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ctx-&gt;error = Message_pop32(msg, NULL);</div><div class="line">        Message_push32(msg, 0, NULL);</div><div class="line"></div><div class="line">        Message_shift(msg, -(Control_Error_HEADER_SIZE + SwitchHeader_SIZE), NULL);</div><div class="line"></div><div class="line">        struct Control* origCtrl = (struct Control*) msg-&gt;bytes;</div><div class="line"></div><div class="line">        Log_debug(ctx-&gt;logger, &quot;error [%s] was caused by our [%s]&quot;,</div><div class="line">                  Error_strerror(ctx-&gt;error),</div><div class="line">                  Control_typeString(origCtrl-&gt;header.type_be));</div><div class="line"></div><div class="line">        int shift;</div><div class="line">        if (origCtrl-&gt;header.type_be == Control_PING_be) &#123;</div><div class="line">            shift = -(Control_Header_SIZE + Control_Ping_HEADER_SIZE);</div><div class="line">        &#125; else if (origCtrl-&gt;header.type_be == Control_KEYPING_be) &#123;</div><div class="line">            shift = -(Control_Header_SIZE + Control_KeyPing_HEADER_SIZE);</div><div class="line">        &#125; else &#123;</div><div class="line">            Assert_failure(&quot;problem in Ducttape.c&quot;);</div><div class="line">        &#125;</div><div class="line">        if (msg-&gt;length &lt; -shift) &#123;</div><div class="line">            Log_debug(ctx-&gt;logger, &quot;runt error packet&quot;);</div><div class="line">        &#125;</div><div class="line">        Message_shift(msg, shift, NULL);</div><div class="line"></div><div class="line">    &#125; else &#123;</div><div class="line">        // If it gets here then Ducttape.c is failing.</div><div class="line">        Assert_true(false);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    String* msgStr = &amp;(String) &#123; .bytes = (char*) msg-&gt;bytes, .len = msg-&gt;length &#125;;</div><div class="line">    Pinger_pongReceived(msgStr, ctx-&gt;pinger);</div><div class="line">    Bits_memset(ctx-&gt;incomingKey, 0, 32);</div><div class="line">    return NULL;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>查看这一段<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">if (ctrl-&gt;header.type_be == Control_PONG_be) &#123;</div><div class="line">        Message_shift(msg, -Control_Header_SIZE, NULL);</div><div class="line">        ctx-&gt;error = Error_NONE;</div><div class="line">        if (msg-&gt;length &gt;= Control_Pong_MIN_SIZE) &#123;</div><div class="line">            struct Control_Ping* pongHeader = (struct Control_Ping*) msg-&gt;bytes;</div><div class="line">            ctx-&gt;incomingVersion = Endian_bigEndianToHost32(pongHeader-&gt;version_be);</div><div class="line">            if (pongHeader-&gt;magic != Control_Pong_MAGIC) &#123;</div><div class="line">                Log_debug(ctx-&gt;logger, &quot;dropped invalid switch pong&quot;);</div><div class="line">                return NULL;</div><div class="line">            &#125;</div><div class="line">            Message_shift(msg, -Control_Pong_HEADER_SIZE, NULL);</div><div class="line">        &#125; else &#123;</div><div class="line">            Log_debug(ctx-&gt;logger, &quot;got runt pong message, length: [%d]&quot;, msg-&gt;length);</div><div class="line">            return NULL;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这一段主要是针对要发pong包之前的处理<br>然后，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String* msgStr = &amp;(String) &#123; .bytes = (char*) msg-&gt;bytes, .len = msg-&gt;length &#125;;</div><div class="line">    Pinger_pongReceived(msgStr, ctx-&gt;pinger);</div></pre></td></tr></table></figure></p>
<p>首先放入了msgStr，然后调用Pinger_pongReceived(msgStr, ctx-&gt;pinger);把pong发出去。</p>
<h3 id="Pinger-pongReceived"><a href="#Pinger-pongReceived" class="headerlink" title="Pinger_pongReceived"></a>Pinger_pongReceived</h3><p>在util/Pinger.c文件中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">void Pinger_pongReceived(String* data, struct Pinger* pinger)</div><div class="line">&#123;</div><div class="line">    if (data-&gt;len &lt; 12) &#123;</div><div class="line">        Log_debug(pinger-&gt;logger, &quot;Invalid ping response, too short&quot;);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    uint32_t handle;</div><div class="line">    Bits_memcpy(&amp;handle, data-&gt;bytes, 4);</div><div class="line">    int index = Map_OutstandingPings_indexForHandle(handle - pinger-&gt;baseHandle,</div><div class="line">                                                    &amp;pinger-&gt;outstandingPings);</div><div class="line">    if (index &lt; 0) &#123;</div><div class="line">        Log_debug(pinger-&gt;logger, &quot;Invalid ping response handle [%u].&quot;, handle);</div><div class="line">    &#125; else &#123;</div><div class="line">        data-&gt;len -= 4;</div><div class="line">        data-&gt;bytes += 4;</div><div class="line">        uint64_t cookie;</div><div class="line">        Bits_memcpy(&amp;cookie, data-&gt;bytes, 8);</div><div class="line">        struct Ping* p = Identity_check((struct Ping*) pinger-&gt;outstandingPings.values[index]);</div><div class="line">        if (cookie != p-&gt;cookie) &#123;</div><div class="line">            Log_debug(pinger-&gt;logger, &quot;Ping response with invalid cookie&quot;);</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        data-&gt;len -= 8;</div><div class="line">        data-&gt;bytes += 8;</div><div class="line">        callback(data, p);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>就看最后一句，<br>callback(data, p);<br>两个参数</p>
<ol>
<li>data 发来的ping中携带的数据</li>
<li>p，这个p是一个Ping类型的对象，它来自于发送ping的那个peer，携带着那个peer的相关信息。</li>
</ol>
<h3 id="callback-data-p"><a href="#callback-data-p" class="headerlink" title="callback(data,p)"></a>callback(data,p)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">static void callback(String* data, struct Ping* ping)</div><div class="line">&#123;</div><div class="line">    uint32_t now = Time_currentTimeMilliseconds(ping-&gt;pinger-&gt;eventBase);</div><div class="line">    ping-&gt;onResponse(data, now - ping-&gt;timeSent, ping-&gt;pub.context);</div><div class="line"></div><div class="line">    // Flag the freePing function to tell it that the ping was not terminated by the user...</div><div class="line">    ping-&gt;timeSent = 0;</div><div class="line"></div><div class="line">    Allocator_free(ping-&gt;pub.pingAlloc);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最重要的一句<br>ping-&gt;onResponse(data, now - ping-&gt;timeSent, ping-&gt;pub.context);<br>这是调用了发送方提供给我们的onResponse函数。<br>查看Ping的结构体定义<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">struct Ping</div><div class="line">&#123;</div><div class="line">    struct Pinger_Ping pub;</div><div class="line">    struct Pinger* pinger;</div><div class="line">    struct Timeout* timeout;</div><div class="line">    String* data;</div><div class="line">    int64_t timeSent;</div><div class="line">    uint64_t cookie;</div><div class="line">    Pinger_SEND_PING(sendPing);</div><div class="line">    Pinger_ON_RESPONSE(onResponse);</div><div class="line">    Identity</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>onResponse是一个Pinger_ON_RESPONSE(onResponse);再查看他的定义<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#define Pinger_ON_RESPONSE(x) \</div><div class="line">    void (* x)(String* data, uint32_t milliseconds, void* context)</div></pre></td></tr></table></figure></p>
<p>上面已经提到过，这是SwitchPinger.c中实现的。同时，这也是发送方收到pong之后，做消息缺人的过程。在这个过程中，会核对一些信息，包括发出的ping中携带的data和收到的pong中携带的data是否相同。</p>
<h3 id="onPingResponse"><a href="#onPingResponse" class="headerlink" title="onPingResponse"></a>onPingResponse</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">static void onPingResponse(String* data, uint32_t milliseconds, void* vping)</div><div class="line">&#123;</div><div class="line">    struct Ping* p = Identity_check((struct Ping*) vping);</div><div class="line">    enum SwitchPinger_Result err = SwitchPinger_Result_OK;</div><div class="line">    uint64_t label = p-&gt;context-&gt;incomingLabel;</div><div class="line">    if (data) &#123;</div><div class="line">        if (label != p-&gt;label) &#123;</div><div class="line">            err = SwitchPinger_Result_LABEL_MISMATCH;</div><div class="line">        &#125; else if ((p-&gt;data || data-&gt;len &gt; 0) &amp;&amp; !String_equals(data, p-&gt;data)) &#123;</div><div class="line">            err = SwitchPinger_Result_WRONG_DATA;</div><div class="line">        &#125; else if (p-&gt;context-&gt;error == Error_LOOP_ROUTE) &#123;</div><div class="line">            err = SwitchPinger_Result_LOOP_ROUTE;</div><div class="line">        &#125; else if (p-&gt;context-&gt;error) &#123;</div><div class="line">            err = SwitchPinger_Result_ERROR_RESPONSE;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        err = SwitchPinger_Result_TIMEOUT;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    uint32_t version = p-&gt;context-&gt;incomingVersion;</div><div class="line">    struct SwitchPinger_Response* resp =</div><div class="line">        Allocator_calloc(p-&gt;pub.pingAlloc, sizeof(struct SwitchPinger_Response), 1);</div><div class="line">    resp-&gt;version = p-&gt;context-&gt;incomingVersion;</div><div class="line">    resp-&gt;res = err;</div><div class="line">    resp-&gt;label = label;</div><div class="line">    resp-&gt;data = data;</div><div class="line">    resp-&gt;milliseconds = milliseconds;</div><div class="line">    resp-&gt;version = version;</div><div class="line">    Bits_memcpy(resp-&gt;key, p-&gt;context-&gt;incomingKey, 32);</div><div class="line">    resp-&gt;ping = &amp;p-&gt;pub;</div><div class="line">    p-&gt;onResponse(resp, p-&gt;pub.onResponseContext);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>函数的最后，调用了p-&gt;onResponse(resp, p-&gt;pub.onResponseContext);<br>p是一个Ping* 类型的对象，查看Ping的定义<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">struct Ping</div><div class="line">&#123;</div><div class="line">    struct SwitchPinger_Ping pub;</div><div class="line">    uint64_t label;</div><div class="line">    String* data;</div><div class="line">    struct SwitchPinger_pvt* context;</div><div class="line">    SwitchPinger_ResponseCallback onResponse;</div><div class="line">    void* onResponseContext;</div><div class="line">    struct Pinger_Ping* pingerPing;</div><div class="line">    Identity</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>可见SwitchPinger_ResponseCallback onResponse;，查看SwitchPinger_ResponseCallback的定义<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">typedef void (* SwitchPinger_ResponseCallback)(struct SwitchPinger_Response* resp, void* userData);</div></pre></td></tr></table></figure></p>
<p>这个函数的实现在InterfaceController.c中</p>
<h3 id="onPingResponse-1"><a href="#onPingResponse-1" class="headerlink" title="onPingResponse"></a>onPingResponse</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">static void onPingResponse(struct SwitchPinger_Response* resp, void* onResponseContext)</div><div class="line">&#123;</div><div class="line">    if (SwitchPinger_Result_OK != resp-&gt;res) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    struct Peer* ep = Identity_check((struct Peer*) onResponseContext);</div><div class="line">    struct InterfaceController_pvt* ic = Identity_check(ep-&gt;ici-&gt;ic);</div><div class="line"></div><div class="line">    ep-&gt;addr.protocolVersion = resp-&gt;version;</div><div class="line"></div><div class="line">    if (Defined(Log_DEBUG)) &#123;</div><div class="line">        String* addr = Address_toString(&amp;ep-&gt;addr, resp-&gt;ping-&gt;pingAlloc);</div><div class="line">        if (!Version_isCompatible(Version_CURRENT_PROTOCOL, resp-&gt;version)) &#123;</div><div class="line">            Log_debug(ic-&gt;logger, &quot;got switch pong from node [%s] with incompatible version&quot;,</div><div class="line">                                  addr-&gt;bytes);</div><div class="line">        &#125; else if (ep-&gt;addr.path != resp-&gt;label) &#123;</div><div class="line">            uint8_t sl[20];</div><div class="line">            AddrTools_printPath(sl, resp-&gt;label);</div><div class="line">            Log_debug(ic-&gt;logger, &quot;got switch pong from node [%s] mismatch label [%s]&quot;,</div><div class="line">                                  addr-&gt;bytes, sl);</div><div class="line">        &#125; else &#123;</div><div class="line">            Log_debug(ic-&gt;logger, &quot;got switch pong from node [%s]&quot;, addr-&gt;bytes);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (!Version_isCompatible(Version_CURRENT_PROTOCOL, resp-&gt;version)) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (ep-&gt;state == InterfaceController_PeerState_ESTABLISHED) &#123;</div><div class="line">        sendPeer(0xffffffff, PFChan_Core_PEER, ep);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ep-&gt;timeOfLastPing = Time_currentTimeMilliseconds(ic-&gt;eventBase);</div><div class="line"></div><div class="line">    if (Defined(Log_DEBUG)) &#123;</div><div class="line">        String* addr = Address_toString(&amp;ep-&gt;addr, resp-&gt;ping-&gt;pingAlloc);</div><div class="line">        Log_debug(ic-&gt;logger, &quot;Received [%s] from lazy endpoint [%s]&quot;,</div><div class="line">                  SwitchPinger_resultString(resp-&gt;res)-&gt;bytes, addr-&gt;bytes);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此，一个switch ping操作从InterfaceController.c出发，到对方处响应发回pong，回到发送方的InterfaceController.c中进行处理。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/12/ping-pong/" data-id="cje6pjw31006sweyxbrtgdaus" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C-C/">C/C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cjdns/">cjdns</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cjdns源码分析/">cjdns源码分析</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-contentprovider" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/04/contentprovider/" class="article-date">
  <time datetime="2017-01-04T03:34:00.000Z" itemprop="datePublished">2017-01-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/04/contentprovider/">Android中的ContentProvider,ContentResolver,ContentObserver</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ContentProvider简介"><a href="#ContentProvider简介" class="headerlink" title="ContentProvider简介"></a>ContentProvider简介</h2><p>ContentProvider是Android四大组件之一。主要实现应用程序之间共享数据的功能，为存储和获取数据提供统一的接口。</p>
<p>Android系统本身提供了一些默认的ContentProvider，包括音频，视频，图片，通讯录等。</p>
<p>ContentProvider提供一些方法，对数据进行操作：<br>　　 query：查询<br>　　 insert：插入<br>　　 update：更新<br>　　 delete：删除<br>　　 getType：得到数据类型<br>　　 onCreate：创建数据时调用的回调函数<br>　　<br>每个ContentProvider拥有一个公开的URI，其他应用使用这个URI来进行数据获取和操作。</p>
<h2 id="URI类简介"><a href="#URI类简介" class="headerlink" title="URI类简介"></a>URI类简介</h2><p>通用资源标志符（Universal Resource Identifier, 简称”URI”）。</p>
<p>Uri代表要操作的数据，Android上可用的每种资源 - 图像、视频片段等都可以用Uri来表示。</p>
<h3 id="Android中的URI"><a href="#Android中的URI" class="headerlink" title="Android中的URI"></a>Android中的URI</h3><p>Android的Uri由以下三部分组成：</p>
<p> content://com.cj.mycontentprovider/contact</p>
<p>一：scheme<br>ContentProvider（内容提供者）的scheme已经由Android所规定，<br> scheme为：content://</p>
<p>二：主机名<br>主机名（或叫Authority）用于唯一标识这个ContentProvider，比如这里com.cj.mycontentprovider，外部调用者可以根据这个标识来找到它。</p>
<p>三：path<br>路径（path）可以用来表示我们要操作的数据，路径的构建应根据业务而定，如上面程序:</p>
<p>Android中的URI： </p>
<pre><code>所有联系人的Uri： content://contacts/people
某个联系人的Uri: content://contacts/people/5
所有图片Uri: content://media/external
某个图片的Uri：content://media/external/images/media/4
</code></pre><p>我们很经常需要解析Uri，并从Uri中获取数据。</p>
<p>Android系统提供了两个用于操作Uri的工具类，分别为UriMatcher 和ContentUris 。</p>
<h3 id="UriMatcher"><a href="#UriMatcher" class="headerlink" title="UriMatcher"></a>UriMatcher</h3><p>UriMatcher 类主要用于匹配Uri.</p>
<p>使用方法如下。</p>
<p>首先第一步，初始化：<br>UriMatcher matcher = new UriMatcher(UriMatcher.NO_MATCH);  </p>
<p>第二步注册需要的Uri:<br>matcher.addURI(“com.yfz.Lesson”, “people”, PEOPLE);<br>matcher.addURI(“com.yfz.Lesson”, “person/#”, PEOPLE_ID);  </p>
<p>第三部，与已经注册的Uri进行匹配:<br>Uri uri = Uri.parse(“content://“ + “com.yfz.Lesson” + “/people”);<br>int match = matcher.match(uri);<br>       switch (match)<br>       {<br>           case PEOPLE:<br>               return “vnd.Android.cursor.dir/people”;<br>           case PEOPLE_ID:<br>               return “vnd.android.cursor.item/people”;<br>           default:<br>               return null;<br>       }  </p>
<p>match方法匹配后会返回一个匹配码Code，即在使用注册方法addURI时传入的第三个参数。 </p>
<p>上述方法会返回”vnd.Android.cursor.dir/person”. </p>
<p>总结: </p>
<p>–常量 UriMatcher.NO_MATCH 表示不匹配任何路径的返回码</p>
<p>–# 号为通配符</p>
<p>–* 号为任意字符 </p>
<h3 id="ContentUris"><a href="#ContentUris" class="headerlink" title="ContentUris"></a>ContentUris</h3><p>ContentUris 类用于获取Uri路径后面的ID部分</p>
<p>1)为路径加上ID: withAppendedId(uri, id)</p>
<p>比如有这样一个Uri<br>Uri uri = Uri.parse(“content://com.yfz.Lesson/people”)  </p>
<p>通过withAppendedId方法，为该Uri加上ID<br>Uri resultUri = ContentUris.withAppendedId(uri, 10);<br>最后resultUri为: content://com.yfz.Lesson/people/10</p>
<p>2)从路径中获取ID: parseId(uri)</p>
<p>Uri uri = Uri.parse(“content://com.yfz.Lesson/people/10”)<br>long personid = ContentUris.parseId(uri);<br>最后personid 为 :10 </p>
<h2 id="一个使用ContentProvider的例子"><a href="#一个使用ContentProvider的例子" class="headerlink" title="一个使用ContentProvider的例子"></a>一个使用ContentProvider的例子</h2><h3 id="写提供数据的应用"><a href="#写提供数据的应用" class="headerlink" title="写提供数据的应用"></a>写提供数据的应用</h3><p>首先是MyContentProvider类，它继承自ContentProvider类，提供上面提到的六个基本方法：</p>
<p>　　 query：查询<br>　　 insert：插入<br>　　 update：更新<br>　　 delete：删除<br>　　 getType：得到数据类型<br>　　 onCreate：创建数据时调用的回调函数</p>
<p>数据的处理实际是使用SELite来实现的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line">package com.cj.providerdemo2;  </div><div class="line">  </div><div class="line">import android.content.ContentProvider;  </div><div class="line">import android.content.ContentResolver;  </div><div class="line">import android.content.ContentUris;  </div><div class="line">import android.content.ContentValues;  </div><div class="line">import android.content.Context;  </div><div class="line">import android.content.UriMatcher;  </div><div class="line">import android.database.Cursor;  </div><div class="line">import android.database.sqlite.SQLiteDatabase;  </div><div class="line">import android.database.sqlite.SQLiteOpenHelper;  </div><div class="line">import android.net.Uri;  </div><div class="line">  </div><div class="line">public class MyContentProvider extends ContentProvider &#123;  </div><div class="line">    private final static int CONTACT = 1;  </div><div class="line">  </div><div class="line">    private static UriMatcher uriMatcher = new UriMatcher(UriMatcher.NO_MATCH);  </div><div class="line">    static &#123;  </div><div class="line">        uriMatcher.addURI(&quot;com.cj.mycontentprovider&quot;,&quot;contact&quot;,CONTACT);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    private MyDBHelp dbHelp;  </div><div class="line">  </div><div class="line">    @Override  </div><div class="line">    public int delete(Uri uri, String selection, String[] selectionArgs) &#123;  </div><div class="line">        int id =0;  </div><div class="line">        if(uriMatcher.match(uri) == CONTACT)&#123;  </div><div class="line">            SQLiteDatabase database = dbHelp.getWritableDatabase();  </div><div class="line">            id= database.delete(&quot;contact&quot;, selection, selectionArgs);  </div><div class="line">            contentResolver.notifyChange(uri,null);  </div><div class="line">        &#125;  </div><div class="line">       return id;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    @Override  </div><div class="line">    public String getType(Uri uri) &#123;  </div><div class="line">        // TODO: Implement this to handle requests for the MIME type of the data  </div><div class="line">        // at the given URI.  </div><div class="line">        throw new UnsupportedOperationException(&quot;Not yet implemented&quot;);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    @Override  </div><div class="line">    public Uri insert(Uri uri, ContentValues values) &#123;  </div><div class="line">        Uri u = null;  </div><div class="line">        if(uriMatcher.match(uri) == CONTACT)&#123;  </div><div class="line">            SQLiteDatabase database = dbHelp.getWritableDatabase();  </div><div class="line">  </div><div class="line">            long d = database.insert(&quot;contact&quot;, &quot;_id&quot;, values);  </div><div class="line">            u = ContentUris.withAppendedId(uri,d);  </div><div class="line">            contentResolver.notifyChange(u,null);  </div><div class="line">        &#125;  </div><div class="line">        return u;  </div><div class="line">  </div><div class="line">    &#125;  </div><div class="line">    private ContentResolver contentResolver;  </div><div class="line">    @Override  </div><div class="line">    public boolean onCreate() &#123;  </div><div class="line">        Context context = getContext();  </div><div class="line">        contentResolver = context.getContentResolver();  </div><div class="line">        dbHelp = new MyDBHelp(context,&quot;contact.db&quot;,null,1);  </div><div class="line">        return true;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    @Override  </div><div class="line">    public Cursor query(Uri uri, String[] projection, String selection,  </div><div class="line">                        String[] selectionArgs, String sortOrder) &#123;  </div><div class="line">        Cursor cursor = null;  </div><div class="line">        if(uriMatcher.match(uri) == CONTACT)&#123;  </div><div class="line">            SQLiteDatabase database = dbHelp.getReadableDatabase();  </div><div class="line">            cursor = database.query(&quot;contact&quot;, projection, selection, selectionArgs, null, null, sortOrder);  </div><div class="line">            cursor.setNotificationUri(contentResolver,uri);  </div><div class="line">        &#125;  </div><div class="line">        return cursor;  </div><div class="line">  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    @Override  </div><div class="line">    public int update(Uri uri, ContentValues values, String selection,  </div><div class="line">                      String[] selectionArgs) &#123;  </div><div class="line">        // TODO: Implement this to handle requests to update one or more rows.  </div><div class="line">        throw new UnsupportedOperationException(&quot;Not yet implemented&quot;);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    /** </div><div class="line">     * </div><div class="line">     */  </div><div class="line">    private static  class MyDBHelp extends SQLiteOpenHelper&#123;  </div><div class="line">  </div><div class="line">        public MyDBHelp(Context context, String name, SQLiteDatabase.CursorFactory factory, int version) &#123;  </div><div class="line">            super(context, name, factory, version);  </div><div class="line">  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        @Override  </div><div class="line">        public void onCreate(SQLiteDatabase db) &#123;  </div><div class="line">            String sql = &quot;create table contact(_id integer primary key autoincrement,&quot; +  </div><div class="line">                    &quot;name text not null,number text not null);&quot;;  </div><div class="line">            db.execSQL(sql);  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        @Override  </div><div class="line">        public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) &#123;  </div><div class="line">            onCreate(db);  </div><div class="line">  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到这个类实现了ContentProvider要求的基本方法。</p>
<p>在onCreate方法中，使用了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">contentResolver = context.getContentResolver();</div></pre></td></tr></table></figure></p>
<p>query方法中，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cursor.setNotificationUri(contentResolver,uri);</div></pre></td></tr></table></figure></p>
<p>在insert和delete方法中，调用了contentResolver.notifyChange(uri,null);  事实上，ContentResoler是联系ContentProvider和使用它的应用之间的纽带。使用它的应用程序，是通过ContentResoler来调用ContentProvider中的方法的。具体调用方式，后面再说。</p>
<h3 id="声明这个ContentProvider"><a href="#声明这个ContentProvider" class="headerlink" title="声明这个ContentProvider"></a>声明这个ContentProvider</h3><p>写好自己的ContentProvider类之后，需要在Manifest.xml文件中声明这个ContentProvider<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;provider</div><div class="line">	android:name=&quot;.MyContentProvider&quot;</div><div class="line">	android:authorities=&quot;com.cj.mycontentprovider&quot;</div><div class="line">	android:enabled=&quot;true&quot;</div><div class="line">	android:exported=&quot;true&quot;&gt;</div><div class="line">&lt;/provider&gt;</div></pre></td></tr></table></figure></p>
<p>我们知道，其他应用如果想要访问这个应用程序，使用MyContentProvider提供的那些方法，来获取和操作数据，需要知道对应的uri。</p>
<p>uri的三个组成部分中，scheme已经被Android固定设置为content://，而这里ContentProvider有一个属性authorities,就是uri的第二部分：主机名,为了保证唯一性,一般使用包名的方式命名。</p>
<p>剩下uri的第三部分path，上面关于UriMatcher类的使用方法中说过，使用分为三步，结合MyContentProvider类的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">private static UriMatcher uriMatcher = new UriMatcher(UriMatcher.NO_MATCH);  </div><div class="line">static &#123;  </div><div class="line">    uriMatcher.addURI(&quot;com.cj.mycontentprovider&quot;,&quot;contact&quot;,CONTACT);  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  首先初始化：  <code>private static UriMatcher uriMatcher = new UriMatcher(UriMatcher.NO_MATCH);</code><br>  然后注册uri：<code>uriMatcher.addURI(&quot;com.cj.mycontentprovider&quot;,&quot;contact&quot;,CONTACT);</code><br>  最后在 增删改查的方法中进行uri匹配<code>if(uriMatcher.match(uri) == CONTACT)</code></p>
<h3 id="写使用数据的应用"><a href="#写使用数据的应用" class="headerlink" title="写使用数据的应用"></a>写使用数据的应用</h3><p>  注意，这是另一个应用了。这个应用会通过content://com.cj.mycontentprovider/contact这个uri来使用上一个应用中提供的数据。<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line">  package com.cj.providerdemo1;  </div><div class="line">  </div><div class="line">import android.app.Activity;  </div><div class="line">import android.content.ContentResolver;  </div><div class="line">import android.content.Context;  </div><div class="line">import android.content.Intent;  </div><div class="line">import android.database.ContentObserver;  </div><div class="line">import android.database.Cursor;  </div><div class="line">import android.net.Uri;  </div><div class="line">import android.os.Bundle;  </div><div class="line">import android.os.Handler;  </div><div class="line">import android.support.v7.app.AppCompatActivity;  </div><div class="line">import android.view.LayoutInflater;  </div><div class="line">import android.view.View;  </div><div class="line">import android.view.ViewGroup;  </div><div class="line">import android.widget.AdapterView;  </div><div class="line">import android.widget.Button;  </div><div class="line">import android.widget.CursorAdapter;  </div><div class="line">import android.widget.ListView;  </div><div class="line">import android.widget.TextView;  </div><div class="line">  </div><div class="line">public class MainActivity extends AppCompatActivity &#123;  </div><div class="line">    private ListView lv;  </div><div class="line">    private Button btn;  </div><div class="line">    private ContentResolver resolver;  </div><div class="line">    private MyAdapter myAdapter;  </div><div class="line">    private Cursor cursor;  </div><div class="line">    @Override  </div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;  </div><div class="line">        super.onCreate(savedInstanceState);  </div><div class="line">        setContentView(R.layout.activity_main);  </div><div class="line">        lv = (ListView) findViewById(R.id.lv);  </div><div class="line">        btn = (Button) findViewById(R.id.btn);  </div><div class="line">        resolver = getContentResolver();  </div><div class="line">        cursor = resolver.query(Uri.parse(&quot;content://com.cj.mycontentprovider/contact&quot;), null, null,  </div><div class="line">                null, null);  </div><div class="line">            myAdapter = new MyAdapter(this,cursor);  </div><div class="line">            lv.setAdapter(myAdapter);  </div><div class="line">        btn.setOnClickListener(new View.OnClickListener() &#123;  </div><div class="line">            @Override  </div><div class="line">            public void onClick(View v) &#123;  </div><div class="line">                MainActivity.this.startActivityForResult(new Intent(MainActivity.this,AddActivity.class),  </div><div class="line">                        1);  </div><div class="line">            &#125;  </div><div class="line">        &#125;);  </div><div class="line">        String[] s = new String[2];  </div><div class="line">        lv.setOnItemClickListener(new AdapterView.OnItemClickListener() &#123;  </div><div class="line">            @Override  </div><div class="line">            public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) &#123;  </div><div class="line">                resolver.delete(Uri.parse(&quot;content://com.cj.mycontentprovider/contact&quot;),  </div><div class="line">                null,null);  </div><div class="line">  </div><div class="line">  </div><div class="line">            &#125;  </div><div class="line">        &#125;);  </div><div class="line">        resolver.registerContentObserver(Uri.parse(&quot;content://com.cj.mycontentprovider/contact&quot;),  </div><div class="line">                true,new MyContentObserver(new Handler()));  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    @Override  </div><div class="line">    protected void onActivityResult(int requestCode, int resultCode, Intent data) &#123;  </div><div class="line">        super.onActivityResult(requestCode, resultCode, data);  </div><div class="line">  </div><div class="line">  </div><div class="line">    &#125;  </div><div class="line">    private class MyContentObserver extends ContentObserver&#123;  </div><div class="line">  </div><div class="line">        /** </div><div class="line">         * Creates a content observer. </div><div class="line">         * </div><div class="line">         * @param handler The handler to run &#123;@link #onChange&#125; on, or null if none. </div><div class="line">         */  </div><div class="line">        public MyContentObserver(Handler handler) &#123;  </div><div class="line">            super(handler);  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        @Override  </div><div class="line">        public void onChange(boolean selfChange) &#123;  </div><div class="line">            myAdapter.notifyDataSetChanged();  </div><div class="line">  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">    private static class MyAdapter extends CursorAdapter&#123;  </div><div class="line">        private Cursor cursor;  </div><div class="line">        private Context context;  </div><div class="line">        public MyAdapter(Context context, Cursor c) &#123;  </div><div class="line">            super(context, c);  </div><div class="line">            this.context = context;  </div><div class="line">            this.cursor = c;  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        @Override  </div><div class="line">        public View newView(Context context, Cursor cursor, ViewGroup parent) &#123;  </div><div class="line">            LayoutInflater layoutInflater = LayoutInflater.from(context);  </div><div class="line">            View view = layoutInflater.inflate(R.layout.item, null);  </div><div class="line">            if(cursor !=null)&#123;  </div><div class="line">                view.setTag(cursor.getInt(cursor.getColumnIndex(&quot;_id&quot;)));  </div><div class="line">            &#125;  </div><div class="line">            return view;  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        @Override  </div><div class="line">        public void bindView(View view, Context context, Cursor cursor) &#123;  </div><div class="line">            TextView name = (TextView) view.findViewById(R.id.tv_name);  </div><div class="line">            TextView num = (TextView) view.findViewById(R.id.tv_num);  </div><div class="line">            if(cursor !=null)&#123;  </div><div class="line">                name.setText(cursor.getString(cursor.getColumnIndex(&quot;name&quot;)));  </div><div class="line">                num.setText(cursor.getString(cursor.getColumnIndex(&quot;number&quot;)));  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        @Override  </div><div class="line">        public long getItemId(int position) &#123;  </div><div class="line">            return super.getItemId(position);  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">package com.cj.providerdemo1;  </div><div class="line">  </div><div class="line">import android.app.Activity;  </div><div class="line">import android.content.ContentValues;  </div><div class="line">import android.net.Uri;  </div><div class="line">import android.support.v7.app.AppCompatActivity;  </div><div class="line">import android.os.Bundle;  </div><div class="line">import android.view.View;  </div><div class="line">import android.widget.EditText;  </div><div class="line">import android.widget.Toast;  </div><div class="line">  </div><div class="line">public class AddActivity extends AppCompatActivity &#123;  </div><div class="line">    private EditText et_name;  </div><div class="line">    private EditText et_num;  </div><div class="line">    @Override  </div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;  </div><div class="line">        super.onCreate(savedInstanceState);  </div><div class="line">        setContentView(R.layout.activity_add);  </div><div class="line">        et_name = (EditText) findViewById(R.id.et_name);  </div><div class="line">        et_num = (EditText) findViewById(R.id.et_num);  </div><div class="line">    &#125;  </div><div class="line">    public void add(View view)&#123;  </div><div class="line">        String name = et_name.getText().toString();  </div><div class="line">        String num = et_num.getText().toString();  </div><div class="line">        if(name == null || num == null)&#123;  </div><div class="line">            Toast.makeText(this,&quot;姓名和号码不能为空&quot;,Toast.LENGTH_SHORT).show();  </div><div class="line">        &#125;else &#123;  </div><div class="line">            ContentValues contentValues = new ContentValues();  </div><div class="line">            contentValues.put(&quot;name&quot;,name);  </div><div class="line">            contentValues.put(&quot;number&quot;,num);  </div><div class="line">            getContentResolver().insert(Uri.parse(&quot;content://com.cj.mycontentprovider/contact&quot;),contentValues);  </div><div class="line">            setResult(Activity.RESULT_OK);  </div><div class="line">            finish();  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个应用主要提供两个功能：1.查询数据并显示。2.新增数据并显示。都是使用ContentResolver，通过uri来使用第一个应用程序中的方法来实现的。</p>
<p>首先，获取ContentResolver<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">resolver = getContentResolver();</div></pre></td></tr></table></figure></p>
<p>然后通过query方法来获得数据。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cursor = resolver.query(Uri.parse(&quot;content://com.cj.mycontentprovider/contact&quot;), null, null,  </div><div class="line">               null, null);</div></pre></td></tr></table></figure></p>
<p>然而resolver是如何最终调用到我们的MyContentProvider中的query方法的呢？下面深入源码来分析这个过程。</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="获取ContentResoler对象"><a href="#获取ContentResoler对象" class="headerlink" title="获取ContentResoler对象"></a>获取ContentResoler对象</h3><p>一切都从getContentResoler()这个方法开始。<br>framerwork/base/core/java/android/content/ContextWrapper.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public ContentResolver getContentResolver() &#123;</div><div class="line">    return mBase.getContentResolver();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p> mBase变量是ContextImpl类型,是在创建activity的时候,new 一个ContextImpl对象,赋值给activity的.</p>
<p> frameworks/base/core/java/android/app/ContextImpl.java<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> @Override</div><div class="line">public ContentResolver getContentResolver() &#123;</div><div class="line">    return mContentResolver;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p> 这里直接返回了ContextImpl对象的成员变量mContentResolver;这个变量是在APP启动的时候赋值的<br> frameworks/base/core/java/android/app/ActivityThread.java<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;  </div><div class="line">      ....  </div><div class="line"> </div><div class="line">      Activity activity = null;  </div><div class="line">    ...  </div><div class="line">      &#125;  </div><div class="line"> </div><div class="line">      try &#123;  </div><div class="line">      ...  </div><div class="line">          if (activity != null) &#123;  </div><div class="line">              Context appContext = createBaseContextForActivity(r, activity);//创建contextimpl的地方  </div><div class="line">              CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());  </div><div class="line">              Configuration config = new Configuration(mCompatConfiguration);  </div><div class="line">              if (DEBUG_CONFIGURATION) Slog.v(TAG, &quot;Launching activity &quot;  </div><div class="line">                      + r.activityInfo.name + &quot; with config &quot; + config);  </div><div class="line">              activity.attach(appContext, this, getInstrumentation(), r.token,  </div><div class="line">                      r.ident, app, r.intent, r.activityInfo, title, r.parent,  </div><div class="line">                      r.embeddedID, r.lastNonConfigurationInstances, config);//这里将创建的contextimpl对象传给activity内部mBase变量  </div><div class="line"> </div><div class="line">           ....  </div><div class="line">      return activity;  </div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>   通过createBaseContextForActivity()函数创建contextimpl对象,然后通过attach()函数将创建的contextimpl对象赋值给activity的内部变量,对应第一步的mBase变量。接下来，查看创建contextimpl对象的地方,看createBaseContextForActivity()函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">   private Context createBaseContextForActivity(ActivityClientRecord r, final Activity activity) &#123;</div><div class="line">  ...</div><div class="line">    ContextImpl appContext = ContextImpl.createActivityContext(</div><div class="line">            this, r.packageInfo, displayId, r.overrideConfig);</div><div class="line">    appContext.setOuterContext(activity);</div><div class="line">    Context baseContext = appContext;</div><div class="line"></div><div class="line">    final DisplayManagerGlobal dm = DisplayManagerGlobal.getInstance();</div><div class="line"></div><div class="line">    ...</div><div class="line">    if (pkgName != null &amp;&amp; !pkgName.isEmpty()</div><div class="line">            &amp;&amp; r.packageInfo.mPackageName.contains(pkgName)) &#123;</div><div class="line">        for (int id : dm.getDisplayIds()) &#123;</div><div class="line">            if (id != Display.DEFAULT_DISPLAY) &#123;</div><div class="line">                Display display =</div><div class="line">                        dm.getCompatibleDisplay(id, appContext.getDisplayAdjustments(id));</div><div class="line">                baseContext = appContext.createDisplayContext(display);</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return baseContext;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>它调用到了ContextImpl.createActivityContext(<br>                this, r.packageInfo, displayId, r.overrideConfig);方法<br> frameworks/base/core/java/android/app/ContextImpl.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">static ContextImpl createActivityContext(ActivityThread mainThread,</div><div class="line">        LoadedApk packageInfo, int displayId, Configuration overrideConfiguration) &#123;</div><div class="line">    if (packageInfo == null) throw new IllegalArgumentException(&quot;packageInfo&quot;);</div><div class="line">    return new ContextImpl(null, mainThread, packageInfo, null, null, false,</div><div class="line">            null, overrideConfiguration, displayId, null);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用到ContextImpl方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">private ContextImpl(ContextImpl container, ActivityThread mainThread,</div><div class="line">            LoadedApk packageInfo, IBinder activityToken, UserHandle user, boolean restricted,</div><div class="line">            Display display, Configuration overrideConfiguration, int createDisplayWithId,</div><div class="line">            String themePackageName) &#123;</div><div class="line">        ...</div><div class="line">        mContentResolver = new ApplicationContentResolver(this, mainThread, user);</div><div class="line">        ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>无关代码全部隐去，可以看到mContentResolver就是在这里被赋值的。这样，就得到了ContentResolver对象。</p>
<h3 id="获取IContentProvider对象"><a href="#获取IContentProvider对象" class="headerlink" title="获取IContentProvider对象"></a>获取IContentProvider对象</h3><p>接下来，查看query方法。<br>frameworks/base/core/java/android/content/ContentResolver.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">public final @Nullable Cursor query(@NonNull Uri uri, @Nullable String[] projection,</div><div class="line">        @Nullable String selection, @Nullable String[] selectionArgs,</div><div class="line">        @Nullable String sortOrder) &#123;</div><div class="line">    android.util.SeempLog.record_uri(13, uri);</div><div class="line">    return query(uri, projection, selection, selectionArgs, sortOrder, null);</div><div class="line">&#125;</div><div class="line"></div><div class="line">    public final @Nullable Cursor query(final @NonNull Uri uri, @Nullable String[] projection,</div><div class="line">        @Nullable String selection, @Nullable String[] selectionArgs,</div><div class="line">        @Nullable String sortOrder, @Nullable CancellationSignal cancellationSignal) &#123;</div><div class="line">    ...</div><div class="line">    IContentProvider unstableProvider = acquireUnstableProvider(uri);</div><div class="line">    if (unstableProvider == null) &#123;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line">    IContentProvider stableProvider = null;</div><div class="line">    Cursor qCursor = null;</div><div class="line">    try &#123;</div><div class="line">        ...</div><div class="line">        try &#123;</div><div class="line">            qCursor = unstableProvider.query(mPackageName, uri, projection,</div><div class="line">                    selection, selectionArgs, sortOrder, remoteCancellationSignal);//使用IContentProvider对象的query方法,最终会调用ContentProvider对象的query()方法 </div><div class="line">        &#125; catch (DeadObjectException e) &#123;</div><div class="line">            unstableProviderDied(unstableProvider);</div><div class="line">            stableProvider = acquireProvider(uri);</div><div class="line">            if (stableProvider == null) &#123;</div><div class="line">                return null;</div><div class="line">            &#125;</div><div class="line">            qCursor = stableProvider.query(mPackageName, uri, projection,</div><div class="line">                    selection, selectionArgs, sortOrder, remoteCancellationSignal);//使用IContentProvider对象的query方法,最终会调用ContentProvider对象的query()方法 </div><div class="line">        &#125;</div><div class="line">        if (qCursor == null) &#123;</div><div class="line">            return null;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Force query execution.  Might fail and throw a runtime exception here.</div><div class="line">        qCursor.getCount();</div><div class="line">            ...</div><div class="line">        CursorWrapperInner wrapper = new CursorWrapperInner(qCursor,</div><div class="line">                stableProvider != null ? stableProvider : acquireProvider(uri));</div><div class="line">        stableProvider = null;</div><div class="line">        qCursor = null;</div><div class="line">        return wrapper;</div><div class="line">    &#125; catch (RemoteException e) &#123;</div><div class="line">            ...</div><div class="line">        return null;</div><div class="line">    &#125; finally &#123;</div><div class="line">       ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>无论最终使用的是unstableProvider还是stableProvider，都是调用了IContentProvider对象的query方法。<br>在查看这个方法之前，先来关注一下unstableProvider和stableProvider的获取。<br>frameworks/base/core/java/android/content/ContentResolver.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">public final IContentProvider acquireUnstableProvider(Uri uri) &#123;</div><div class="line">    if (!SCHEME_CONTENT.equals(uri.getScheme())) &#123;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line">    String auth = uri.getAuthority();</div><div class="line">    if (auth != null) &#123;</div><div class="line">        return acquireUnstableProvider(mContext, uri.getAuthority());</div><div class="line">    &#125;</div><div class="line">    return null;</div><div class="line">&#125;</div><div class="line"></div><div class="line">    public final IContentProvider acquireProvider(Uri uri) &#123;</div><div class="line">    if (!SCHEME_CONTENT.equals(uri.getScheme())) &#123;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line">    final String auth = uri.getAuthority();</div><div class="line">    if (auth != null) &#123;</div><div class="line">        return acquireProvider(mContext, auth);</div><div class="line">    &#125;</div><div class="line">    return null;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这两个函数的返回值都是一个IContentProvider类型。<br>frameworks/base/core/java/android/app/ContextImpl.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">protected IContentProvider acquireProvider(Context context, String auth) &#123;</div><div class="line">    return mMainThread.acquireProvider(context,</div><div class="line">            ContentProvider.getAuthorityWithoutUserId(auth),</div><div class="line">            resolveUserIdFromAuthority(auth), true);</div><div class="line">&#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">protected IContentProvider acquireUnstableProvider(Context c, String auth) &#123;</div><div class="line">    return mMainThread.acquireProvider(c,</div><div class="line">            ContentProvider.getAuthorityWithoutUserId(auth),</div><div class="line">            resolveUserIdFromAuthority(auth), false);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>mMainThread是一个ActivityThread类型的对象，这两个方法最终都调用了它的acquireProvider方法。其中第二个参数ContentProvider.getAuthorityWithoutUserId(auth),获得的就是在AndroidManifest.xml文件中配置的android:authorities的值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">public final IContentProvider acquireProvider(</div><div class="line">        Context c, String auth, int userId, boolean stable) &#123;</div><div class="line">    final IContentProvider provider = acquireExistingProvider(c, auth, userId, stable);</div><div class="line">    if (provider != null) &#123;</div><div class="line">        return provider;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    IActivityManager.ContentProviderHolder holder = null;</div><div class="line">    try &#123;</div><div class="line">        holder = ActivityManagerNative.getDefault().getContentProvider(</div><div class="line">                getApplicationThread(), auth, userId, stable);</div><div class="line">    &#125; catch (RemoteException ex) &#123;</div><div class="line">    &#125;</div><div class="line">    if (holder == null) &#123;</div><div class="line">        Slog.e(TAG, &quot;Failed to find provider info for &quot; + auth);</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    holder = installProvider(c, holder, holder.info,</div><div class="line">            true /*noisy*/, holder.noReleaseNeeded, stable);</div><div class="line">    return holder.provider;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里就是查找ContentProvider的精髓所在。</p>
<ol>
<li>首先，acquireExistingProvider(c, auth, userId, stable);这个函数检查本地是否已经存在这个要获取的IContentProvider。本地已经存在的IContentProvider保存在ActivityThread类的mProviderMap成员变量中，以ContentProvider对应的URI的authority为键值保存。如果本地已经存在了这个IContentProvider，直接返回它。当本地没有时，进入步骤2.</li>
<li>获取ContentProviderHolder对象holder。通过ActivityManagerNative.getDefault().getContentProvider来获取holder。这其中经过Binder驱动进行进程间通信,会调用到ActivityManagerService中的getContentProvider()函数。具体过程可以查看<a href="http://blog.csdn.net/hehe26/article/details/51784355" target="_blank" rel="external">这篇</a>。ActivityManagerService会把所有的ContentProvider都实例化出来，并且缓存在一个map里面，所以我们就可以从ActivityManagerService远程得到一个ContentProvider对象。</li>
<li>调用installProvider将这个IContentProvider保存在本地中，以便下次要使用这个IContentProvider时，直接就可以通过getExistingProvider()函数获取。</li>
</ol>
<p>获取到这个IContentProvider对象后，query等方法的最终调用就会指向MyContentProvider类中的方法了。</p>
<h3 id="数据更新（ContentObserver）"><a href="#数据更新（ContentObserver）" class="headerlink" title="数据更新（ContentObserver）"></a>数据更新（ContentObserver）</h3><p>ContentProvider使用ContentObserver进行数据更新，其中应用到了观察者模式。<a href="https://ichrisking.github.io/2016/11/07/pattern-observer/" target="_blank" rel="external">Android中的设计模式之观察者模式</a><br>ContentProvider的数据更新机制划分为两个单元，第一个单元是监控数据变化的ContentObserver的注册过程，第二个单元是数据更新通知的发送过程。</p>
<h4 id="ContentObserver的注册过程"><a href="#ContentObserver的注册过程" class="headerlink" title="ContentObserver的注册过程"></a>ContentObserver的注册过程</h4><p>在第二个程序的onCreate中，使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">resolver.registerContentObserver(Uri.parse(&quot;content://com.cj.mycontentprovider/contact&quot;),  </div><div class="line">                true,new MyContentObserver(new Handler()));</div></pre></td></tr></table></figure></p>
<p>注册一个自定义的ContentObserver(MyContentObserver)来监控MyContentProvider这个Content Provider中的数据变化.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">private class MyContentObserver extends ContentObserver&#123;  </div><div class="line"> </div><div class="line">       /** </div><div class="line">        * Creates a content observer. </div><div class="line">        * </div><div class="line">        * @param handler The handler to run &#123;@link #onChange&#125; on, or null if none. </div><div class="line">        */  </div><div class="line">       public MyContentObserver(Handler handler) &#123;  </div><div class="line">           super(handler);  </div><div class="line">       &#125;  </div><div class="line"> </div><div class="line">       @Override  </div><div class="line">       public void onChange(boolean selfChange) &#123;  </div><div class="line">           myAdapter.notifyDataSetChanged();  </div><div class="line"> </div><div class="line">       &#125;  </div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>从ContentObserver继承下来的子类必须要实现onChange函数。当这个ContentObserver子类负责监控的数据发生变化时，ContentService就会调用它的onChange函数来处理，参数selfChange表示这个变化是否是由自己引起的。在这个应用程序中，MyContentObserver继承了ContentObserver类，它负责监控的URI是”content://com.cj.mycontentprovider/contact”.当以这个URI为前缀的URI对应的数据发生改变时，ContentService都会调用这个MyContentObserver类的onChange函数来处理。在MyContentObserver类的onChange函数中，执行的操作就是重新获取MyContentProvider中的数据来更新界面上的联系人信息列表。</p>
<p>在MyContentObserver类的构造函数中，有一个参数handler，它的类型为Handler，它是从MainActivity类的onCreate函数中创建并传过来的。这个handler是用来分发和处理消息用的。由于MainActivity类的onCreate函数是在应用程序的主线程中被调用的，因此，这个handler参数就是和应用程序主线程的消息循环关联在一起的。在后面我们分析数据更新通知的发送过程时，便会看到这个handler参数是如何使用的了。</p>
<p>frameworks/base/core/java/android/content/ContentResolver.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">public final void registerContentObserver(@NonNull Uri uri, boolean notifyForDescendents,</div><div class="line">        @NonNull ContentObserver observer) &#123;</div><div class="line">    Preconditions.checkNotNull(uri, &quot;uri&quot;);</div><div class="line">    Preconditions.checkNotNull(observer, &quot;observer&quot;);</div><div class="line">    registerContentObserver(</div><div class="line">            ContentProvider.getUriWithoutUserId(uri),</div><div class="line">            notifyForDescendents,</div><div class="line">            observer,</div><div class="line">            ContentProvider.getUserIdFromUri(uri, UserHandle.myUserId()));</div><div class="line">&#125;</div><div class="line"></div><div class="line">/** @hide - designated user version */</div><div class="line">public final void registerContentObserver(Uri uri, boolean notifyForDescendents,</div><div class="line">        ContentObserver observer, int userHandle) &#123;</div><div class="line">    try &#123;</div><div class="line">        getContentService().registerContentObserver(uri, notifyForDescendents,</div><div class="line">                observer.getContentObserver(), userHandle);</div><div class="line">    &#125; catch (RemoteException e) &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当参数notifyForDescendents为true时，表示要监控所有以uri为前缀的URI对应的数据变化。上面函数做了三件事情，一是调用getContentService函数来获得前面已经启动起来了的ContentService服务，二是调用从参数传进来的ContentObserver对象observer的getContentObserver函数来获得一个Binder对象，三是通过调用这个ContentService远程接口的registerContentObserver函数来把这个Binder对象注册到ContentService中去。</p>
<h5 id="getContentService"><a href="#getContentService" class="headerlink" title="getContentService"></a>getContentService</h5><p>frameworks/base/core/java/android/content/ContentResolver.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public static IContentService getContentService() &#123;</div><div class="line">    if (sContentService != null) &#123;</div><div class="line">        return sContentService;</div><div class="line">    &#125;</div><div class="line">    IBinder b = ServiceManager.getService(CONTENT_SERVICE_NAME);</div><div class="line">    ...</div><div class="line">    sContentService = IContentService.Stub.asInterface(b);</div><div class="line">    ...</div><div class="line">    return sContentService;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p> 在ContentResolver类中，有一个静态成员变量sContentService，开始时它的值为null。当ContentResolver类的getContentService函数第一次被调用时，它便会通过ServiceManager类的getService函数来获得前面已经启动起来了的ContentService服务的远程接口，然后把它保存在sContentService变量中。这样，当下次ContentResolver类的getContentService函数再次被调用时，就可以直接把这个ContentService远程接口返回给调用者了</p>
<h5 id="getContentObserver"><a href="#getContentObserver" class="headerlink" title="getContentObserver"></a>getContentObserver</h5><p>frameworks/base/core/java/android/database/ContentObserver.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public IContentObserver getContentObserver() &#123;</div><div class="line">    synchronized (mLock) &#123;</div><div class="line">        if (mTransport == null) &#123;</div><div class="line">            mTransport = new Transport(this);</div><div class="line">        &#125;</div><div class="line">        return mTransport;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ContentObserver类的getContentObserver函数返回的是一个成员变量mTransport，它的类型为ContentObserver的内部类Transport。ContentObserver类的成员变量mTransport是一个Binder对象，它是要传递给ContentService服务的，以便当ContentObserver所监控的数据发生变化时，ContentService服务可以通过这个Binder对象通知相应的ContentObserver它监控的数据发生变化了。</p>
<h5 id="registerContentObserver"><a href="#registerContentObserver" class="headerlink" title="registerContentObserver"></a>registerContentObserver</h5><p>frameworks/base/services/core/java/com/android/server/content/ContentService.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public void registerContentObserver(Uri uri, boolean notifyForDescendants,</div><div class="line">        IContentObserver observer, int userHandle) &#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    synchronized (mRootNode) &#123;</div><div class="line">        mRootNode.addObserverLocked(uri, observer, notifyForDescendants, mRootNode,</div><div class="line">                uid, pid, userHandle);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>它调用了ContentService类的成员变量mRootNode的addObserverLocked函数来注册这个ContentObserver对象observer。成员变量mRootNode的类型为ContentService在内部定义的一个类ObserverNode。</p>
<h5 id="addObserverLocked"><a href="#addObserverLocked" class="headerlink" title="addObserverLocked"></a>addObserverLocked</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"> public void addObserverLocked(Uri uri, IContentObserver observer,</div><div class="line">        boolean notifyForDescendants, Object observersLock,</div><div class="line">        int uid, int pid, int userHandle) &#123;</div><div class="line">    addObserverLocked(uri, 0, observer, notifyForDescendants, observersLock,</div><div class="line">            uid, pid, userHandle);</div><div class="line">&#125;</div><div class="line"></div><div class="line">private void addObserverLocked(Uri uri, int index, IContentObserver observer,</div><div class="line">        boolean notifyForDescendants, Object observersLock,</div><div class="line">        int uid, int pid, int userHandle) &#123;</div><div class="line">    // If this is the leaf node add the observer</div><div class="line">    if (index == countUriSegments(uri)) &#123;</div><div class="line">        mObservers.add(new ObserverEntry(observer, notifyForDescendants, observersLock,</div><div class="line">                uid, pid, userHandle));</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Look to see if the proper child already exists</div><div class="line">    String segment = getUriSegment(uri, index);</div><div class="line">    if (segment == null) &#123;</div><div class="line">        throw new IllegalArgumentException(&quot;Invalid Uri (&quot; + uri + &quot;) used for observer&quot;);</div><div class="line">    &#125;</div><div class="line">    int N = mChildren.size();</div><div class="line">    for (int i = 0; i &lt; N; i++) &#123;</div><div class="line">        ObserverNode node = mChildren.get(i);</div><div class="line">        if (node.mName.equals(segment)) &#123;</div><div class="line">            node.addObserverLocked(uri, index + 1, observer, notifyForDescendants,</div><div class="line">                    observersLock, uid, pid, userHandle);</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // No child found, create one</div><div class="line">    ObserverNode node = new ObserverNode(segment);</div><div class="line">    mChildren.add(node);</div><div class="line">    node.addObserverLocked(uri, index + 1, observer, notifyForDescendants,</div><div class="line">            observersLock, uid, pid, userHandle);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，注册到ContentService中的ContentObserver按照树形来组织，树的节点类型为ObserverNode，而树的根节点就为ContentService类的成员变量mRootNode。<br>private final ObserverNode mRootNode = new ObserverNode(“”);<br>每一个ObserverNode节点都对应一个名字，它是从URI中解析出来的。<br>在这个应用程序例子中，uri为content://com.cj.mycontentprovider/contact，它最终解析成的树状结构为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mRootNode(&quot;&quot;)</div><div class="line"></div><div class="line">    -- ObserverNode(&quot;com.cj.mycontentprovider&quot;)</div><div class="line"></div><div class="line">        --ObserverNode(&quot;contact&quot;) , which has a ContentObserver in mObservers</div></pre></td></tr></table></figure></p>
<p>至此，ContentObserver的注册过程就完成了。</p>
<h4 id="数据更新通知的发送过程"><a href="#数据更新通知的发送过程" class="headerlink" title="数据更新通知的发送过程"></a>数据更新通知的发送过程</h4><p>在第二个应用程序中，在添加联系人的界面田添加一个联系人时：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ContentValues contentValues = new ContentValues();    </div><div class="line">            contentValues.put(&quot;name&quot;,name);    </div><div class="line">            contentValues.put(&quot;number&quot;,num);    </div><div class="line">            getContentResolver().insert(Uri.parse(&quot;content://com.cj.mycontentprovider/contact&quot;),contentValues);</div></pre></td></tr></table></figure></p>
<p>会调用到第一个应用程序的MyContentProvider类的insert函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public Uri insert(Uri uri, ContentValues values) &#123;  </div><div class="line">       Uri u = null;  </div><div class="line">       if(uriMatcher.match(uri) == CONTACT)&#123;  </div><div class="line">           SQLiteDatabase database = dbHelp.getWritableDatabase();  </div><div class="line"> </div><div class="line">           long d = database.insert(&quot;contact&quot;, &quot;_id&quot;, values);  </div><div class="line">           u = ContentUris.withAppendedId(uri,d);  </div><div class="line">           contentResolver.notifyChange(u,null);  </div><div class="line">       &#125;  </div><div class="line">       return u;  </div><div class="line"> </div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>从上面传来的参数uri的值为”content://com.cj.mycontentprovider/contact”。假设当这个函数把数据成功增加到SQLite数据库之后，返回来的id值为d，于是通过调用ContentUris.withAppendedId(uri,d);得到的newUri的值就为”content://com.cj.mycontentprovider/contact/d”。这时候就会调用下面语句来通知那些注册了监控”content://com.cj.mycontentprovider/contact/d”这个URI的ContentObserver，它监控的数据发生变化了：<br>contentResolver.notifyChange(u,null);<br>下面就根据源码来分析这个数据变化通知的发送过程：ContentResolver.notifyChange()<br>frameworks/base/core/java/android/content/ContentResolver.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">public void notifyChange(@NonNull Uri uri, @Nullable ContentObserver observer) &#123;</div><div class="line">    notifyChange(uri, observer, true /* sync to network */);</div><div class="line">&#125;</div><div class="line"></div><div class="line">public void notifyChange(@NonNull Uri uri, @Nullable ContentObserver observer,</div><div class="line">        boolean syncToNetwork) &#123;</div><div class="line">    Preconditions.checkNotNull(uri, &quot;uri&quot;);</div><div class="line">    notifyChange(</div><div class="line">            ContentProvider.getUriWithoutUserId(uri),</div><div class="line">            observer,</div><div class="line">            syncToNetwork,</div><div class="line">            ContentProvider.getUserIdFromUri(uri, UserHandle.myUserId()));</div><div class="line">&#125;</div><div class="line"></div><div class="line"> public void notifyChange(Uri uri, ContentObserver observer, boolean syncToNetwork,</div><div class="line">        int userHandle) &#123;</div><div class="line">    try &#123;</div><div class="line">        getContentService().notifyChange(</div><div class="line">                uri, observer == null ? null : observer.getContentObserver(),</div><div class="line">                observer != null &amp;&amp; observer.deliverSelfNotifications(), syncToNetwork,</div><div class="line">                userHandle);</div><div class="line">    &#125; catch (RemoteException e) &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用了ContentService的远接程口来调用它的notifyChange()函数来发送数据更新通知。<br>frameworks/base/services/core/java/com/android/server/content/ContentService.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">public void notifyChange(Uri uri, IContentObserver observer,</div><div class="line">        ...</div><div class="line">    try &#123;</div><div class="line">        ArrayList&lt;ObserverCall&gt; calls = new ArrayList&lt;ObserverCall&gt;();</div><div class="line">        synchronized (mRootNode) &#123;</div><div class="line">            mRootNode.collectObserversLocked(uri, 0, observer, observerWantsSelfNotifications,</div><div class="line">                    userHandle, calls);</div><div class="line">        &#125;</div><div class="line">        final int numCalls = calls.size();</div><div class="line">        for (int i=0; i&lt;numCalls; i++) &#123;</div><div class="line">            ObserverCall oc = calls.get(i);</div><div class="line">            try &#123;</div><div class="line">                oc.mObserver.onChange(oc.mSelfChange, uri, userHandle);</div><div class="line">                ...</div><div class="line">                &#125;</div><div class="line">            &#125; catch (RemoteException ex) &#123;</div><div class="line">                ...</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">       ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个函数主要做了两件事情，第一件事情是调用ContentService的成员变量mRootNode的collectObserverLocked()函数来收集那些注册了监控”content://com.cj.mycontentprovider/contact/d”这个URI的ContentObserver，第二件事情是分别调用了这些ContentObserver的onChange()函数来通知它们监控的数据发生变化了。</p>
<p>可以看到，calls的类型，是一个ObserverCall的ArrayList，查看ObserverCall的定义<br>frameworks/base/services/core/java/com/android/server/content/ContentService.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public static final class ObserverCall &#123;</div><div class="line">    final ObserverNode mNode;</div><div class="line">    final IContentObserver mObserver;</div><div class="line">    final boolean mSelfChange;</div><div class="line"></div><div class="line">    ObserverCall(ObserverNode node, IContentObserver observer, boolean selfChange) &#123;</div><div class="line">        mNode = node;</div><div class="line">        mObserver = observer;</div><div class="line">        mSelfChange = selfChange;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中包括一个成员 IContentObserver mObserver。这个就是注册了监控”content://com.cj.mycontentprovider/contact/d”这个URI的ContentObserver。<br>在本例当中，只有一个这样的ContentObserver，即在第二个应用程序中注册的MyContentObserver。</p>
<p>接下来，会调用这个ContentObserver的onChange方法，通知数据更新事件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">oc.mObserver.onChange(oc.mSelfChange, uri, userHandle);</div></pre></td></tr></table></figure></p>
<p>前面我们在分析ContentObserver的注册过程时，介绍到注册到ContentService服务中的mObserver是一个在ContentObserver内部定义的一个类Transport的对象的远程接口，于是这里调用这个接口的onChange()函数时，就会进入到ContentObserver的内部类Transport的onChange()函数中去。<br>frameworks/base/core/java/android/database/ContentObserver.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">private static final class Transport extends IContentObserver.Stub &#123;</div><div class="line">    private ContentObserver mContentObserver;</div><div class="line"></div><div class="line">    public Transport(ContentObserver contentObserver) &#123;</div><div class="line">        mContentObserver = contentObserver;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onChange(boolean selfChange, Uri uri, int userId) &#123;</div><div class="line">        ContentObserver contentObserver = mContentObserver;</div><div class="line">        if (contentObserver != null) &#123;</div><div class="line">            contentObserver.dispatchChange(selfChange, uri, userId);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void releaseContentObserver() &#123;</div><div class="line">        mContentObserver = null;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>frameworks/base/core/java/android/database/ContentObserver.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">private void dispatchChange(boolean selfChange, Uri uri, int userId) &#123;</div><div class="line">    if (mHandler == null) &#123;</div><div class="line">        onChange(selfChange, uri, userId);</div><div class="line">    &#125; else &#123;</div><div class="line">        mHandler.post(new NotificationRunnable(selfChange, uri, userId));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在前面分析MyContentObserver的注册过程时，我们以第二个应用程序的主线程的消息循环创建了一个Handler，并且以这个Handler来创建了这个MyContentObserver，这个Handler就保存在MyContentObserver的父类ContentObserver的成员变量mHandler中。因此，这里的mHandler不为null，于是把这个数据更新通知封装成了一个消息，放到第二个应用程序的主线程中去处理，最终这个消息是由NotificationRunnable类的run()函数来处理的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">private final class NotificationRunnable implements Runnable &#123;</div><div class="line">    private final boolean mSelfChange;</div><div class="line">    private final Uri mUri;</div><div class="line">    private final int mUserId;</div><div class="line"></div><div class="line">    public NotificationRunnable(boolean selfChange, Uri uri, int userId) &#123;</div><div class="line">        mSelfChange = selfChange;</div><div class="line">        mUri = uri;</div><div class="line">        mUserId = userId;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void run() &#123;</div><div class="line">        ContentObserver.this.onChange(mSelfChange, mUri, mUserId);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个函数就直接调用ContentObserver的子类的onChange函数来处理这个数据更新通知了。在我们这个情景中，这个ContentObserver子类便是MyContentObserver了。<br>这里它要执行的操作便是更新界面上的ListView列表中的联系人信息了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/04/contentprovider/" data-id="cje6pjw1i002qweyx603s32vw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-pattern-proxy" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/21/pattern-proxy/" class="article-date">
  <time datetime="2016-12-21T11:15:06.000Z" itemprop="datePublished">2016-12-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/设计模式/">设计模式</a>►<a class="article-category-link" href="/categories/设计模式/Java/">Java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/21/pattern-proxy/">Android中的设计模式之代理模式</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>代理模式是对象的结构模式。代理模式给某一个对象提供一个代理对象，并由代理对象控制对原对象的引用。</p>
<p>进行交互的时候，不和原本的对象直接交互，而是通过代理的方式，用代理来代替真正的对象进行交互，这样做的好处是降低了耦合性。</p>
<p><img src="/assets/img/pattern-proxy/proxy.png" alt="image"></p>
<p>　　在代理模式中的角色：</p>
<p>　　●　　抽象对象角色：声明了目标对象和代理对象的共同接口，这样一来在任何可以使用目标对象的地方都可以使用代理对象。</p>
<p>　　●　　目标对象角色：定义了代理对象所代表的目标对象。</p>
<p>　　●　　代理对象角色：代理对象内部含有目标对象的引用，从而可以在任何时候操作目标对象；代理对象提供一个与目标对象相同的接口，以便可以在任何时候替代目标对象。代理对象通常在客户端调用传递给目标对象之前或之后，执行某个操作，而不是单纯地将调用传递给目标对象。</p>
<p><a href="http://www.cnblogs.com/java-my-life/archive/2012/04/23/2466712.html" target="_blank" rel="external">示例代码</a></p>
<h2 id="代理模式的分类"><a href="#代理模式的分类" class="headerlink" title="代理模式的分类"></a>代理模式的分类</h2><p><a href="http://m.blog.csdn.net/article/details?id=53645189" target="_blank" rel="external">示例代码</a></p>
<h3 id="普通代理"><a href="#普通代理" class="headerlink" title="普通代理"></a>普通代理</h3><p>创建一个和真实对象相同的类，将真实的对象当作参数传入到代理中，当外界通过代理进行操作的时候，代理中的真实对象也会进行相应的操作。</p>
<p>操作：</p>
<ol>
<li>创建接口，定义共同方法。</li>
<li>创建真实类，实现接口</li>
<li>创建代理类实现接口，但是增加一步，在构造方法中将真实对象的引用当作参数，拿到真实对象。</li>
<li>得到代理对象，通过对代理对象操作，实现真实对象的相应操作</li>
</ol>
<h3 id="虚拟代理"><a href="#虚拟代理" class="headerlink" title="虚拟代理"></a>虚拟代理</h3><p>也可以叫做延时代理，他的思想就是在真实对象数据量非常大的时候通过代理先代替真实对象，当真正操作真实对象的时候在加载真实对象，这样做能够在很大程度上提高效率。</p>
<h3 id="强制代理"><a href="#强制代理" class="headerlink" title="强制代理"></a>强制代理</h3><p>强制代理是反其道而行之的代理模式,一般情况下代理模式都是通过代理来找到真实的对象,而强制代理则是通过真实对象才能找到代理也就是说由真实对象指定代理,当然最终访问还是通过代理模式访问的.</p>
<h3 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h3><p>动态代理是针对当需要的代理非常多的情况下，如果使用普通代理的话，难免需要创建多个相同的代理类，因为普通代理都必须创建一个和真实类相同的类，所以动态代理使用动态的方式减少了大量冗余类的出现，给代理增添了扩展性。</p>
<h2 id="Android中的代理模式"><a href="#Android中的代理模式" class="headerlink" title="Android中的代理模式"></a>Android中的代理模式</h2><p>Android中的各种service大多是通过代理来向应用层提供服务的。</p>
<p>以ActivityManager为例<br><img src="/assets/img/pattern-proxy/ActivityManager.jpg" alt="image"></p>
<p>IActivityManager(frameworks/base/core/java/android/app/ActivityManagerNative.java)作为ActivityManagerProxy和ActivityManagerNative的公共接口，所以两个类具有部分相同的接口，可以实现合理的代理模式；</p>
<p>ActivityManagerProxy代理类是ActivityManagerNative的内部类；</p>
<p>查看代码：<br>frameworks/base/core/java/android/app/ActivityManager.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public abstract class ActivityManagerNative extends Binder implements IActivityManager</div><div class="line">&#123;</div><div class="line">...</div><div class="line">&#125;</div><div class="line"></div><div class="line">class ActivityManagerProxy implements IActivityManager</div><div class="line">&#123;</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的IActivityManager相当于代理模式中的抽象对象，ActivityManagerProxy相当于代理对象。而目标对象则是ActivityManagerNative。</p>
<p>然而ActivityManagerNative是个抽象类，真正发挥作用的是它的子类ActivityManagerService（系统Service组件）。ActivityManagerService是真正意义上的目标对象。所以可以说ActivityManagerService实现了IActivityManager的所有功能，比如启动Activity，绑定服务，注册广播等等，这些逻辑最终都是交给ActivityManagerService实现的。</p>
<p>从图中可以看出代理类：使用ActivityManagerProxy代理类，来代理ActivityManagerNative类的子类ActivityManagerService；</p>
<p>ActivityManagerService是系统统一的Service，运行在独立的进程中；通过系统ServiceManger获取；</p>
<p>ActivityManager运行在一个进程里面，ActivityManagerService运行在另一个进程内，</p>
<p>对象在不同的进程里面，其地址是相互独立的；实现跨进程的对象访问，需要对应进程间通信的规则，</p>
<p>此处是采用Binder机制实现跨进程通信；所以此处的Proxy模式的运用属于：远程代理（RemoteProxy）。</p>
<h3 id="代理实现过程"><a href="#代理实现过程" class="headerlink" title="代理实现过程"></a>代理实现过程</h3><p>这里涉及到两个过程：</p>
<ol>
<li>代理对象建立：ActivityManagerProxy代理对象的创建；</li>
</ol>
<p>2.程序执行过程：如何通过代理对象来执行真正对象请求；</p>
<h4 id="代理对象建立"><a href="#代理对象建立" class="headerlink" title="代理对象建立"></a>代理对象建立</h4><p>是在ActivityManager的执行时就需要代理类来执行；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public List&lt;RunningServiceInfo&gt; getRunningServices(int maxNum)</div><div class="line">        throws SecurityException &#123;</div><div class="line">    try &#123;</div><div class="line">        return ActivityManagerNative.getDefault()</div><div class="line">                .getServices(maxNum, 0);</div><div class="line">    &#125; catch (RemoteException e) &#123;</div><div class="line">        // System dead, we will be dead too soon!</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续查看ActivityManagerNative.getDefault(),实际上是关乎到Singleton<iactivitymanager>类型的gDefault对象创建；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">static public IActivityManager getDefault() &#123;</div><div class="line">    return gDefault.get();</div><div class="line">&#125;</div><div class="line"></div><div class="line">private static final Singleton&lt;IActivityManager&gt; gDefault = new Singleton&lt;IActivityManager&gt;() &#123;</div><div class="line">    protected IActivityManager create() &#123;</div><div class="line">        IBinder b = ServiceManager.getService(&quot;activity&quot;);</div><div class="line">        if (false) &#123;</div><div class="line">            Log.v(&quot;ActivityManager&quot;, &quot;default service binder = &quot; + b);</div><div class="line">        &#125;</div><div class="line">        IActivityManager am = asInterface(b);</div><div class="line">        if (false) &#123;</div><div class="line">            Log.v(&quot;ActivityManager&quot;, &quot;default service = &quot; + am);</div><div class="line">        &#125;</div><div class="line">        return am;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></iactivitymanager></p>
<p>ServiceManager.getService(“activity”);获取系统的“activity”的Service,所有的Service都是注册到ServiceManager进行统一管理。</p>
<p>这样就创建了一个对ActivityManagerService实例的本地代理对象ActivityManagerProxy实例。Singleton是通用的单例模板类。</p>
<p>ActivityManagerNative.getDefault就返回一个此代理对象的公共接口IActivityManager类型，就可以在本地调用远程对象的操作方法。</p>
<h4 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h4><p>执行过程就涉及到ActivityManager框架的执行流程</p>
<p><img src="/assets/img/pattern-proxy/ActivityManagerService.jpg" alt="image"></p>
<p>此图表明整个Client对Service的访问是通过Service的代理对象Proxy进行访问的。</p>
<p>Android中对Service访问的模式都是以Client/Server模式进行；</p>
<p>Client实际上访问Service是通过对Service的建立代理的Proxy对象进行访问的——代理模式。</p>
<p>此处也可以看到如果ActivityManager相关的Remote端的Service组件可以任意进行改变替换，依然不会影响到Local端的使用。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/21/pattern-proxy/" data-id="cje6pjw2l005dweyxcb3gfx23" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/设计模式/">设计模式</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-pattern-decorator" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/20/pattern-decorator/" class="article-date">
  <time datetime="2016-12-20T11:19:47.000Z" itemprop="datePublished">2016-12-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/设计模式/">设计模式</a>►<a class="article-category-link" href="/categories/设计模式/Java/">Java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/20/pattern-decorator/">Android中的设计模式之装饰者模式</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>装饰模式又名包装(Wrapper)模式。装饰模式以对客户端透明的方式扩展对象的功能，是继承关系的一个替代方案。</p>
<p>装饰模式以对客户透明的方式动态地给一个对象附加上更多的责任。换言之，客户端并不会觉得对象在装饰前和装饰后有什么不同。装饰模式可以在不使用创造更多子类的情况下，将对象的功能加以扩展。<br><img src="/assets/img/pattern-decorator/decorator.png" alt="image"><br>　在装饰模式中的角色有：</p>
<p>　　●　　抽象构件(Component)角色：给出一个抽象接口，以规范准备接收附加责任的对象。</p>
<p>　　●　　具体构件(ConcreteComponent)角色：定义一个将要接收附加责任的类。</p>
<p>　　●　　装饰(Decorator)角色：持有一个构件(Component)对象的实例，并定义一个与抽象构件接口一致的接口。</p>
<p>　　●　　具体装饰(ConcreteDecorator)角色：负责给构件对象“贴上”附加的责任。</p>
<p><a href="http://www.cnblogs.com/java-my-life/archive/2012/04/20/2455726.html" target="_blank" rel="external">java中的装饰模式</a></p>
<h2 id="装饰者模式的优点"><a href="#装饰者模式的优点" class="headerlink" title="装饰者模式的优点"></a>装饰者模式的优点</h2><p>装饰者模式实现的是从一个对象外部给对象添加功能，相当于改变了对象的外观，装饰过的对象，从外部系统来看已经不再是原来的对象，而是经过一系列装饰器装饰过的对象。<br>装饰者模式最大的好处就是灵活，它能够灵活的改变一个的对象的功能，并且是动态组合形式。另外好处就是代码复用，因为每个装饰器是独立的，可以给一个对象多次增加同一个装饰器，也可以同一个装饰器装饰不同对象。<br>在面向对象设计中：有一条基本规则</p>
<p>尽量使用对象组合，而不是对象继承来扩展和复用功能。</p>
<p>另外说明：</p>
<p>各个装饰器之间最好是完全独立的功能，不要依赖，这样在进行装饰组合的时候，才没有先后调用限制。否则会降低装饰器组合的灵活性。</p>
<p>装饰器模式的退化形式：<br>当仅仅只是添加一个功能，就没有必要再设计装饰器的抽象父类，直接在装饰器中实现组件接口，然后实现相应的拓展功能。</p>
<h2 id="一个例子理解装饰者模式"><a href="#一个例子理解装饰者模式" class="headerlink" title="一个例子理解装饰者模式"></a>一个例子理解装饰者模式</h2><p><a href="http://www.2cto.com/kf/201512/455764.html" target="_blank" rel="external">一个例子理解装饰者模式</a></p>
<h2 id="Android中的装饰者模式"><a href="#Android中的装饰者模式" class="headerlink" title="Android中的装饰者模式"></a>Android中的装饰者模式</h2><p>Android中的装饰者模式，最经典的就是由Context抽象类扩展出的ContextWrapper的设计。<br><img src="/assets/img/pattern-decorator/context.png" alt="image"></p>
<ol>
<li>Context就是抽象构件，它提供了应用运行的基本环境，是各组件和系统服务通信的桥梁，隐藏了应用与系统服务通信的细节，简化了上层应用的开发。所以Contex就是“装饰模式”里的Component。</li>
<li><p>Context类是个抽象类，android.app.ContextImpl派生实现了它的抽象接口。ContextImpl对象会与Android框架层的各个服务（包括组件管理服务、资源管理服务、安装管理服务等）建立远程连接，通过对Android进程间的通信机制（IPC）和这些服务进行通信。所以ContextImpl就是“装饰模式”里的ConcreteComponent。</p>
</li>
<li><p>如果上层应用期望改变Context接口的实现，就需要使用android.content.ContextWrapper类，它派生自Context，其中具体实现都是通过组合的方式调用ContextImpl类的实例（在ContextWrapper中的private属性mBase）来完成的。这样的设计，使得ContextImpl与ContextWrapper子类的实现可以单独变化，彼此独立。所以可以看出ContextWrapper就是“装饰模式”里的Decorator。</p>
</li>
<li><p>Android的界面组件Activity、服务组件Service以及应用基类Application都派生于ContextWrapper，它们可以通过重载来修改Context接口的实现。所以可以看出Activity、服务组件Service以及应用基类Application就是“装饰模式”里的具体装饰角色A、B、C。</p>
</li>
</ol>
<p><a href="http://blog.csdn.net/card361401376/article/details/51222351" target="_blank" rel="external">设计模式-装饰者模式（Decorator）理解和在Android中的应用</a></p>
<p>详细的代码分析可以参考<a href="http://www.cnblogs.com/yemeishu/archive/2012/12/30/2839489.html" target="_blank" rel="external">Android源码学习之装饰模式应用</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/20/pattern-decorator/" data-id="cje6pjw28004pweyxxl7qjrjq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/设计模式/">设计模式</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-activity-launch-mode" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/13/activity-launch-mode/" class="article-date">
  <time datetime="2016-12-13T10:30:14.000Z" itemprop="datePublished">2016-12-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>►<a class="article-category-link" href="/categories/Android/Android-everyday/">Android_everyday</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/13/activity-launch-mode/">activity启动模式</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="任务栈与启动模式"><a href="#任务栈与启动模式" class="headerlink" title="任务栈与启动模式"></a>任务栈与启动模式</h2><p>指定一个Activity的任务栈模式，也就是启动模式。<br>任务栈有以下四种：</p>
<ul>
<li>standard 标准模式，默认使用该模式</li>
<li>singletop 单一顶部模式 （如果当前activity就在栈顶，就不新建）</li>
<li>singleTask 单一任务栈，干掉头上的其他Activity，自己变成栈顶</li>
<li>singleInstance 单一实例(单例)，任务栈里面只有自己</li>
</ul>
<h2 id="两种指定任务栈的方式"><a href="#两种指定任务栈的方式" class="headerlink" title="两种指定任务栈的方式"></a>两种指定任务栈的方式</h2><h3 id="manifest中指定"><a href="#manifest中指定" class="headerlink" title="manifest中指定"></a>manifest中指定</h3><p>使用manifest里面的Activity的launchMode属性来制定启动模式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">android:name=&quot;.MainActivity&quot;</div><div class="line">android:launchMode=&quot;standard&quot;</div></pre></td></tr></table></figure></p>
<h3 id="代码中指定intent-addFlag"><a href="#代码中指定intent-addFlag" class="headerlink" title="代码中指定intent.addFlag"></a>代码中指定intent.addFlag</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Intent intent  = new Intent();</div><div class="line">intent.setClass(FirstActivity.this,SecondActivity.class);</div><div class="line">// 通过Intent的addFlag指定</div><div class="line">intent.addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP);</div><div class="line">startActivity(intent);</div></pre></td></tr></table></figure>
<h3 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h3><ol>
<li>代码中指定的优先级更高</li>
<li>manifest无法设定 FLAG_ACTIVITY_CLEAR_TOP 标识</li>
<li>代码指定无法指定为 singleInstance启动模式</li>
</ol>
<h2 id="启动模式详解"><a href="#启动模式详解" class="headerlink" title="启动模式详解"></a>启动模式详解</h2><h3 id="standard-标准模式-默认启动模式"><a href="#standard-标准模式-默认启动模式" class="headerlink" title="standard 标准模式 默认启动模式"></a>standard 标准模式 默认启动模式</h3><p>每开启一个Activity，就会在栈顶添加一个Activity实例。多次间隔或者直接启动一个甲Activity会添加多个甲的示例，可重复添加。（间隔 ABA, 直接 ACC或者AAA）</p>
<h3 id="singletop-单一顶部模式"><a href="#singletop-单一顶部模式" class="headerlink" title="singletop 单一顶部模式"></a>singletop 单一顶部模式</h3><p>如果开启的Activity已经存在一个实例在任务栈的顶部（仅限于顶部）,再去开启这个Activity，任务栈不会创建新的Activity的实例了，而是复用已经存在的这个Activity，onNewIntent方法被调用；之前打开过，但不是位于栈顶，那么还是会产生新的实例入栈，不会回调onNewIntent方法。</p>
<p>当我们把一个Activity B 设置为singleTop，当我们打开B页面，会出现几种情况：</p>
<p>说明：当前A和C都是Standard，B是singleTop</p>
<ol>
<li><p>之前没打开过：<br>假设我们首先打开了A，此时任务栈S1里面只有A。然后打开singleTop的B，B入S1栈（谁打开它进入谁的栈）。此时S1的情况是BA，B为栈顶。</p>
</li>
<li><p>之前打开过，且位于栈顶：<br>复用这个栈，不会有新的实例压入栈中。同时 onNewIntent 方法会被回调，我们可以利用这个方法获得页面传过来的消息或者其他操作。</p>
</li>
<li><p>之前打开过，但是不是位于栈顶：<br>还是会产生新的实例入栈。</p>
</li>
</ol>
<h3 id="singleTask-单一任务（整个任务栈只有一个实例）"><a href="#singleTask-单一任务（整个任务栈只有一个实例）" class="headerlink" title="singleTask 单一任务（整个任务栈只有一个实例）"></a>singleTask 单一任务（整个任务栈只有一个实例）</h3><p>如果开启的Activity已经存在一个实例在任务栈S1，当再次去开启这个Activity时</p>
<ol>
<li>位于栈顶则直接复用，回调onNewIntent方法</li>
<li>位于栈中，也会复用，回调onNewIntent方法，但复用的同时会自己上方的全部Activity都干掉。</li>
</ol>
<h3 id="singleInstance-单一实例，任务栈中只存在自己"><a href="#singleInstance-单一实例，任务栈中只存在自己" class="headerlink" title="singleInstance 单一实例，任务栈中只存在自己"></a>singleInstance 单一实例，任务栈中只存在自己</h3><p>当启动一个启动模式为singleInstance的Activity时（之前没启动过），这时系统将开辟出另外一个任务栈，用于存放这个Activity，而且这个新的任务栈只能存放自身这唯一一个Activity。</p>
<p>singleInstance页面作为前台任务打开自己，则复用，任务栈顺序无变化</p>
<p>singleInstance页面作为后台任务栈，则切换成为前台任务栈，无新实例产生，复用。</p>
<p>复用就会调用onNewIntent方法。</p>
<h2 id="FLAG"><a href="#FLAG" class="headerlink" title="FLAG"></a>FLAG</h2><p>在代码中指定任务栈，其实就是在代码中执行intent.addFlag<br>在代码中指定flag可以改变activity的启动方式，且最后指定的Flag是activity最终任务栈的启动模式。</p>
<h3 id="Intent-FLAG-ACTIVITY-NEW-TASK"><a href="#Intent-FLAG-ACTIVITY-NEW-TASK" class="headerlink" title="Intent.FLAG_ACTIVITY_NEW_TASK"></a>Intent.FLAG_ACTIVITY_NEW_TASK</h3><ul>
<li>intent.FLAG_ACTIVITY_NEW_TASK单独使用并无任何效果，需要和taskAffinity一起配合着使用。</li>
<li>当和taskAffinity一起配合着使用时：Intent.FLAG_ACTIVITY_NEW_TASK + android:taskAffinity 指定非程序包名的任务栈名，与清单文件里面指定 android:launchMode=”singleInstance”效果一致 </li>
<li>这个Flag常用于在服务中启动Activity，因为服务没有Activity的任务栈，所以只能用一个新的任务栈来启动这个Activity创建实例。</li>
</ul>
<h3 id="Intent-FLAG-ACTIVITY-SINGLE-TOP"><a href="#Intent-FLAG-ACTIVITY-SINGLE-TOP" class="headerlink" title="Intent.FLAG_ACTIVITY_SINGLE_TOP"></a>Intent.FLAG_ACTIVITY_SINGLE_TOP</h3><p>与在manifest.xml中指定 android:launchMode=”singleTop”效果一致</p>
<h3 id="Intent-FLAG-ACTIVITY-NEW-TASK-1"><a href="#Intent-FLAG-ACTIVITY-NEW-TASK-1" class="headerlink" title="Intent.FLAG_ACTIVITY_NEW_TASK"></a>Intent.FLAG_ACTIVITY_NEW_TASK</h3><p>首先会查找是否存在和被启动的Activity具有相同的亲和性的任务栈（即taskAffinity，注意同一个应用程序中的activity的亲和性一样，所以下面的例子a会在同一个栈中），如果有，刚直接把这个栈整体移动到前台，并保持栈中的状态不变，即栈中的activity顺序不变，如果没有，则新建一个栈来存放被启动的activity</p>
<h4 id="例子a"><a href="#例子a" class="headerlink" title="例子a"></a>例子a</h4><p>Activity A和Activity B在同一个应用中.</p>
<p>Activity A启动开僻Task堆栈(堆栈状态: A), 在Activity A中启动Activity B, 启动Activity B的Intent的Flag设为FLAG_ACTIVITY_NEW_TASK, Activity B被压入Activity A所在堆栈(堆栈状态: AB).</p>
<p>原因是默认情况下同一个应用中的所有Activity拥有相同的关系(taskAffinity).</p>
<h4 id="例子b"><a href="#例子b" class="headerlink" title="例子b"></a>例子b</h4><p> Activity A在名称为”TaskOne应用”的应用中, Activity B和Activity C在名称为”TaskTwo应用”的应用中.</p>
<p>在Launcher中单击”TaskOne应用”图标, Activity A启动开僻Task堆栈, 命名为TaskA(TaskA堆栈状态: A),在Activity A中启动Activity B, 启动Activity C的Intent的Flag设为FLAG_ACTIVITY_NEW_TASK,Android系统会为Activity B开僻一个新的Task, 命名为TaskB(TaskB堆栈状态: B), 长按Home键, 选择TaskOne, Activity A回到前台, 再次启动Activity B（两种情况1.从桌面启动；2.从Activity A启动，两种情况一样）, 这时TaskB回到前台, Activity B显示, 供用户使用, 即:包含FLAG_ACTIVITY_NEW_TASK的Intent启动Activity的Task正在运行, 则不会为该Activity创建新的Task,而是将原有的Task返回到前台显示.</p>
<h4 id="例子c"><a href="#例子c" class="headerlink" title="例子c"></a>例子c</h4><p>Activity A在名称为”TaskOne应用”的应用中, Activity B和Activity C在名称为”TaskTwo应用”的应用中.</p>
<p>在Launcher中单击”TaskOne应用”图标, Activity A启动开僻Task堆栈, 命名为TaskA(TaskA堆栈状态: A),在Activity A中启动Activity B,启动Activity B的Intent的Flag设为FLAG_ACTIVITY_NEW_TASK, Android系统会为Activity B开僻一个新的Task, 命名为TaskB(TaskB堆栈状态: B),  在Activity B中启动Activity C(TaskB的状态: BC) 长按Home键, 选择TaskOne, Activity A回到前台, 再次启动Activity B(从桌面或者ActivityA启动，也是一样的),这时TaskB回到前台, Activity C显示,供用户使用.说明了在此种情况下设置FLAG_ACTIVITY_NEW_TASK后，会先查找是不是有Activity B存在的栈，根据亲和性(taskAffinity)，如果有，刚直接把这个栈整体移动到前台，并保持栈中的状态不变，即栈中的顺序不变</p>
<h3 id="Intent-FLAG-ACTIVITY-CLEAR-TOP"><a href="#Intent-FLAG-ACTIVITY-CLEAR-TOP" class="headerlink" title="Intent.FLAG_ACTIVITY_CLEAR_TOP"></a>Intent.FLAG_ACTIVITY_CLEAR_TOP</h3><ul>
<li>如果activity在栈中，则activity启动时，同一个任务栈里面位于它上方的activity会全部被清空。</li>
</ul>
<pre><code>例子:Activity A启动开僻Task堆栈(堆栈状态: A), 在Activity A中启动Activity B(堆栈状态: AB), 在Activity B中启动Activity C(堆栈状态: ABC), 在Activity C中启动Activity D(堆栈状态: ABCD), 在Activity D中启动Activity B,启动Activity B的Intent的Flag设置为FLAG_ACTIVITY_CLEAR_TOP, (堆栈状态: AB).
</code></pre><ul>
<li><p>如果activity在栈顶，再次打开自己（并且也设置为Intent.FLAG_ACTIVITY_CLEAR_TOP）时，会摧毁旧的，重建新的。虽然从任务栈的内容看来，没有变化，但其实对于activity的生命周期来说，已经经历了摧毁重建的过程。</p>
</li>
<li><p>这个标记位通常是和FLAG_ACTIVITY_NEW_TASK配合着使用的。在这种情况下被启动的Activty如果已经存在，那么系统就会调用它的onNewIntent方法。如果被调用的Activity使用默认的standrad模式，那么它连同它之上的Activity都要出栈，系统会创建新的实例并入栈置为栈顶。</p>
</li>
</ul>
<h3 id="Intent-FLAG-ACTIVITY-EXCLUDE-FROM-RECENTS"><a href="#Intent-FLAG-ACTIVITY-EXCLUDE-FROM-RECENTS" class="headerlink" title="Intent.FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS"></a>Intent.FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS</h3><p>具有这个标记的Activity不会出现在Activity的历史列表中.<br>他等同于在xml里面设定<br>android:excludeFromRecents=”true” </p>
<p><a href="http://www.cnblogs.com/xiaoQLu/archive/2012/07/17/2595294.html" target="_blank" rel="external">http://www.cnblogs.com/xiaoQLu/archive/2012/07/17/2595294.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/13/activity-launch-mode/" data-id="cje6pjw0q000tweyxfv15d9rx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-everyday/">Android_everyday</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-bin-tree" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/12/bin-tree/" class="article-date">
  <time datetime="2016-12-12T09:44:29.000Z" itemprop="datePublished">2016-12-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/算法/">算法</a>►<a class="article-category-link" href="/categories/算法/Java/">Java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/12/bin-tree/">二叉搜索树</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="二叉搜索树"><a href="#二叉搜索树" class="headerlink" title="二叉搜索树"></a>二叉搜索树</h2><p>二叉搜索树是满足以下条件的二叉树：1.左子树上的所有节点值均小于根节点值，2右子树上的所有节点值均不小于根节点值，3，左右子树也满足上述两个条件。</p>
<h2 id="二叉搜索树的优点"><a href="#二叉搜索树的优点" class="headerlink" title="二叉搜索树的优点"></a>二叉搜索树的优点</h2><p>二叉搜索树又叫二叉排序树。结合了两种数据结构的有点：一种是有序数组，二叉搜索树在查找数据项的速度和在有序数组中查找一样快；另一种是链表，二叉搜索树在插入数据和删除数据项的速度和链表一样。</p>
<h2 id="基本数据结构"><a href="#基本数据结构" class="headerlink" title="基本数据结构"></a>基本数据结构</h2><h3 id="节点"><a href="#节点" class="headerlink" title="节点"></a>节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public class BinTreeNode &#123;</div><div class="line">	public int data;</div><div class="line">	public BinTreeNode left;</div><div class="line">	public BinTreeNode right;</div><div class="line"></div><div class="line">	public BinTreeNode(int data)&#123;</div><div class="line">		this.data = data;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public void displayNode()&#123;</div><div class="line">		Log.d(&quot;BinTree&quot;, data+&quot; &quot;);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="树"><a href="#树" class="headerlink" title="树"></a>树</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public class BinTree &#123;</div><div class="line">	public BinTreeNode root;</div><div class="line">	</div><div class="line">	//以下变量用来在find中保存状态，这样，delete就可以直接调用find了进行待删除节点的查找工作。</div><div class="line">	public BinTreeNode current;</div><div class="line">	public BinTreeNode parent;</div><div class="line">	boolean isLeftChild;</div><div class="line">	</div><div class="line">	//各种方法</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="插入方法"><a href="#插入方法" class="headerlink" title="插入方法"></a>插入方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">public void insert(int data)&#123;</div><div class="line">	BinTreeNode node = new BinTreeNode(data);</div><div class="line">	if(root == null)&#123;</div><div class="line">		root = node;</div><div class="line">	&#125;else&#123;</div><div class="line">		BinTreeNode current = root;</div><div class="line">		BinTreeNode parent;</div><div class="line">		while(true)&#123;</div><div class="line">			parent = current;</div><div class="line">			if(data &lt; current.data)&#123;</div><div class="line">				current = current.left;</div><div class="line">				if(current == null)&#123;</div><div class="line">					parent.left = node;</div><div class="line">					return;</div><div class="line">				&#125;</div><div class="line">			&#125;else&#123;</div><div class="line">				current = current.right;</div><div class="line">				if(current == null)&#123;</div><div class="line">					parent.right = node;</div><div class="line">					return;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="中序遍历"><a href="#中序遍历" class="headerlink" title="中序遍历"></a>中序遍历</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public void displayTree(BinTreeNode root)&#123;</div><div class="line">	inOrder(root);//中序遍历</div><div class="line">&#125;</div><div class="line"></div><div class="line">public void inOrder(BinTreeNode root)&#123;</div><div class="line">	if(root != null)&#123;</div><div class="line">		inOrder(root.left);</div><div class="line">		root.displayNode();</div><div class="line">		inOrder(root.right);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="查找方法"><a href="#查找方法" class="headerlink" title="查找方法"></a>查找方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">public BinTreeNode find(int data)&#123;</div><div class="line">	current = root;</div><div class="line">	parent = root;</div><div class="line">	isLeftChild = false;</div><div class="line">	</div><div class="line">	while(current.data != data)&#123;</div><div class="line">		parent = current;</div><div class="line">		if(current.data &lt; data)&#123;</div><div class="line">			current = current.right;</div><div class="line">			isLeftChild = false;</div><div class="line">		&#125;else&#123;</div><div class="line">			current = current.left;</div><div class="line">			isLeftChild = true;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		if(current == null)</div><div class="line">			return null;</div><div class="line">	&#125;</div><div class="line">	return current;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="删除方法"><a href="#删除方法" class="headerlink" title="删除方法"></a>删除方法</h2><h3 id="如果删除节点是一个叶子节点"><a href="#如果删除节点是一个叶子节点" class="headerlink" title="如果删除节点是一个叶子节点"></a>如果删除节点是一个叶子节点</h3><p>这种情况最简单，直接删除这个节点就行<br><img src="/assets/img/bin_tree/del_leaf.jpg" alt="image"></p>
<h3 id="如果删除节点只有一个子节点"><a href="#如果删除节点只有一个子节点" class="headerlink" title="如果删除节点只有一个子节点"></a>如果删除节点只有一个子节点</h3><p>这种情况，只需要把删除节点的子节点，顶替删除节点的位置<br><img src="/assets/img/bin_tree/del_one_child.jpg" alt="image"></p>
<h3 id="如果删除节点有两个子节点"><a href="#如果删除节点有两个子节点" class="headerlink" title="如果删除节点有两个子节点"></a>如果删除节点有两个子节点</h3><p>这种情况需要以下步骤</p>
<ol>
<li>找到删除节点的后续节点，也就是排序中的下一个节点，也就是所有比删除节点大的节点中，最小的那一个。这个节点，必然时删除节点的右子树中最小的那个点，它不会有左子树。</li>
<li>调整后继节点及子树的结构，让其成为一个只有右子树，且结构正确的树</li>
<li>把删除节点的左子树变成后继节点的左子树</li>
<li>让后继节点取代删除节点的位置<br><img src="/assets/img/bin_tree/del_two_child.jpg" alt="image"></li>
</ol>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line">public void delete(int data)&#123;</div><div class="line">		//首先找到这个删除结点，在这个过程中，会更新current，parent，isLeftChild三个全局变量</div><div class="line">		find(data);</div><div class="line">		</div><div class="line">		//找到删除结点后，要分三种情况：</div><div class="line">		if(current != null)&#123;</div><div class="line">			//1.删除节点是叶子节点，直接删掉</div><div class="line">			if(current.left == null &amp;&amp; current.right == null)&#123;</div><div class="line">				if(current == root)&#123;</div><div class="line">					root = null;</div><div class="line">				&#125;else&#123;</div><div class="line">					if(isLeftChild)&#123;</div><div class="line">						parent.left = null;</div><div class="line">					&#125;else&#123;</div><div class="line">						parent.right = null;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">			//2.删除节点只有一个子节点（只有左子节点，或者只有右子节点）</div><div class="line">			else if(current.right == null)&#123;</div><div class="line">				//只有左子节点</div><div class="line">				if(current == root)&#123;</div><div class="line">					root = current.left;</div><div class="line">				&#125;else if(isLeftChild)&#123;</div><div class="line">					parent.left = current.left;</div><div class="line">				&#125;else&#123;</div><div class="line">					parent.right = current.left;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			else if(current.left == null)&#123;</div><div class="line">				//只有右子节点</div><div class="line">				if(current == root)&#123;</div><div class="line">					root = current.right;</div><div class="line">				&#125;else if(isLeftChild)&#123;</div><div class="line">					parent.left = current.right;</div><div class="line">				&#125;else&#123;</div><div class="line">					parent.right = current.right;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">			//3.左右子节点都有</div><div class="line">			//首先要找到它的后继节点，也就是中序的下一节点</div><div class="line">			else&#123;</div><div class="line">				BinTreeNode successor = getSuccessor(current);</div><div class="line">				successor.left = current.left;</div><div class="line">				if(current == root)&#123;</div><div class="line">					root = successor;</div><div class="line">				&#125;</div><div class="line">				//把删除节点的左子树变成后继节点的左子树</div><div class="line">				//并且让后继节点取代删除节点的位置</div><div class="line">				else if(isLeftChild)&#123;</div><div class="line">					parent.left = successor;</div><div class="line">				&#125;else&#123;</div><div class="line">					parent.right = successor;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public BinTreeNode getSuccessor(BinTreeNode delNode) &#123;</div><div class="line">		// 这个函数用来给有右子树的节点寻找后继节点。</div><div class="line">		// 可以想象，这个后继节点必然是删除节点的右子树中，最左最下的那个孩子</div><div class="line">		// 也就是说，这个后继节点必然没有左子节点</div><div class="line">		// 此外还负责调整树的结构，使后继节点成为一个只有右子树的，排序结构正确的树</div><div class="line">		BinTreeNode successorParent = delNode;</div><div class="line">		BinTreeNode successor = delNode;</div><div class="line">		BinTreeNode current = delNode.right;</div><div class="line">		</div><div class="line">		while(current != null)&#123;</div><div class="line">			successorParent = successor;</div><div class="line">			successor = current;</div><div class="line">			current = current.left;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		if(successor != delNode.right)&#123;</div><div class="line">			successorParent.left = successor.right;</div><div class="line">			successor.right = delNode.right;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		return successor;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h2 id="项目代码"><a href="#项目代码" class="headerlink" title="项目代码"></a>项目代码</h2><p>该项目作为SearchAndSort的一个组成部分。<br><a href="https://github.com/IChrisKing/SortAndFind" target="_blank" rel="external">SortAndFind</a><br><code>git@github.com:IChrisKing/SortAndFind.git</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/12/bin-tree/" data-id="cje6pjw0y001gweyx4birpmln" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/排序算法/">排序算法</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据结构/">数据结构</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/查找算法/">查找算法</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/算法/">算法</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-pattern-builder" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/29/pattern-builder/" class="article-date">
  <time datetime="2016-11-29T11:28:20.000Z" itemprop="datePublished">2016-11-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/设计模式/">设计模式</a>►<a class="article-category-link" href="/categories/设计模式/Java/">Java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/29/pattern-builder/">Android中的设计模式之建造模式</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>   建造模式是对象的创建模式。建造模式可以将一个产品的内部表象（internal representation）与产品的生产过程分割开来，从而可以使一个建造过程生成具有不同的内部表象的产品对象。</p>
<h3 id="产品的内部表象"><a href="#产品的内部表象" class="headerlink" title="产品的内部表象"></a>产品的内部表象</h3><p>   一个产品常有不同的组成成分作为产品的零件，这些零件有可能是对象，也有可能不是对象，它们通常又叫做产品的内部表象（internal representation）。不同的产品可以有不同的内部表象，也就是不同的零件。使用建造模式可以使客户端不需要知道所生成的产品有哪些零件，每个产品的对应零件彼此有何不同，是怎么建造出来的，以及怎么组成产品。</p>
<h3 id="对象性质的建造"><a href="#对象性质的建造" class="headerlink" title="对象性质的建造"></a>对象性质的建造</h3><p>　　有些情况下，一个对象会有一些重要的性质，在它们没有恰当的值之前，对象不能作为一个完整的产品使用。比如，一个电子邮件有发件人地址、收件人地址、主题、内容、附录等部分，而在最起码的收件人地址得到赋值之前，这个电子邮件不能发送。</p>
<p>　　有些情况下，一个对象的一些性质必须按照某个顺序赋值才有意义。在某个性质没有赋值之前，另一个性质则无法赋值。这些情况使得性质本身的建造涉及到复杂的商业逻辑。这时候，此对象相当于一个有待建造的产品，而对象的这些性质相当于产品的零件，建造产品的过程是建造零件的过程。由于建造零件的过程很复杂，因此，这些零件的建造过程往往被“外部化”到另一个称做建造者的对象里，建造者对象返还给客户端的是一个全部零件都建造完毕的产品对象。</p>
<p>　　建造模式利用一个导演者对象和具体建造者对象一个个地建造出所有的零件，从而建造出完整的产品对象。建造者模式将产品的结构和产品的零件的建造过程对客户端隐藏起来，把对建造过程进行指挥的责任和具体建造者零件的责任分割开来，达到责任划分和封装的目的。　</p>
<h3 id="建造模式的结构"><a href="#建造模式的结构" class="headerlink" title="建造模式的结构"></a>建造模式的结构</h3><p><a href="http://www.cnblogs.com/java-my-life/archive/2012/04/07/2433939.html" target="_blank" rel="external">源代码</a></p>
<p><img src="/assets/img/builder_pattern/builder.png" alt="image"></p>
<p>　　在这个示意性的系统里，最终产品Product只有两个零件，即part1和part2。相应的建造方法也有两个：buildPart1()和buildPart2()、同时可以看出本模式涉及到四个角色，它们分别是：</p>
<p>　　抽象建造者（Builder）角色：给 出一个抽象接口，以规范产品对象的各个组成成分的建造。一般而言，此接口独立于应用程序的商业逻辑。模式中直接创建产品对象的是具体建造者 (ConcreteBuilder)角色。具体建造者类必须实现这个接口所要求的两种方法：一种是建造方法(buildPart1和 buildPart2)，另一种是返还结构方法(retrieveResult)。一般来说，产品所包含的零件数目与建造方法的数目相符。换言之，有多少 零件，就有多少相应的建造方法。</p>
<p>　　具体建造者（ConcreteBuilder）角色：担任这个角色的是与应用程序紧密相关的一些类，它们在应用程序调用下创建产品的实例。这个角色要完成的任务包括：1.实现抽象建造者Builder所声明的接口，给出一步一步地完成创建产品实例的操作。2.在建造过程完成后，提供产品的实例。</p>
<p>　　导演者（Director）角色：担任这个角色的类调用具体建造者角色以创建产品对象。应当指出的是，导演者角色并没有产品类的具体知识，真正拥有产品类的具体知识的是具体建造者角色。</p>
<p>　　产品（Product）角色：产品便是建造中的复杂对象。一般来说，一个系统中会有多于一个的产品类，而且这些产品类并不一定有共同的接口，而完全可以是不相关联的。</p>
<p>　　</p>
<p>　　导演者角色是与客户端打交道的角色。导演者将客户端创建产品的请求划分为对各个零件的建造请求，再将这些请求委派给具体建造者角色。具体建造者角色是做具体建造工作的，但是却不为客户端所知。</p>
<p>　　一般来说，每有一个产品类，就有一个相应的具体建造者类。这些产品应当有一样数目的零件，而每有一个零件就相应地在所有的建造者角色里有一个建造方法。</p>
<p><strong> 建造模式分成两个很重要的部分： </strong></p>
<p>　　1. 一个部分是Builder接口，这里是定义了如何构建各个部件，也就是知道每个部件功能如何实现，以及如何装配这些部件到产品中去；</p>
<p>　　2. 另外一个部分是Director，Director是知道如何组合来构建产品，也就是说Director负责整体的构建算法，而且通常是分步骤地来执行。</p>
<p>　　不管如何变化，建造模式都存在这么两个部分，一个部分是部件构造和产品装配，另一个部分是整体构建的算法。认识这点是很重要的，因为在建造模式中，强调的是固定整体构建的算法，而灵活扩展和切换部件的具体构造和产品装配的方式。</p>
<p>　　再直白点说，建造模式的重心在于分离构建算法和具体的构造实现，从而使得构建算法可以重用。具体的构造实现可以很方便地扩展和切换，从而可以灵活地组合来构造出不同的产品对象。</p>
<h3 id="建造模式的优点"><a href="#建造模式的优点" class="headerlink" title="建造模式的优点"></a>建造模式的优点</h3><ol>
<li>客户端不必知道产品内部组成的细节。</li>
</ol>
<p>2.具体的建造者类之间是相互独立的，对系统的扩展非常有利。</p>
<p>3.由于具体的建造者是独立的，因此可以对建造过程逐步细化，而不对其他的模块产生任何影响。</p>
<h3 id="在什么情况下使用建造模式"><a href="#在什么情况下使用建造模式" class="headerlink" title="在什么情况下使用建造模式"></a>在什么情况下使用建造模式</h3><p>　　1. 需要生成的产品对象有复杂的内部结构，每一个内部成分本身可以是对象，也可以仅仅是一个对象（即产品对象）的一个组成部分。</p>
<p>　　2. 需要生成的产品对象的属性相互依赖。建造模式可以强制实行一种分步骤进行的建造过程，因此，如果产品对象的一个属性必须在另一个属性被赋值之后才可以被赋值，使用建造模式是一个很好的设计思想。</p>
<p>　　3. 在对象创建过程中会使用到系统中的其他一些对象，这些对象在产品对象的创建过程中不易得到。</p>
<h2 id="Android中的建造模式"><a href="#Android中的建造模式" class="headerlink" title="Android中的建造模式"></a>Android中的建造模式</h2><p>Android中的dialog就使用了builder模式，以AlertDialog为例。</p>
<p>上面说到builder模式必备的两个元素：builder接口和Director。</p>
<p>AlertDialog的Builder是一个静态内部类，没有定义Builder的抽象接口。对AlertDialog设置的属性会保存在Build类的成员变量P（AlertController.AlertParams）中。查看Builder中的部分接口：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public Builder setTitle(CharSequence title) &#123;</div><div class="line">            P.mTitle = title;</div><div class="line">            return this;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public Builder setCustomTitle(View customTitleView) &#123;</div><div class="line">            P.mCustomTitleView = customTitleView;</div><div class="line">            return this;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public Builder setMessage(@StringRes int messageId) &#123;</div><div class="line">            P.mMessage = P.mContext.getText(messageId);</div><div class="line">            return this;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>而show方法充当Director，会返回一个综合了所有设置的dialog实例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">public AlertDialog create() &#123;</div><div class="line">           // Context has already been wrapped with the appropriate theme.</div><div class="line">           final AlertDialog dialog = new AlertDialog(P.mContext, 0, false);</div><div class="line">           P.apply(dialog.mAlert);</div><div class="line">           dialog.setCancelable(P.mCancelable);</div><div class="line">           if (P.mCancelable) &#123;</div><div class="line">               dialog.setCanceledOnTouchOutside(true);</div><div class="line">           &#125;</div><div class="line">           dialog.setOnCancelListener(P.mOnCancelListener);</div><div class="line">           dialog.setOnDismissListener(P.mOnDismissListener);</div><div class="line">           if (P.mOnKeyListener != null) &#123;</div><div class="line">               dialog.setOnKeyListener(P.mOnKeyListener);</div><div class="line">           &#125;</div><div class="line">           return dialog;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       public AlertDialog show() &#123;</div><div class="line">           final AlertDialog dialog = create();</div><div class="line">           dialog.show();</div><div class="line">           return dialog;</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<p>一个简单的构造例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">new AlertDialog.Builder(context)</div><div class="line"> .setTitle(&quot;标题&quot;) </div><div class="line"> .setMessage(&quot;消息框&quot;)</div><div class="line"> .setPositiveButton(&quot;确定&quot;, null)</div><div class="line"> .show();</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/11/29/pattern-builder/" data-id="cje6pjw26004hweyxgu1zuzth" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/设计模式/">设计模式</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/3/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/Android-everyday/">Android_everyday</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/Android开发工程师/">Android开发工程师</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/AndroidRom/">AndroidRom</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Anrom/">Anrom</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Anrom/rom7-0/">rom7.0</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Android开发工程师/">Android开发工程师</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SEAndroid/">SEAndroid</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/cjdns/">cjdns</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/cjdns/cjdns源码分析/">cjdns源码分析</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/cjdns-cjdns源码分析/">cjdns - cjdns源码分析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/music/">music</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/net/">net</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/net/iptables/">iptables</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/树莓派/">树莓派</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/树莓派/配置/">配置</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/算法/Java/">Java</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/Java/">Java</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android-everyday/">Android_everyday</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android开发工程师/">Android开发工程师</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Anrom/">Anrom</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C-C/">C/C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SEAndroid/">SEAndroid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SELinux/">SELinux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cjdns/">cjdns</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cjdns源码分析/">cjdns源码分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iptables/">iptables</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/music/">music</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raspberry配置/">raspberry配置</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rom/">rom</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shadowsocks-vps/">shadowsocks/vps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tool/">tool</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/填坑/">填坑</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/排序算法/">排序算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构/">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/查找算法/">查找算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/树莓派raspberry/">树莓派raspberry</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Android-everyday/" style="font-size: 16.67px;">Android_everyday</a> <a href="/tags/Android开发工程师/" style="font-size: 15.56px;">Android开发工程师</a> <a href="/tags/Anrom/" style="font-size: 14.44px;">Anrom</a> <a href="/tags/C-C/" style="font-size: 14.44px;">C/C++</a> <a href="/tags/Java/" style="font-size: 18.89px;">Java</a> <a href="/tags/Linux/" style="font-size: 13.33px;">Linux</a> <a href="/tags/SEAndroid/" style="font-size: 10px;">SEAndroid</a> <a href="/tags/SELinux/" style="font-size: 10px;">SELinux</a> <a href="/tags/cjdns/" style="font-size: 14.44px;">cjdns</a> <a href="/tags/cjdns源码分析/" style="font-size: 14.44px;">cjdns源码分析</a> <a href="/tags/git/" style="font-size: 11.11px;">git</a> <a href="/tags/hexo/" style="font-size: 13.33px;">hexo</a> <a href="/tags/iptables/" style="font-size: 10px;">iptables</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/music/" style="font-size: 10px;">music</a> <a href="/tags/raspberry配置/" style="font-size: 10px;">raspberry配置</a> <a href="/tags/rom/" style="font-size: 10px;">rom</a> <a href="/tags/shadowsocks-vps/" style="font-size: 10px;">shadowsocks/vps</a> <a href="/tags/tool/" style="font-size: 11.11px;">tool</a> <a href="/tags/填坑/" style="font-size: 13.33px;">填坑</a> <a href="/tags/排序算法/" style="font-size: 11.11px;">排序算法</a> <a href="/tags/数据结构/" style="font-size: 10px;">数据结构</a> <a href="/tags/查找算法/" style="font-size: 11.11px;">查找算法</a> <a href="/tags/树莓派raspberry/" style="font-size: 11.11px;">树莓派raspberry</a> <a href="/tags/算法/" style="font-size: 12.22px;">算法</a> <a href="/tags/设计模式/" style="font-size: 17.78px;">设计模式</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">March 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">February 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/01/29/cjnds-asymmetric-cryptography/">握手过程中，非对称密钥的应用</a>
          </li>
        
          <li>
            <a href="/2017/12/04/how-to-fix-rebase-still-in-progress/">如何解决报错“prior sync failed; rebase still in progress”</a>
          </li>
        
          <li>
            <a href="/2017/11/22/cjdns-3steps-lladdrsession/">使用SocketAddress来维护的EndpointsBySockaddr map机制中EndpointsBySockaddr session的建立过程</a>
          </li>
        
          <li>
            <a href="/2017/09/05/cjdns-cryptoauth/">cjdns源码分析--CryptoAuth</a>
          </li>
        
          <li>
            <a href="/2017/09/04/how-to-read-staff/">如何看懂五线谱</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Chris King<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>