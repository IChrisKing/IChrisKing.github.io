<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-Hant-TW">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="以一个使用ContentProvider的例子为切入点，根据使用过程，深入源码中分析了ContentProvider的运行原理。内容主要涉及到ContentProvider,ContentResolver,ContentObserver这三个类。">
<meta name="keywords" content="Android">
<meta property="og:type" content="article">
<meta property="og:title" content="Android中的ContentProvider,ContentResolver,ContentObserver">
<meta property="og:url" content="http://yoursite.com/2017/01/04/contentprovider/index.html">
<meta property="og:site_name" content="IChrisKing">
<meta property="og:description" content="以一个使用ContentProvider的例子为切入点，根据使用过程，深入源码中分析了ContentProvider的运行原理。内容主要涉及到ContentProvider,ContentResolver,ContentObserver这三个类。">
<meta property="og:locale" content="zh-Hant-TW">
<meta property="og:updated_time" content="2018-02-28T05:58:55.153Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android中的ContentProvider,ContentResolver,ContentObserver">
<meta name="twitter:description" content="以一个使用ContentProvider的例子为切入点，根据使用过程，深入源码中分析了ContentProvider的运行原理。内容主要涉及到ContentProvider,ContentResolver,ContentObserver这三个类。">






  <link rel="canonical" href="http://yoursite.com/2017/01/04/contentprovider/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Android中的ContentProvider,ContentResolver,ContentObserver | IChrisKing</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hant-TW">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">IChrisKing</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">#IMNOTCHRISLEE</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/04/contentprovider/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Chris King">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IChrisKing">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android中的ContentProvider,ContentResolver,ContentObserver

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-01-04 11:34:00" itemprop="dateCreated datePublished" datetime="2017-01-04T11:34:00+08:00">2017-01-04</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-02-28 13:58:55" itemprop="dateModified" datetime="2018-02-28T13:58:55+08:00">2018-02-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          
            <div class="post-description">以一个使用ContentProvider的例子为切入点，根据使用过程，深入源码中分析了ContentProvider的运行原理。内容主要涉及到ContentProvider,ContentResolver,ContentObserver这三个类。</div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="ContentProvider简介"><a href="#ContentProvider简介" class="headerlink" title="ContentProvider简介"></a>ContentProvider简介</h2><p>ContentProvider是Android四大组件之一。主要实现应用程序之间共享数据的功能，为存储和获取数据提供统一的接口。</p>
<p>Android系统本身提供了一些默认的ContentProvider，包括音频，视频，图片，通讯录等。</p>
<p>ContentProvider提供一些方法，对数据进行操作：<br>　　 query：查询<br>　　 insert：插入<br>　　 update：更新<br>　　 delete：删除<br>　　 getType：得到数据类型<br>　　 onCreate：创建数据时调用的回调函数<br>　　<br>每个ContentProvider拥有一个公开的URI，其他应用使用这个URI来进行数据获取和操作。</p>
<h2 id="URI类简介"><a href="#URI类简介" class="headerlink" title="URI类简介"></a>URI类简介</h2><p>通用资源标志符（Universal Resource Identifier, 简称”URI”）。</p>
<p>Uri代表要操作的数据，Android上可用的每种资源 - 图像、视频片段等都可以用Uri来表示。</p>
<h3 id="Android中的URI"><a href="#Android中的URI" class="headerlink" title="Android中的URI"></a>Android中的URI</h3><p>Android的Uri由以下三部分组成：</p>
<p> content://com.cj.mycontentprovider/contact</p>
<p>一：scheme<br>ContentProvider（内容提供者）的scheme已经由Android所规定，<br> scheme为：content://</p>
<p>二：主机名<br>主机名（或叫Authority）用于唯一标识这个ContentProvider，比如这里com.cj.mycontentprovider，外部调用者可以根据这个标识来找到它。</p>
<p>三：path<br>路径（path）可以用来表示我们要操作的数据，路径的构建应根据业务而定，如上面程序:</p>
<p>Android中的URI： </p>
<pre><code>所有联系人的Uri： content://contacts/people
某个联系人的Uri: content://contacts/people/5
所有图片Uri: content://media/external
某个图片的Uri：content://media/external/images/media/4
</code></pre><p>我们很经常需要解析Uri，并从Uri中获取数据。</p>
<p>Android系统提供了两个用于操作Uri的工具类，分别为UriMatcher 和ContentUris 。</p>
<h3 id="UriMatcher"><a href="#UriMatcher" class="headerlink" title="UriMatcher"></a>UriMatcher</h3><p>UriMatcher 类主要用于匹配Uri.</p>
<p>使用方法如下。</p>
<p>首先第一步，初始化：<br>UriMatcher matcher = new UriMatcher(UriMatcher.NO_MATCH);  </p>
<p>第二步注册需要的Uri:<br>matcher.addURI(“com.yfz.Lesson”, “people”, PEOPLE);<br>matcher.addURI(“com.yfz.Lesson”, “person/#”, PEOPLE_ID);  </p>
<p>第三部，与已经注册的Uri进行匹配:<br>Uri uri = Uri.parse(“content://“ + “com.yfz.Lesson” + “/people”);<br>int match = matcher.match(uri);<br>       switch (match)<br>       {<br>           case PEOPLE:<br>               return “vnd.Android.cursor.dir/people”;<br>           case PEOPLE_ID:<br>               return “vnd.android.cursor.item/people”;<br>           default:<br>               return null;<br>       }  </p>
<p>match方法匹配后会返回一个匹配码Code，即在使用注册方法addURI时传入的第三个参数。 </p>
<p>上述方法会返回”vnd.Android.cursor.dir/person”. </p>
<p>总结: </p>
<p>–常量 UriMatcher.NO_MATCH 表示不匹配任何路径的返回码</p>
<p>–# 号为通配符</p>
<p>–* 号为任意字符 </p>
<h3 id="ContentUris"><a href="#ContentUris" class="headerlink" title="ContentUris"></a>ContentUris</h3><p>ContentUris 类用于获取Uri路径后面的ID部分</p>
<p>1)为路径加上ID: withAppendedId(uri, id)</p>
<p>比如有这样一个Uri<br>Uri uri = Uri.parse(“content://com.yfz.Lesson/people”)  </p>
<p>通过withAppendedId方法，为该Uri加上ID<br>Uri resultUri = ContentUris.withAppendedId(uri, 10);<br>最后resultUri为: content://com.yfz.Lesson/people/10</p>
<p>2)从路径中获取ID: parseId(uri)</p>
<p>Uri uri = Uri.parse(“content://com.yfz.Lesson/people/10”)<br>long personid = ContentUris.parseId(uri);<br>最后personid 为 :10 </p>
<h2 id="一个使用ContentProvider的例子"><a href="#一个使用ContentProvider的例子" class="headerlink" title="一个使用ContentProvider的例子"></a>一个使用ContentProvider的例子</h2><h3 id="写提供数据的应用"><a href="#写提供数据的应用" class="headerlink" title="写提供数据的应用"></a>写提供数据的应用</h3><p>首先是MyContentProvider类，它继承自ContentProvider类，提供上面提到的六个基本方法：</p>
<p>　　 query：查询<br>　　 insert：插入<br>　　 update：更新<br>　　 delete：删除<br>　　 getType：得到数据类型<br>　　 onCreate：创建数据时调用的回调函数</p>
<p>数据的处理实际是使用SELite来实现的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">package com.cj.providerdemo2;  </span><br><span class="line">  </span><br><span class="line">import android.content.ContentProvider;  </span><br><span class="line">import android.content.ContentResolver;  </span><br><span class="line">import android.content.ContentUris;  </span><br><span class="line">import android.content.ContentValues;  </span><br><span class="line">import android.content.Context;  </span><br><span class="line">import android.content.UriMatcher;  </span><br><span class="line">import android.database.Cursor;  </span><br><span class="line">import android.database.sqlite.SQLiteDatabase;  </span><br><span class="line">import android.database.sqlite.SQLiteOpenHelper;  </span><br><span class="line">import android.net.Uri;  </span><br><span class="line">  </span><br><span class="line">public class MyContentProvider extends ContentProvider &#123;  </span><br><span class="line">    private final static int CONTACT = 1;  </span><br><span class="line">  </span><br><span class="line">    private static UriMatcher uriMatcher = new UriMatcher(UriMatcher.NO_MATCH);  </span><br><span class="line">    static &#123;  </span><br><span class="line">        uriMatcher.addURI(&quot;com.cj.mycontentprovider&quot;,&quot;contact&quot;,CONTACT);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    private MyDBHelp dbHelp;  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    public int delete(Uri uri, String selection, String[] selectionArgs) &#123;  </span><br><span class="line">        int id =0;  </span><br><span class="line">        if(uriMatcher.match(uri) == CONTACT)&#123;  </span><br><span class="line">            SQLiteDatabase database = dbHelp.getWritableDatabase();  </span><br><span class="line">            id= database.delete(&quot;contact&quot;, selection, selectionArgs);  </span><br><span class="line">            contentResolver.notifyChange(uri,null);  </span><br><span class="line">        &#125;  </span><br><span class="line">       return id;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    public String getType(Uri uri) &#123;  </span><br><span class="line">        // TODO: Implement this to handle requests for the MIME type of the data  </span><br><span class="line">        // at the given URI.  </span><br><span class="line">        throw new UnsupportedOperationException(&quot;Not yet implemented&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    public Uri insert(Uri uri, ContentValues values) &#123;  </span><br><span class="line">        Uri u = null;  </span><br><span class="line">        if(uriMatcher.match(uri) == CONTACT)&#123;  </span><br><span class="line">            SQLiteDatabase database = dbHelp.getWritableDatabase();  </span><br><span class="line">  </span><br><span class="line">            long d = database.insert(&quot;contact&quot;, &quot;_id&quot;, values);  </span><br><span class="line">            u = ContentUris.withAppendedId(uri,d);  </span><br><span class="line">            contentResolver.notifyChange(u,null);  </span><br><span class="line">        &#125;  </span><br><span class="line">        return u;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    private ContentResolver contentResolver;  </span><br><span class="line">    @Override  </span><br><span class="line">    public boolean onCreate() &#123;  </span><br><span class="line">        Context context = getContext();  </span><br><span class="line">        contentResolver = context.getContentResolver();  </span><br><span class="line">        dbHelp = new MyDBHelp(context,&quot;contact.db&quot;,null,1);  </span><br><span class="line">        return true;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    public Cursor query(Uri uri, String[] projection, String selection,  </span><br><span class="line">                        String[] selectionArgs, String sortOrder) &#123;  </span><br><span class="line">        Cursor cursor = null;  </span><br><span class="line">        if(uriMatcher.match(uri) == CONTACT)&#123;  </span><br><span class="line">            SQLiteDatabase database = dbHelp.getReadableDatabase();  </span><br><span class="line">            cursor = database.query(&quot;contact&quot;, projection, selection, selectionArgs, null, null, sortOrder);  </span><br><span class="line">            cursor.setNotificationUri(contentResolver,uri);  </span><br><span class="line">        &#125;  </span><br><span class="line">        return cursor;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    public int update(Uri uri, ContentValues values, String selection,  </span><br><span class="line">                      String[] selectionArgs) &#123;  </span><br><span class="line">        // TODO: Implement this to handle requests to update one or more rows.  </span><br><span class="line">        throw new UnsupportedOperationException(&quot;Not yet implemented&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    /** </span><br><span class="line">     * </span><br><span class="line">     */  </span><br><span class="line">    private static  class MyDBHelp extends SQLiteOpenHelper&#123;  </span><br><span class="line">  </span><br><span class="line">        public MyDBHelp(Context context, String name, SQLiteDatabase.CursorFactory factory, int version) &#123;  </span><br><span class="line">            super(context, name, factory, version);  </span><br><span class="line">  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        @Override  </span><br><span class="line">        public void onCreate(SQLiteDatabase db) &#123;  </span><br><span class="line">            String sql = &quot;create table contact(_id integer primary key autoincrement,&quot; +  </span><br><span class="line">                    &quot;name text not null,number text not null);&quot;;  </span><br><span class="line">            db.execSQL(sql);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        @Override  </span><br><span class="line">        public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) &#123;  </span><br><span class="line">            onCreate(db);  </span><br><span class="line">  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到这个类实现了ContentProvider要求的基本方法。</p>
<p>在onCreate方法中，使用了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contentResolver = context.getContentResolver();</span><br></pre></td></tr></table></figure></p>
<p>query方法中，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cursor.setNotificationUri(contentResolver,uri);</span><br></pre></td></tr></table></figure></p>
<p>在insert和delete方法中，调用了contentResolver.notifyChange(uri,null);  事实上，ContentResoler是联系ContentProvider和使用它的应用之间的纽带。使用它的应用程序，是通过ContentResoler来调用ContentProvider中的方法的。具体调用方式，后面再说。</p>
<h3 id="声明这个ContentProvider"><a href="#声明这个ContentProvider" class="headerlink" title="声明这个ContentProvider"></a>声明这个ContentProvider</h3><p>写好自己的ContentProvider类之后，需要在Manifest.xml文件中声明这个ContentProvider<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;provider</span><br><span class="line">	android:name=&quot;.MyContentProvider&quot;</span><br><span class="line">	android:authorities=&quot;com.cj.mycontentprovider&quot;</span><br><span class="line">	android:enabled=&quot;true&quot;</span><br><span class="line">	android:exported=&quot;true&quot;&gt;</span><br><span class="line">&lt;/provider&gt;</span><br></pre></td></tr></table></figure></p>
<p>我们知道，其他应用如果想要访问这个应用程序，使用MyContentProvider提供的那些方法，来获取和操作数据，需要知道对应的uri。</p>
<p>uri的三个组成部分中，scheme已经被Android固定设置为content://，而这里ContentProvider有一个属性authorities,就是uri的第二部分：主机名,为了保证唯一性,一般使用包名的方式命名。</p>
<p>剩下uri的第三部分path，上面关于UriMatcher类的使用方法中说过，使用分为三步，结合MyContentProvider类的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private static UriMatcher uriMatcher = new UriMatcher(UriMatcher.NO_MATCH);  </span><br><span class="line">static &#123;  </span><br><span class="line">    uriMatcher.addURI(&quot;com.cj.mycontentprovider&quot;,&quot;contact&quot;,CONTACT);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>  首先初始化：  <code>private static UriMatcher uriMatcher = new UriMatcher(UriMatcher.NO_MATCH);</code><br>  然后注册uri：<code>uriMatcher.addURI(&quot;com.cj.mycontentprovider&quot;,&quot;contact&quot;,CONTACT);</code><br>  最后在 增删改查的方法中进行uri匹配<code>if(uriMatcher.match(uri) == CONTACT)</code></p>
<h3 id="写使用数据的应用"><a href="#写使用数据的应用" class="headerlink" title="写使用数据的应用"></a>写使用数据的应用</h3><p>  注意，这是另一个应用了。这个应用会通过content://com.cj.mycontentprovider/contact这个uri来使用上一个应用中提供的数据。<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">  package com.cj.providerdemo1;  </span><br><span class="line">  </span><br><span class="line">import android.app.Activity;  </span><br><span class="line">import android.content.ContentResolver;  </span><br><span class="line">import android.content.Context;  </span><br><span class="line">import android.content.Intent;  </span><br><span class="line">import android.database.ContentObserver;  </span><br><span class="line">import android.database.Cursor;  </span><br><span class="line">import android.net.Uri;  </span><br><span class="line">import android.os.Bundle;  </span><br><span class="line">import android.os.Handler;  </span><br><span class="line">import android.support.v7.app.AppCompatActivity;  </span><br><span class="line">import android.view.LayoutInflater;  </span><br><span class="line">import android.view.View;  </span><br><span class="line">import android.view.ViewGroup;  </span><br><span class="line">import android.widget.AdapterView;  </span><br><span class="line">import android.widget.Button;  </span><br><span class="line">import android.widget.CursorAdapter;  </span><br><span class="line">import android.widget.ListView;  </span><br><span class="line">import android.widget.TextView;  </span><br><span class="line">  </span><br><span class="line">public class MainActivity extends AppCompatActivity &#123;  </span><br><span class="line">    private ListView lv;  </span><br><span class="line">    private Button btn;  </span><br><span class="line">    private ContentResolver resolver;  </span><br><span class="line">    private MyAdapter myAdapter;  </span><br><span class="line">    private Cursor cursor;  </span><br><span class="line">    @Override  </span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;  </span><br><span class="line">        super.onCreate(savedInstanceState);  </span><br><span class="line">        setContentView(R.layout.activity_main);  </span><br><span class="line">        lv = (ListView) findViewById(R.id.lv);  </span><br><span class="line">        btn = (Button) findViewById(R.id.btn);  </span><br><span class="line">        resolver = getContentResolver();  </span><br><span class="line">        cursor = resolver.query(Uri.parse(&quot;content://com.cj.mycontentprovider/contact&quot;), null, null,  </span><br><span class="line">                null, null);  </span><br><span class="line">            myAdapter = new MyAdapter(this,cursor);  </span><br><span class="line">            lv.setAdapter(myAdapter);  </span><br><span class="line">        btn.setOnClickListener(new View.OnClickListener() &#123;  </span><br><span class="line">            @Override  </span><br><span class="line">            public void onClick(View v) &#123;  </span><br><span class="line">                MainActivity.this.startActivityForResult(new Intent(MainActivity.this,AddActivity.class),  </span><br><span class="line">                        1);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">        String[] s = new String[2];  </span><br><span class="line">        lv.setOnItemClickListener(new AdapterView.OnItemClickListener() &#123;  </span><br><span class="line">            @Override  </span><br><span class="line">            public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) &#123;  </span><br><span class="line">                resolver.delete(Uri.parse(&quot;content://com.cj.mycontentprovider/contact&quot;),  </span><br><span class="line">                null,null);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">        resolver.registerContentObserver(Uri.parse(&quot;content://com.cj.mycontentprovider/contact&quot;),  </span><br><span class="line">                true,new MyContentObserver(new Handler()));  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    protected void onActivityResult(int requestCode, int resultCode, Intent data) &#123;  </span><br><span class="line">        super.onActivityResult(requestCode, resultCode, data);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    private class MyContentObserver extends ContentObserver&#123;  </span><br><span class="line">  </span><br><span class="line">        /** </span><br><span class="line">         * Creates a content observer. </span><br><span class="line">         * </span><br><span class="line">         * @param handler The handler to run &#123;@link #onChange&#125; on, or null if none. </span><br><span class="line">         */  </span><br><span class="line">        public MyContentObserver(Handler handler) &#123;  </span><br><span class="line">            super(handler);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        @Override  </span><br><span class="line">        public void onChange(boolean selfChange) &#123;  </span><br><span class="line">            myAdapter.notifyDataSetChanged();  </span><br><span class="line">  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    private static class MyAdapter extends CursorAdapter&#123;  </span><br><span class="line">        private Cursor cursor;  </span><br><span class="line">        private Context context;  </span><br><span class="line">        public MyAdapter(Context context, Cursor c) &#123;  </span><br><span class="line">            super(context, c);  </span><br><span class="line">            this.context = context;  </span><br><span class="line">            this.cursor = c;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        @Override  </span><br><span class="line">        public View newView(Context context, Cursor cursor, ViewGroup parent) &#123;  </span><br><span class="line">            LayoutInflater layoutInflater = LayoutInflater.from(context);  </span><br><span class="line">            View view = layoutInflater.inflate(R.layout.item, null);  </span><br><span class="line">            if(cursor !=null)&#123;  </span><br><span class="line">                view.setTag(cursor.getInt(cursor.getColumnIndex(&quot;_id&quot;)));  </span><br><span class="line">            &#125;  </span><br><span class="line">            return view;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        @Override  </span><br><span class="line">        public void bindView(View view, Context context, Cursor cursor) &#123;  </span><br><span class="line">            TextView name = (TextView) view.findViewById(R.id.tv_name);  </span><br><span class="line">            TextView num = (TextView) view.findViewById(R.id.tv_num);  </span><br><span class="line">            if(cursor !=null)&#123;  </span><br><span class="line">                name.setText(cursor.getString(cursor.getColumnIndex(&quot;name&quot;)));  </span><br><span class="line">                num.setText(cursor.getString(cursor.getColumnIndex(&quot;number&quot;)));  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        @Override  </span><br><span class="line">        public long getItemId(int position) &#123;  </span><br><span class="line">            return super.getItemId(position);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">package com.cj.providerdemo1;  </span><br><span class="line">  </span><br><span class="line">import android.app.Activity;  </span><br><span class="line">import android.content.ContentValues;  </span><br><span class="line">import android.net.Uri;  </span><br><span class="line">import android.support.v7.app.AppCompatActivity;  </span><br><span class="line">import android.os.Bundle;  </span><br><span class="line">import android.view.View;  </span><br><span class="line">import android.widget.EditText;  </span><br><span class="line">import android.widget.Toast;  </span><br><span class="line">  </span><br><span class="line">public class AddActivity extends AppCompatActivity &#123;  </span><br><span class="line">    private EditText et_name;  </span><br><span class="line">    private EditText et_num;  </span><br><span class="line">    @Override  </span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;  </span><br><span class="line">        super.onCreate(savedInstanceState);  </span><br><span class="line">        setContentView(R.layout.activity_add);  </span><br><span class="line">        et_name = (EditText) findViewById(R.id.et_name);  </span><br><span class="line">        et_num = (EditText) findViewById(R.id.et_num);  </span><br><span class="line">    &#125;  </span><br><span class="line">    public void add(View view)&#123;  </span><br><span class="line">        String name = et_name.getText().toString();  </span><br><span class="line">        String num = et_num.getText().toString();  </span><br><span class="line">        if(name == null || num == null)&#123;  </span><br><span class="line">            Toast.makeText(this,&quot;姓名和号码不能为空&quot;,Toast.LENGTH_SHORT).show();  </span><br><span class="line">        &#125;else &#123;  </span><br><span class="line">            ContentValues contentValues = new ContentValues();  </span><br><span class="line">            contentValues.put(&quot;name&quot;,name);  </span><br><span class="line">            contentValues.put(&quot;number&quot;,num);  </span><br><span class="line">            getContentResolver().insert(Uri.parse(&quot;content://com.cj.mycontentprovider/contact&quot;),contentValues);  </span><br><span class="line">            setResult(Activity.RESULT_OK);  </span><br><span class="line">            finish();  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个应用主要提供两个功能：1.查询数据并显示。2.新增数据并显示。都是使用ContentResolver，通过uri来使用第一个应用程序中的方法来实现的。</p>
<p>首先，获取ContentResolver<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resolver = getContentResolver();</span><br></pre></td></tr></table></figure></p>
<p>然后通过query方法来获得数据。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cursor = resolver.query(Uri.parse(&quot;content://com.cj.mycontentprovider/contact&quot;), null, null,  </span><br><span class="line">               null, null);</span><br></pre></td></tr></table></figure></p>
<p>然而resolver是如何最终调用到我们的MyContentProvider中的query方法的呢？下面深入源码来分析这个过程。</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="获取ContentResoler对象"><a href="#获取ContentResoler对象" class="headerlink" title="获取ContentResoler对象"></a>获取ContentResoler对象</h3><p>一切都从getContentResoler()这个方法开始。<br>framerwork/base/core/java/android/content/ContextWrapper.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public ContentResolver getContentResolver() &#123;</span><br><span class="line">    return mBase.getContentResolver();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> mBase变量是ContextImpl类型,是在创建activity的时候,new 一个ContextImpl对象,赋值给activity的.</p>
<p> frameworks/base/core/java/android/app/ContextImpl.java<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> @Override</span><br><span class="line">public ContentResolver getContentResolver() &#123;</span><br><span class="line">    return mContentResolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 这里直接返回了ContextImpl对象的成员变量mContentResolver;这个变量是在APP启动的时候赋值的<br> frameworks/base/core/java/android/app/ActivityThread.java<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;  </span><br><span class="line">      ....  </span><br><span class="line"> </span><br><span class="line">      Activity activity = null;  </span><br><span class="line">    ...  </span><br><span class="line">      &#125;  </span><br><span class="line"> </span><br><span class="line">      try &#123;  </span><br><span class="line">      ...  </span><br><span class="line">          if (activity != null) &#123;  </span><br><span class="line">              Context appContext = createBaseContextForActivity(r, activity);//创建contextimpl的地方  </span><br><span class="line">              CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());  </span><br><span class="line">              Configuration config = new Configuration(mCompatConfiguration);  </span><br><span class="line">              if (DEBUG_CONFIGURATION) Slog.v(TAG, &quot;Launching activity &quot;  </span><br><span class="line">                      + r.activityInfo.name + &quot; with config &quot; + config);  </span><br><span class="line">              activity.attach(appContext, this, getInstrumentation(), r.token,  </span><br><span class="line">                      r.ident, app, r.intent, r.activityInfo, title, r.parent,  </span><br><span class="line">                      r.embeddedID, r.lastNonConfigurationInstances, config);//这里将创建的contextimpl对象传给activity内部mBase变量  </span><br><span class="line"> </span><br><span class="line">           ....  </span><br><span class="line">      return activity;  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>   通过createBaseContextForActivity()函数创建contextimpl对象,然后通过attach()函数将创建的contextimpl对象赋值给activity的内部变量,对应第一步的mBase变量。接下来，查看创建contextimpl对象的地方,看createBaseContextForActivity()函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   private Context createBaseContextForActivity(ActivityClientRecord r, final Activity activity) &#123;</span><br><span class="line">  ...</span><br><span class="line">    ContextImpl appContext = ContextImpl.createActivityContext(</span><br><span class="line">            this, r.packageInfo, displayId, r.overrideConfig);</span><br><span class="line">    appContext.setOuterContext(activity);</span><br><span class="line">    Context baseContext = appContext;</span><br><span class="line"></span><br><span class="line">    final DisplayManagerGlobal dm = DisplayManagerGlobal.getInstance();</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    if (pkgName != null &amp;&amp; !pkgName.isEmpty()</span><br><span class="line">            &amp;&amp; r.packageInfo.mPackageName.contains(pkgName)) &#123;</span><br><span class="line">        for (int id : dm.getDisplayIds()) &#123;</span><br><span class="line">            if (id != Display.DEFAULT_DISPLAY) &#123;</span><br><span class="line">                Display display =</span><br><span class="line">                        dm.getCompatibleDisplay(id, appContext.getDisplayAdjustments(id));</span><br><span class="line">                baseContext = appContext.createDisplayContext(display);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return baseContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>它调用到了ContextImpl.createActivityContext(<br>                this, r.packageInfo, displayId, r.overrideConfig);方法<br> frameworks/base/core/java/android/app/ContextImpl.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">static ContextImpl createActivityContext(ActivityThread mainThread,</span><br><span class="line">        LoadedApk packageInfo, int displayId, Configuration overrideConfiguration) &#123;</span><br><span class="line">    if (packageInfo == null) throw new IllegalArgumentException(&quot;packageInfo&quot;);</span><br><span class="line">    return new ContextImpl(null, mainThread, packageInfo, null, null, false,</span><br><span class="line">            null, overrideConfiguration, displayId, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用到ContextImpl方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private ContextImpl(ContextImpl container, ActivityThread mainThread,</span><br><span class="line">            LoadedApk packageInfo, IBinder activityToken, UserHandle user, boolean restricted,</span><br><span class="line">            Display display, Configuration overrideConfiguration, int createDisplayWithId,</span><br><span class="line">            String themePackageName) &#123;</span><br><span class="line">        ...</span><br><span class="line">        mContentResolver = new ApplicationContentResolver(this, mainThread, user);</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>无关代码全部隐去，可以看到mContentResolver就是在这里被赋值的。这样，就得到了ContentResolver对象。</p>
<h3 id="获取IContentProvider对象"><a href="#获取IContentProvider对象" class="headerlink" title="获取IContentProvider对象"></a>获取IContentProvider对象</h3><p>接下来，查看query方法。<br>frameworks/base/core/java/android/content/ContentResolver.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">public final @Nullable Cursor query(@NonNull Uri uri, @Nullable String[] projection,</span><br><span class="line">        @Nullable String selection, @Nullable String[] selectionArgs,</span><br><span class="line">        @Nullable String sortOrder) &#123;</span><br><span class="line">    android.util.SeempLog.record_uri(13, uri);</span><br><span class="line">    return query(uri, projection, selection, selectionArgs, sortOrder, null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    public final @Nullable Cursor query(final @NonNull Uri uri, @Nullable String[] projection,</span><br><span class="line">        @Nullable String selection, @Nullable String[] selectionArgs,</span><br><span class="line">        @Nullable String sortOrder, @Nullable CancellationSignal cancellationSignal) &#123;</span><br><span class="line">    ...</span><br><span class="line">    IContentProvider unstableProvider = acquireUnstableProvider(uri);</span><br><span class="line">    if (unstableProvider == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    IContentProvider stableProvider = null;</span><br><span class="line">    Cursor qCursor = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        ...</span><br><span class="line">        try &#123;</span><br><span class="line">            qCursor = unstableProvider.query(mPackageName, uri, projection,</span><br><span class="line">                    selection, selectionArgs, sortOrder, remoteCancellationSignal);//使用IContentProvider对象的query方法,最终会调用ContentProvider对象的query()方法 </span><br><span class="line">        &#125; catch (DeadObjectException e) &#123;</span><br><span class="line">            unstableProviderDied(unstableProvider);</span><br><span class="line">            stableProvider = acquireProvider(uri);</span><br><span class="line">            if (stableProvider == null) &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">            qCursor = stableProvider.query(mPackageName, uri, projection,</span><br><span class="line">                    selection, selectionArgs, sortOrder, remoteCancellationSignal);//使用IContentProvider对象的query方法,最终会调用ContentProvider对象的query()方法 </span><br><span class="line">        &#125;</span><br><span class="line">        if (qCursor == null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Force query execution.  Might fail and throw a runtime exception here.</span><br><span class="line">        qCursor.getCount();</span><br><span class="line">            ...</span><br><span class="line">        CursorWrapperInner wrapper = new CursorWrapperInner(qCursor,</span><br><span class="line">                stableProvider != null ? stableProvider : acquireProvider(uri));</span><br><span class="line">        stableProvider = null;</span><br><span class="line">        qCursor = null;</span><br><span class="line">        return wrapper;</span><br><span class="line">    &#125; catch (RemoteException e) &#123;</span><br><span class="line">            ...</span><br><span class="line">        return null;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>无论最终使用的是unstableProvider还是stableProvider，都是调用了IContentProvider对象的query方法。<br>在查看这个方法之前，先来关注一下unstableProvider和stableProvider的获取。<br>frameworks/base/core/java/android/content/ContentResolver.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public final IContentProvider acquireUnstableProvider(Uri uri) &#123;</span><br><span class="line">    if (!SCHEME_CONTENT.equals(uri.getScheme())) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    String auth = uri.getAuthority();</span><br><span class="line">    if (auth != null) &#123;</span><br><span class="line">        return acquireUnstableProvider(mContext, uri.getAuthority());</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    public final IContentProvider acquireProvider(Uri uri) &#123;</span><br><span class="line">    if (!SCHEME_CONTENT.equals(uri.getScheme())) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    final String auth = uri.getAuthority();</span><br><span class="line">    if (auth != null) &#123;</span><br><span class="line">        return acquireProvider(mContext, auth);</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这两个函数的返回值都是一个IContentProvider类型。<br>frameworks/base/core/java/android/app/ContextImpl.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected IContentProvider acquireProvider(Context context, String auth) &#123;</span><br><span class="line">    return mMainThread.acquireProvider(context,</span><br><span class="line">            ContentProvider.getAuthorityWithoutUserId(auth),</span><br><span class="line">            resolveUserIdFromAuthority(auth), true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">protected IContentProvider acquireUnstableProvider(Context c, String auth) &#123;</span><br><span class="line">    return mMainThread.acquireProvider(c,</span><br><span class="line">            ContentProvider.getAuthorityWithoutUserId(auth),</span><br><span class="line">            resolveUserIdFromAuthority(auth), false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mMainThread是一个ActivityThread类型的对象，这两个方法最终都调用了它的acquireProvider方法。其中第二个参数ContentProvider.getAuthorityWithoutUserId(auth),获得的就是在AndroidManifest.xml文件中配置的android:authorities的值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public final IContentProvider acquireProvider(</span><br><span class="line">        Context c, String auth, int userId, boolean stable) &#123;</span><br><span class="line">    final IContentProvider provider = acquireExistingProvider(c, auth, userId, stable);</span><br><span class="line">    if (provider != null) &#123;</span><br><span class="line">        return provider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IActivityManager.ContentProviderHolder holder = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        holder = ActivityManagerNative.getDefault().getContentProvider(</span><br><span class="line">                getApplicationThread(), auth, userId, stable);</span><br><span class="line">    &#125; catch (RemoteException ex) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    if (holder == null) &#123;</span><br><span class="line">        Slog.e(TAG, &quot;Failed to find provider info for &quot; + auth);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    holder = installProvider(c, holder, holder.info,</span><br><span class="line">            true /*noisy*/, holder.noReleaseNeeded, stable);</span><br><span class="line">    return holder.provider;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里就是查找ContentProvider的精髓所在。</p>
<ol>
<li>首先，acquireExistingProvider(c, auth, userId, stable);这个函数检查本地是否已经存在这个要获取的IContentProvider。本地已经存在的IContentProvider保存在ActivityThread类的mProviderMap成员变量中，以ContentProvider对应的URI的authority为键值保存。如果本地已经存在了这个IContentProvider，直接返回它。当本地没有时，进入步骤2.</li>
<li>获取ContentProviderHolder对象holder。通过ActivityManagerNative.getDefault().getContentProvider来获取holder。这其中经过Binder驱动进行进程间通信,会调用到ActivityManagerService中的getContentProvider()函数。具体过程可以查看<a href="http://blog.csdn.net/hehe26/article/details/51784355" target="_blank" rel="noopener">这篇</a>。ActivityManagerService会把所有的ContentProvider都实例化出来，并且缓存在一个map里面，所以我们就可以从ActivityManagerService远程得到一个ContentProvider对象。</li>
<li>调用installProvider将这个IContentProvider保存在本地中，以便下次要使用这个IContentProvider时，直接就可以通过getExistingProvider()函数获取。</li>
</ol>
<p>获取到这个IContentProvider对象后，query等方法的最终调用就会指向MyContentProvider类中的方法了。</p>
<h3 id="数据更新（ContentObserver）"><a href="#数据更新（ContentObserver）" class="headerlink" title="数据更新（ContentObserver）"></a>数据更新（ContentObserver）</h3><p>ContentProvider使用ContentObserver进行数据更新，其中应用到了观察者模式。<a href="https://ichrisking.github.io/2016/11/07/pattern-observer/" target="_blank" rel="noopener">Android中的设计模式之观察者模式</a><br>ContentProvider的数据更新机制划分为两个单元，第一个单元是监控数据变化的ContentObserver的注册过程，第二个单元是数据更新通知的发送过程。</p>
<h4 id="ContentObserver的注册过程"><a href="#ContentObserver的注册过程" class="headerlink" title="ContentObserver的注册过程"></a>ContentObserver的注册过程</h4><p>在第二个程序的onCreate中，使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">resolver.registerContentObserver(Uri.parse(&quot;content://com.cj.mycontentprovider/contact&quot;),  </span><br><span class="line">                true,new MyContentObserver(new Handler()));</span><br></pre></td></tr></table></figure></p>
<p>注册一个自定义的ContentObserver(MyContentObserver)来监控MyContentProvider这个Content Provider中的数据变化.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private class MyContentObserver extends ContentObserver&#123;  </span><br><span class="line"> </span><br><span class="line">       /** </span><br><span class="line">        * Creates a content observer. </span><br><span class="line">        * </span><br><span class="line">        * @param handler The handler to run &#123;@link #onChange&#125; on, or null if none. </span><br><span class="line">        */  </span><br><span class="line">       public MyContentObserver(Handler handler) &#123;  </span><br><span class="line">           super(handler);  </span><br><span class="line">       &#125;  </span><br><span class="line"> </span><br><span class="line">       @Override  </span><br><span class="line">       public void onChange(boolean selfChange) &#123;  </span><br><span class="line">           myAdapter.notifyDataSetChanged();  </span><br><span class="line"> </span><br><span class="line">       &#125;  </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>从ContentObserver继承下来的子类必须要实现onChange函数。当这个ContentObserver子类负责监控的数据发生变化时，ContentService就会调用它的onChange函数来处理，参数selfChange表示这个变化是否是由自己引起的。在这个应用程序中，MyContentObserver继承了ContentObserver类，它负责监控的URI是”content://com.cj.mycontentprovider/contact”.当以这个URI为前缀的URI对应的数据发生改变时，ContentService都会调用这个MyContentObserver类的onChange函数来处理。在MyContentObserver类的onChange函数中，执行的操作就是重新获取MyContentProvider中的数据来更新界面上的联系人信息列表。</p>
<p>在MyContentObserver类的构造函数中，有一个参数handler，它的类型为Handler，它是从MainActivity类的onCreate函数中创建并传过来的。这个handler是用来分发和处理消息用的。由于MainActivity类的onCreate函数是在应用程序的主线程中被调用的，因此，这个handler参数就是和应用程序主线程的消息循环关联在一起的。在后面我们分析数据更新通知的发送过程时，便会看到这个handler参数是如何使用的了。</p>
<p>frameworks/base/core/java/android/content/ContentResolver.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public final void registerContentObserver(@NonNull Uri uri, boolean notifyForDescendents,</span><br><span class="line">        @NonNull ContentObserver observer) &#123;</span><br><span class="line">    Preconditions.checkNotNull(uri, &quot;uri&quot;);</span><br><span class="line">    Preconditions.checkNotNull(observer, &quot;observer&quot;);</span><br><span class="line">    registerContentObserver(</span><br><span class="line">            ContentProvider.getUriWithoutUserId(uri),</span><br><span class="line">            notifyForDescendents,</span><br><span class="line">            observer,</span><br><span class="line">            ContentProvider.getUserIdFromUri(uri, UserHandle.myUserId()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/** @hide - designated user version */</span><br><span class="line">public final void registerContentObserver(Uri uri, boolean notifyForDescendents,</span><br><span class="line">        ContentObserver observer, int userHandle) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        getContentService().registerContentObserver(uri, notifyForDescendents,</span><br><span class="line">                observer.getContentObserver(), userHandle);</span><br><span class="line">    &#125; catch (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当参数notifyForDescendents为true时，表示要监控所有以uri为前缀的URI对应的数据变化。上面函数做了三件事情，一是调用getContentService函数来获得前面已经启动起来了的ContentService服务，二是调用从参数传进来的ContentObserver对象observer的getContentObserver函数来获得一个Binder对象，三是通过调用这个ContentService远程接口的registerContentObserver函数来把这个Binder对象注册到ContentService中去。</p>
<h5 id="getContentService"><a href="#getContentService" class="headerlink" title="getContentService"></a>getContentService</h5><p>frameworks/base/core/java/android/content/ContentResolver.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public static IContentService getContentService() &#123;</span><br><span class="line">    if (sContentService != null) &#123;</span><br><span class="line">        return sContentService;</span><br><span class="line">    &#125;</span><br><span class="line">    IBinder b = ServiceManager.getService(CONTENT_SERVICE_NAME);</span><br><span class="line">    ...</span><br><span class="line">    sContentService = IContentService.Stub.asInterface(b);</span><br><span class="line">    ...</span><br><span class="line">    return sContentService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 在ContentResolver类中，有一个静态成员变量sContentService，开始时它的值为null。当ContentResolver类的getContentService函数第一次被调用时，它便会通过ServiceManager类的getService函数来获得前面已经启动起来了的ContentService服务的远程接口，然后把它保存在sContentService变量中。这样，当下次ContentResolver类的getContentService函数再次被调用时，就可以直接把这个ContentService远程接口返回给调用者了</p>
<h5 id="getContentObserver"><a href="#getContentObserver" class="headerlink" title="getContentObserver"></a>getContentObserver</h5><p>frameworks/base/core/java/android/database/ContentObserver.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public IContentObserver getContentObserver() &#123;</span><br><span class="line">    synchronized (mLock) &#123;</span><br><span class="line">        if (mTransport == null) &#123;</span><br><span class="line">            mTransport = new Transport(this);</span><br><span class="line">        &#125;</span><br><span class="line">        return mTransport;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ContentObserver类的getContentObserver函数返回的是一个成员变量mTransport，它的类型为ContentObserver的内部类Transport。ContentObserver类的成员变量mTransport是一个Binder对象，它是要传递给ContentService服务的，以便当ContentObserver所监控的数据发生变化时，ContentService服务可以通过这个Binder对象通知相应的ContentObserver它监控的数据发生变化了。</p>
<h5 id="registerContentObserver"><a href="#registerContentObserver" class="headerlink" title="registerContentObserver"></a>registerContentObserver</h5><p>frameworks/base/services/core/java/com/android/server/content/ContentService.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void registerContentObserver(Uri uri, boolean notifyForDescendants,</span><br><span class="line">        IContentObserver observer, int userHandle) &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    synchronized (mRootNode) &#123;</span><br><span class="line">        mRootNode.addObserverLocked(uri, observer, notifyForDescendants, mRootNode,</span><br><span class="line">                uid, pid, userHandle);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>它调用了ContentService类的成员变量mRootNode的addObserverLocked函数来注册这个ContentObserver对象observer。成员变量mRootNode的类型为ContentService在内部定义的一个类ObserverNode。</p>
<h5 id="addObserverLocked"><a href="#addObserverLocked" class="headerlink" title="addObserverLocked"></a>addObserverLocked</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> public void addObserverLocked(Uri uri, IContentObserver observer,</span><br><span class="line">        boolean notifyForDescendants, Object observersLock,</span><br><span class="line">        int uid, int pid, int userHandle) &#123;</span><br><span class="line">    addObserverLocked(uri, 0, observer, notifyForDescendants, observersLock,</span><br><span class="line">            uid, pid, userHandle);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void addObserverLocked(Uri uri, int index, IContentObserver observer,</span><br><span class="line">        boolean notifyForDescendants, Object observersLock,</span><br><span class="line">        int uid, int pid, int userHandle) &#123;</span><br><span class="line">    // If this is the leaf node add the observer</span><br><span class="line">    if (index == countUriSegments(uri)) &#123;</span><br><span class="line">        mObservers.add(new ObserverEntry(observer, notifyForDescendants, observersLock,</span><br><span class="line">                uid, pid, userHandle));</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Look to see if the proper child already exists</span><br><span class="line">    String segment = getUriSegment(uri, index);</span><br><span class="line">    if (segment == null) &#123;</span><br><span class="line">        throw new IllegalArgumentException(&quot;Invalid Uri (&quot; + uri + &quot;) used for observer&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    int N = mChildren.size();</span><br><span class="line">    for (int i = 0; i &lt; N; i++) &#123;</span><br><span class="line">        ObserverNode node = mChildren.get(i);</span><br><span class="line">        if (node.mName.equals(segment)) &#123;</span><br><span class="line">            node.addObserverLocked(uri, index + 1, observer, notifyForDescendants,</span><br><span class="line">                    observersLock, uid, pid, userHandle);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // No child found, create one</span><br><span class="line">    ObserverNode node = new ObserverNode(segment);</span><br><span class="line">    mChildren.add(node);</span><br><span class="line">    node.addObserverLocked(uri, index + 1, observer, notifyForDescendants,</span><br><span class="line">            observersLock, uid, pid, userHandle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出，注册到ContentService中的ContentObserver按照树形来组织，树的节点类型为ObserverNode，而树的根节点就为ContentService类的成员变量mRootNode。<br>private final ObserverNode mRootNode = new ObserverNode(“”);<br>每一个ObserverNode节点都对应一个名字，它是从URI中解析出来的。<br>在这个应用程序例子中，uri为content://com.cj.mycontentprovider/contact，它最终解析成的树状结构为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mRootNode(&quot;&quot;)</span><br><span class="line"></span><br><span class="line">    -- ObserverNode(&quot;com.cj.mycontentprovider&quot;)</span><br><span class="line"></span><br><span class="line">        --ObserverNode(&quot;contact&quot;) , which has a ContentObserver in mObservers</span><br></pre></td></tr></table></figure></p>
<p>至此，ContentObserver的注册过程就完成了。</p>
<h4 id="数据更新通知的发送过程"><a href="#数据更新通知的发送过程" class="headerlink" title="数据更新通知的发送过程"></a>数据更新通知的发送过程</h4><p>在第二个应用程序中，在添加联系人的界面田添加一个联系人时：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ContentValues contentValues = new ContentValues();    </span><br><span class="line">            contentValues.put(&quot;name&quot;,name);    </span><br><span class="line">            contentValues.put(&quot;number&quot;,num);    </span><br><span class="line">            getContentResolver().insert(Uri.parse(&quot;content://com.cj.mycontentprovider/contact&quot;),contentValues);</span><br></pre></td></tr></table></figure></p>
<p>会调用到第一个应用程序的MyContentProvider类的insert函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public Uri insert(Uri uri, ContentValues values) &#123;  </span><br><span class="line">       Uri u = null;  </span><br><span class="line">       if(uriMatcher.match(uri) == CONTACT)&#123;  </span><br><span class="line">           SQLiteDatabase database = dbHelp.getWritableDatabase();  </span><br><span class="line"> </span><br><span class="line">           long d = database.insert(&quot;contact&quot;, &quot;_id&quot;, values);  </span><br><span class="line">           u = ContentUris.withAppendedId(uri,d);  </span><br><span class="line">           contentResolver.notifyChange(u,null);  </span><br><span class="line">       &#125;  </span><br><span class="line">       return u;  </span><br><span class="line"> </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>从上面传来的参数uri的值为”content://com.cj.mycontentprovider/contact”。假设当这个函数把数据成功增加到SQLite数据库之后，返回来的id值为d，于是通过调用ContentUris.withAppendedId(uri,d);得到的newUri的值就为”content://com.cj.mycontentprovider/contact/d”。这时候就会调用下面语句来通知那些注册了监控”content://com.cj.mycontentprovider/contact/d”这个URI的ContentObserver，它监控的数据发生变化了：<br>contentResolver.notifyChange(u,null);<br>下面就根据源码来分析这个数据变化通知的发送过程：ContentResolver.notifyChange()<br>frameworks/base/core/java/android/content/ContentResolver.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public void notifyChange(@NonNull Uri uri, @Nullable ContentObserver observer) &#123;</span><br><span class="line">    notifyChange(uri, observer, true /* sync to network */);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void notifyChange(@NonNull Uri uri, @Nullable ContentObserver observer,</span><br><span class="line">        boolean syncToNetwork) &#123;</span><br><span class="line">    Preconditions.checkNotNull(uri, &quot;uri&quot;);</span><br><span class="line">    notifyChange(</span><br><span class="line">            ContentProvider.getUriWithoutUserId(uri),</span><br><span class="line">            observer,</span><br><span class="line">            syncToNetwork,</span><br><span class="line">            ContentProvider.getUserIdFromUri(uri, UserHandle.myUserId()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> public void notifyChange(Uri uri, ContentObserver observer, boolean syncToNetwork,</span><br><span class="line">        int userHandle) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        getContentService().notifyChange(</span><br><span class="line">                uri, observer == null ? null : observer.getContentObserver(),</span><br><span class="line">                observer != null &amp;&amp; observer.deliverSelfNotifications(), syncToNetwork,</span><br><span class="line">                userHandle);</span><br><span class="line">    &#125; catch (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用了ContentService的远接程口来调用它的notifyChange()函数来发送数据更新通知。<br>frameworks/base/services/core/java/com/android/server/content/ContentService.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public void notifyChange(Uri uri, IContentObserver observer,</span><br><span class="line">        ...</span><br><span class="line">    try &#123;</span><br><span class="line">        ArrayList&lt;ObserverCall&gt; calls = new ArrayList&lt;ObserverCall&gt;();</span><br><span class="line">        synchronized (mRootNode) &#123;</span><br><span class="line">            mRootNode.collectObserversLocked(uri, 0, observer, observerWantsSelfNotifications,</span><br><span class="line">                    userHandle, calls);</span><br><span class="line">        &#125;</span><br><span class="line">        final int numCalls = calls.size();</span><br><span class="line">        for (int i=0; i&lt;numCalls; i++) &#123;</span><br><span class="line">            ObserverCall oc = calls.get(i);</span><br><span class="line">            try &#123;</span><br><span class="line">                oc.mObserver.onChange(oc.mSelfChange, uri, userHandle);</span><br><span class="line">                ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (RemoteException ex) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">       ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个函数主要做了两件事情，第一件事情是调用ContentService的成员变量mRootNode的collectObserverLocked()函数来收集那些注册了监控”content://com.cj.mycontentprovider/contact/d”这个URI的ContentObserver，第二件事情是分别调用了这些ContentObserver的onChange()函数来通知它们监控的数据发生变化了。</p>
<p>可以看到，calls的类型，是一个ObserverCall的ArrayList，查看ObserverCall的定义<br>frameworks/base/services/core/java/com/android/server/content/ContentService.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public static final class ObserverCall &#123;</span><br><span class="line">    final ObserverNode mNode;</span><br><span class="line">    final IContentObserver mObserver;</span><br><span class="line">    final boolean mSelfChange;</span><br><span class="line"></span><br><span class="line">    ObserverCall(ObserverNode node, IContentObserver observer, boolean selfChange) &#123;</span><br><span class="line">        mNode = node;</span><br><span class="line">        mObserver = observer;</span><br><span class="line">        mSelfChange = selfChange;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中包括一个成员 IContentObserver mObserver。这个就是注册了监控”content://com.cj.mycontentprovider/contact/d”这个URI的ContentObserver。<br>在本例当中，只有一个这样的ContentObserver，即在第二个应用程序中注册的MyContentObserver。</p>
<p>接下来，会调用这个ContentObserver的onChange方法，通知数据更新事件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oc.mObserver.onChange(oc.mSelfChange, uri, userHandle);</span><br></pre></td></tr></table></figure></p>
<p>前面我们在分析ContentObserver的注册过程时，介绍到注册到ContentService服务中的mObserver是一个在ContentObserver内部定义的一个类Transport的对象的远程接口，于是这里调用这个接口的onChange()函数时，就会进入到ContentObserver的内部类Transport的onChange()函数中去。<br>frameworks/base/core/java/android/database/ContentObserver.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">private static final class Transport extends IContentObserver.Stub &#123;</span><br><span class="line">    private ContentObserver mContentObserver;</span><br><span class="line"></span><br><span class="line">    public Transport(ContentObserver contentObserver) &#123;</span><br><span class="line">        mContentObserver = contentObserver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onChange(boolean selfChange, Uri uri, int userId) &#123;</span><br><span class="line">        ContentObserver contentObserver = mContentObserver;</span><br><span class="line">        if (contentObserver != null) &#123;</span><br><span class="line">            contentObserver.dispatchChange(selfChange, uri, userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void releaseContentObserver() &#123;</span><br><span class="line">        mContentObserver = null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>frameworks/base/core/java/android/database/ContentObserver.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private void dispatchChange(boolean selfChange, Uri uri, int userId) &#123;</span><br><span class="line">    if (mHandler == null) &#123;</span><br><span class="line">        onChange(selfChange, uri, userId);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        mHandler.post(new NotificationRunnable(selfChange, uri, userId));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在前面分析MyContentObserver的注册过程时，我们以第二个应用程序的主线程的消息循环创建了一个Handler，并且以这个Handler来创建了这个MyContentObserver，这个Handler就保存在MyContentObserver的父类ContentObserver的成员变量mHandler中。因此，这里的mHandler不为null，于是把这个数据更新通知封装成了一个消息，放到第二个应用程序的主线程中去处理，最终这个消息是由NotificationRunnable类的run()函数来处理的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private final class NotificationRunnable implements Runnable &#123;</span><br><span class="line">    private final boolean mSelfChange;</span><br><span class="line">    private final Uri mUri;</span><br><span class="line">    private final int mUserId;</span><br><span class="line"></span><br><span class="line">    public NotificationRunnable(boolean selfChange, Uri uri, int userId) &#123;</span><br><span class="line">        mSelfChange = selfChange;</span><br><span class="line">        mUri = uri;</span><br><span class="line">        mUserId = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        ContentObserver.this.onChange(mSelfChange, mUri, mUserId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数就直接调用ContentObserver的子类的onChange函数来处理这个数据更新通知了。在我们这个情景中，这个ContentObserver子类便是MyContentObserver了。<br>这里它要执行的操作便是更新界面上的ListView列表中的联系人信息了。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/12/21/pattern-proxy/" rel="next" title="Android中的设计模式之代理模式">
                <i class="fa fa-chevron-left"></i> Android中的设计模式之代理模式
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/01/12/ping-pong/" rel="prev" title="cjdns源码分析--SwitchPing的发送，接收与回复">
                cjdns源码分析--SwitchPing的发送，接收与回复 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Chris King</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">73</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">27</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ContentProvider简介"><span class="nav-number">1.</span> <span class="nav-text">ContentProvider简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#URI类简介"><span class="nav-number">2.</span> <span class="nav-text">URI类简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Android中的URI"><span class="nav-number">2.1.</span> <span class="nav-text">Android中的URI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UriMatcher"><span class="nav-number">2.2.</span> <span class="nav-text">UriMatcher</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ContentUris"><span class="nav-number">2.3.</span> <span class="nav-text">ContentUris</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一个使用ContentProvider的例子"><span class="nav-number">3.</span> <span class="nav-text">一个使用ContentProvider的例子</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#写提供数据的应用"><span class="nav-number">3.1.</span> <span class="nav-text">写提供数据的应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#声明这个ContentProvider"><span class="nav-number">3.2.</span> <span class="nav-text">声明这个ContentProvider</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#写使用数据的应用"><span class="nav-number">3.3.</span> <span class="nav-text">写使用数据的应用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源码分析"><span class="nav-number">4.</span> <span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#获取ContentResoler对象"><span class="nav-number">4.1.</span> <span class="nav-text">获取ContentResoler对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取IContentProvider对象"><span class="nav-number">4.2.</span> <span class="nav-text">获取IContentProvider对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据更新（ContentObserver）"><span class="nav-number">4.3.</span> <span class="nav-text">数据更新（ContentObserver）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ContentObserver的注册过程"><span class="nav-number">4.3.1.</span> <span class="nav-text">ContentObserver的注册过程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#getContentService"><span class="nav-number">4.3.1.1.</span> <span class="nav-text">getContentService</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getContentObserver"><span class="nav-number">4.3.1.2.</span> <span class="nav-text">getContentObserver</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#registerContentObserver"><span class="nav-number">4.3.1.3.</span> <span class="nav-text">registerContentObserver</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#addObserverLocked"><span class="nav-number">4.3.1.4.</span> <span class="nav-text">addObserverLocked</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据更新通知的发送过程"><span class="nav-number">4.3.2.</span> <span class="nav-text">数据更新通知的发送过程</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chris King</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.0.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
