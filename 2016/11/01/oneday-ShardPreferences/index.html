<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ShardPreferences | IChrisKing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="给出了一个使用SharedPreferences的例子，并从例子出发，分析SharedPreferences创建，获取，写入的源码。">
<meta name="keywords" content="Android,Android_everyday">
<meta property="og:type" content="article">
<meta property="og:title" content="ShardPreferences">
<meta property="og:url" content="http://yoursite.com/2016/11/01/oneday-ShardPreferences/index.html">
<meta property="og:site_name" content="IChrisKing">
<meta property="og:description" content="给出了一个使用SharedPreferences的例子，并从例子出发，分析SharedPreferences创建，获取，写入的源码。">
<meta property="og:locale" content="zh-Hant-TW">
<meta property="og:updated_time" content="2018-02-28T05:58:55.153Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ShardPreferences">
<meta name="twitter:description" content="给出了一个使用SharedPreferences的例子，并从例子出发，分析SharedPreferences创建，获取，写入的源码。">
  
    <link rel="alternate" href="/atom.xml" title="IChrisKing" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">IChrisKing</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">#IMNOTCHRISLEE</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-oneday-ShardPreferences" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/01/oneday-ShardPreferences/" class="article-date">
  <time datetime="2016-11-01T12:35:00.000Z" itemprop="datePublished">2016-11-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>►<a class="article-category-link" href="/categories/Android/Android-everyday/">Android_everyday</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ShardPreferences
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="http://www.jianshu.com/p/4dd53e1be5ba" target="_blank" rel="external">修改SharedPreferences后两种提交方式有什么区别？</a></p>
<h2 id="使用SharedPreferences的一个例子"><a href="#使用SharedPreferences的一个例子" class="headerlink" title="使用SharedPreferences的一个例子"></a>使用SharedPreferences的一个例子</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">SharedPreferences sp = context.getSharedPreferences(&quot;name&quot;,Context.MODE_PRIVATE);</div><div class="line"></div><div class="line">int val1 = sp.getInt(&quot;val1&quot;,0);</div><div class="line"></div><div class="line">SharedPreferences.Editor editor = sp.edit();</div><div class="line"></div><div class="line">editor.putInt(&quot;val1&quot;, val1+1);</div><div class="line"></div><div class="line">editor.apply();//异步写入</div><div class="line"></div><div class="line">// editor.commit();//同步写入</div></pre></td></tr></table></figure>
<h2 id="SharedPreferences源码"><a href="#SharedPreferences源码" class="headerlink" title="SharedPreferences源码"></a>SharedPreferences源码</h2><p>以上面的使用为例，分析SharedPreferences的相关实现过程。</p>
<h3 id="获取SharedPreferences：getSharedPreferences"><a href="#获取SharedPreferences：getSharedPreferences" class="headerlink" title="获取SharedPreferences：getSharedPreferences"></a>获取SharedPreferences：getSharedPreferences</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SharedPreferences sp = context.getSharedPreferences(&quot;name&quot;,Context.MODE_PRIVATE);</div></pre></td></tr></table></figure>
<p>我们通过context的getSharedPreferences方法来获取SharedPreferences，context的实现类是ContextImpl，查看这个函数(源码位置frameworks/base/core/java/android/app/ContextImpl.java)：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">public SharedPreferences getSharedPreferences(String name, int mode) &#123;</div><div class="line">    SharedPreferencesImpl sp;</div><div class="line">    synchronized (ContextImpl.class) &#123;</div><div class="line">        if (sSharedPrefs == null) &#123;</div><div class="line">            sSharedPrefs = new ArrayMap&lt;String, ArrayMap&lt;String, SharedPreferencesImpl&gt;&gt;();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        final String packageName = getPackageName();</div><div class="line">        ArrayMap&lt;String, SharedPreferencesImpl&gt; packagePrefs = sSharedPrefs.get(packageName);</div><div class="line">        if (packagePrefs == null) &#123;</div><div class="line">            packagePrefs = new ArrayMap&lt;String, SharedPreferencesImpl&gt;();</div><div class="line">            sSharedPrefs.put(packageName, packagePrefs);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // At least one application in the world actually passes in a null</div><div class="line">        // name.  This happened to work because when we generated the file name</div><div class="line">        // we would stringify it to &quot;null.xml&quot;.  Nice.</div><div class="line">        if (mPackageInfo.getApplicationInfo().targetSdkVersion &lt;</div><div class="line">                Build.VERSION_CODES.KITKAT) &#123;</div><div class="line">            if (name == null) &#123;</div><div class="line">                name = &quot;null&quot;;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        sp = packagePrefs.get(name);</div><div class="line">        if (sp == null) &#123;</div><div class="line">            File prefsFile = getSharedPrefsFile(name);</div><div class="line">            sp = new SharedPreferencesImpl(prefsFile, mode);</div><div class="line">            packagePrefs.put(name, sp);</div><div class="line">            return sp;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    if ((mode &amp; Context.MODE_MULTI_PROCESS) != 0 ||</div><div class="line">        getApplicationInfo().targetSdkVersion &lt; android.os.Build.VERSION_CODES.HONEYCOMB) &#123;</div><div class="line">        // If somebody else (some other process) changed the prefs</div><div class="line">        // file behind our back, we reload it.  This has been the</div><div class="line">        // historical (if undocumented) behavior.</div><div class="line">        sp.startReloadIfChangedUnexpectedly();</div><div class="line">    &#125;</div><div class="line">    return sp;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先可以看到的就是，整段代码是被一个synchronized (ContextImpl.class)同步锁包裹起来的。</p>
<p>然后代码依次做了以下操作：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">if (sSharedPrefs == null) &#123;</div><div class="line">                sSharedPrefs = new ArrayMap&lt;String, ArrayMap&lt;String, SharedPreferencesImpl&gt;&gt;();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            final String packageName = getPackageName();</div><div class="line">            ArrayMap&lt;String, SharedPreferencesImpl&gt; packagePrefs = sSharedPrefs.get(packageName);</div><div class="line">            if (packagePrefs == null) &#123;</div><div class="line">                packagePrefs = new ArrayMap&lt;String, SharedPreferencesImpl&gt;();</div><div class="line">                sSharedPrefs.put(packageName, packagePrefs);</div><div class="line">            &#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>判断sSharedPrefs是否为空，如果为空则执行初始化操作。从初始化代码可以看到，sSharedPrefs是一个用来缓存SharedPreferences的ArrayMap，它的key为包名，它的value为ArrayMap，这个ArrayMap保存的键值对是SharedPreferences文件名和对应的SharedPreferencesImpl（是SharedPreferences的实现类）。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">// At least one application in the world actually passes in a null</div><div class="line">// name.  This happened to work because when we generated the file name</div><div class="line">// we would stringify it to &quot;null.xml&quot;.  Nice.</div><div class="line">if (mPackageInfo.getApplicationInfo().targetSdkVersion &lt;</div><div class="line">        Build.VERSION_CODES.KITKAT) &#123;</div><div class="line">    if (name == null) &#123;</div><div class="line">        name = &quot;null&quot;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>对于KITKAT以前的版本做一个name的处理，不用分析了，可以忽略。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sp = packagePrefs.get(name);</div><div class="line">if (sp == null) &#123;</div><div class="line">    File prefsFile = getSharedPrefsFile(name);</div><div class="line">    sp = new SharedPreferencesImpl(prefsFile, mode);</div><div class="line">    packagePrefs.put(name, sp);</div><div class="line">    return sp;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>根据参数传入的name，获取SharedPreferencesImpl。如果SharedPreferencesImpl已经存在，它会直接返回已经存在的SharedPreferencesImpl。</li>
</ol>
<p>其中调用到getSharedPrefsFile(name)这个方法来获取存储数据的xml文件，查看与之相关的函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">public File getSharedPrefsFile(String name) &#123;</div><div class="line">    return makeFilename(getPreferencesDir(), name + &quot;.xml&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">private File makeFilename(File base, String name) &#123;</div><div class="line">    if (name.indexOf(File.separatorChar) &lt; 0) &#123;</div><div class="line">        return new File(base, name);</div><div class="line">    &#125;</div><div class="line">    throw new IllegalArgumentException(</div><div class="line">            &quot;File &quot; + name + &quot; contains a path separator&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">    private File getPreferencesDir() &#123;</div><div class="line">    synchronized (mSync) &#123;</div><div class="line">        if (mPreferencesDir == null) &#123;</div><div class="line">            mPreferencesDir = new File(getDataDirFile(), &quot;shared_prefs&quot;);</div><div class="line">        &#125;</div><div class="line">        return mPreferencesDir;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">    private File getDataDirFile() &#123;</div><div class="line">    if (mPackageInfo != null) &#123;</div><div class="line">        return mPackageInfo.getDataDirFile();</div><div class="line">    &#125;</div><div class="line">    throw new RuntimeException(&quot;Not supported in system context&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到getSharedPrefsFile主要是一个文件路径的拼接过程，根据拼接的文件路径来打开文件。</p>
<p><strong>至此，同步锁内的代码结束</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">if ((mode &amp; Context.MODE_MULTI_PROCESS) != 0 ||</div><div class="line">    getApplicationInfo().targetSdkVersion &lt; android.os.Build.VERSION_CODES.HONEYCOMB) &#123;</div><div class="line">    // If somebody else (some other process) changed the prefs</div><div class="line">    // file behind our back, we reload it.  This has been the</div><div class="line">    // historical (if undocumented) behavior.</div><div class="line">    sp.startReloadIfChangedUnexpectedly();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>如果是在多进程模式下，或者目标版本低于HONEYCOMB的时候，会检查是否需要重新从磁盘中加载文件。但是需要说的是MODE_MULTI_PROCESS模式已经被deprecated了，官方建议使用ContentProvider来处理多进程访问.</li>
</ol>
<h3 id="SharedPreferencesImpl构造函数"><a href="#SharedPreferencesImpl构造函数" class="headerlink" title="SharedPreferencesImpl构造函数"></a>SharedPreferencesImpl构造函数</h3><p>根据上面的代码，可以得知，SharedPreferencesImpl是SharedPreferences的实现类。源码位置：frameworks/base/core/java/android/app/SharedPreferencesImpl.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">SharedPreferencesImpl(File file, int mode) &#123;</div><div class="line">    mFile = file;</div><div class="line">    mBackupFile = makeBackupFile(file);</div><div class="line">    mMode = mode;</div><div class="line">    mLoaded = false;</div><div class="line">    mMap = null;</div><div class="line">    startLoadFromDisk();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>除了赋值操作外，构造函数主要完成了以下操作：</p>
<ol>
<li>makeBackupFile(file)创建了一个.bak的备份文件</li>
<li>调用startLoadFromDisk()方法读出xml文件，这个读取过程是使用DOM方式解析的（一开始就把整个XML给读取出来）。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">private void startLoadFromDisk() &#123;</div><div class="line">    synchronized (this) &#123;</div><div class="line">        mLoaded = false;</div><div class="line">    &#125;</div><div class="line">    new Thread(&quot;SharedPreferencesImpl-load&quot;) &#123;</div><div class="line">        public void run() &#123;</div><div class="line">            synchronized (SharedPreferencesImpl.this) &#123;</div><div class="line">                loadFromDiskLocked();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;.start();</div><div class="line">&#125;</div><div class="line"></div><div class="line">    private void loadFromDiskLocked() &#123;</div><div class="line">    if (mLoaded) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    if (mBackupFile.exists()) &#123;</div><div class="line">        mFile.delete();</div><div class="line">        mBackupFile.renameTo(mFile);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Debugging</div><div class="line">    if (mFile.exists() &amp;&amp; !mFile.canRead()) &#123;</div><div class="line">        Log.w(TAG, &quot;Attempt to read preferences file &quot; + mFile + &quot; without permission&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Map map = null;</div><div class="line">    StructStat stat = null;</div><div class="line">    try &#123;</div><div class="line">        stat = Os.stat(mFile.getPath());</div><div class="line">        if (mFile.canRead()) &#123;</div><div class="line">            BufferedInputStream str = null;</div><div class="line">            try &#123;</div><div class="line">                str = new BufferedInputStream(</div><div class="line">                        new FileInputStream(mFile), 16*1024);</div><div class="line">                map = XmlUtils.readMapXml(str);</div><div class="line">            &#125; catch (XmlPullParserException e) &#123;</div><div class="line">                Log.w(TAG, &quot;getSharedPreferences&quot;, e);</div><div class="line">            &#125; catch (FileNotFoundException e) &#123;</div><div class="line">                Log.w(TAG, &quot;getSharedPreferences&quot;, e);</div><div class="line">            &#125; catch (IOException e) &#123;</div><div class="line">                Log.w(TAG, &quot;getSharedPreferences&quot;, e);</div><div class="line">            &#125; finally &#123;</div><div class="line">                IoUtils.closeQuietly(str);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; catch (ErrnoException e) &#123;</div><div class="line">    &#125;</div><div class="line">    mLoaded = true;</div><div class="line">    if (map != null) &#123;</div><div class="line">        mMap = map;</div><div class="line">        mStatTimestamp = stat.st_mtime;</div><div class="line">        mStatSize = stat.st_size;</div><div class="line">    &#125; else &#123;</div><div class="line">        mMap = new HashMap&lt;String, Object&gt;();</div><div class="line">    &#125;</div><div class="line">    notifyAll();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>startLoadFromDisk()方法使用了一个异步线程来读取xml，同时使用了同步锁调用loadFromDiskLocked()来执行真正的读取操作。读取操作最终调用了XmlUtils.readMapXml(str)方法，读取整个xml的内容，放到mMap当中。</p>
<h2 id="读取：getxxx"><a href="#读取：getxxx" class="headerlink" title="读取：getxxx"></a>读取：getxxx</h2><p>以getInt为例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public int getInt(String key, int defValue) &#123;</div><div class="line">    synchronized (this) &#123;</div><div class="line">        awaitLoadedLocked();</div><div class="line">        Integer v = (Integer)mMap.get(key);</div><div class="line">        return v != null ? v : defValue;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先获取锁awaitLoadedLocked()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">private void awaitLoadedLocked() &#123;</div><div class="line">    if (!mLoaded) &#123;</div><div class="line">        // Raise an explicit StrictMode onReadFromDisk for this</div><div class="line">        // thread, since the real read will be in a different</div><div class="line">        // thread and otherwise ignored by StrictMode.</div><div class="line">        BlockGuard.getThreadPolicy().onReadFromDisk();</div><div class="line">    &#125;</div><div class="line">    while (!mLoaded) &#123;</div><div class="line">        try &#123;</div><div class="line">            wait();</div><div class="line">        &#125; catch (InterruptedException unused) &#123;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后根据key获取value，因为在构造函数中已经完整的读出了xml文件，所以这个获取过程很简单。</p>
<p>最后根据获取到的值判空并返回Value。</p>
<h3 id="editor的获取"><a href="#editor的获取" class="headerlink" title="editor的获取"></a>editor的获取</h3><p>SharedPreferences的写入过程主要分三步，获取editor；put操作（以putInt为例）；apply/commit。</p>
<p>首先分析获取editor的过程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public Editor edit() &#123;</div><div class="line">    // TODO: remove the need to call awaitLoadedLocked() when</div><div class="line">    // requesting an editor.  will require some work on the</div><div class="line">    // Editor, but then we should be able to do:</div><div class="line">    //</div><div class="line">    //      context.getSharedPreferences(..).edit().putString(..).apply()</div><div class="line">    //</div><div class="line">    // ... all without blocking.</div><div class="line">    synchronized (this) &#123;</div><div class="line">        awaitLoadedLocked();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return new EditorImpl();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>new了一个EditorImpl的实例。</p>
<h3 id="putInt"><a href="#putInt" class="headerlink" title="putInt"></a>putInt</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">private final Map&lt;String, Object&gt; mModified = Maps.newHashMap();</div><div class="line"></div><div class="line">public Editor putInt(String key, int value) &#123;</div><div class="line">    synchronized (this) &#123;</div><div class="line">        mModified.put(key, value);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出执行putxxx操作时，数据只是写入到了一个名为mModified的map当中，写入到xml文件的过程将在下一步进行。</p>
<h3 id="apply"><a href="#apply" class="headerlink" title="apply"></a>apply</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">public void apply() &#123;</div><div class="line">    final MemoryCommitResult mcr = commitToMemory();</div><div class="line">    final Runnable awaitCommit = new Runnable() &#123;</div><div class="line">            public void run() &#123;</div><div class="line">                try &#123;</div><div class="line">                    mcr.writtenToDiskLatch.await();</div><div class="line">                &#125; catch (InterruptedException ignored) &#123;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">    QueuedWork.add(awaitCommit);</div><div class="line"></div><div class="line">    Runnable postWriteRunnable = new Runnable() &#123;</div><div class="line">            public void run() &#123;</div><div class="line">                awaitCommit.run();</div><div class="line">                QueuedWork.remove(awaitCommit);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">    SharedPreferencesImpl.this.enqueueDiskWrite(mcr, postWriteRunnable);</div><div class="line"></div><div class="line">    // Okay to notify the listeners before it&apos;s hit disk</div><div class="line">    // because the listeners should always get the same</div><div class="line">    // SharedPreferences instance back, which has the</div><div class="line">    // changes reflected in memory.</div><div class="line">    notifyListeners(mcr);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="commit"><a href="#commit" class="headerlink" title="commit"></a>commit</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public boolean commit() &#123;</div><div class="line">    MemoryCommitResult mcr = commitToMemory();</div><div class="line">    SharedPreferencesImpl.this.enqueueDiskWrite(</div><div class="line">        mcr, null /* sync write on this thread okay */);</div><div class="line">    try &#123;</div><div class="line">        mcr.writtenToDiskLatch.await();</div><div class="line">    &#125; catch (InterruptedException e) &#123;</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line">    notifyListeners(mcr);</div><div class="line">    return mcr.writeToDiskResult;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>apply和commit的主要差别在于apply是异步执行的，而commit是同步执行的。两者都调用了几个核心的函数：commitToMemory；mcr.writtenToDiskLatch.await()；<br>SharedPreferencesImpl.this.enqueueDiskWrite；notifyListeners<br>依次分析核心函数：</p>
<h4 id="commitToMemory"><a href="#commitToMemory" class="headerlink" title="commitToMemory"></a>commitToMemory</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">private MemoryCommitResult commitToMemory() &#123;</div><div class="line">    MemoryCommitResult mcr = new MemoryCommitResult();</div><div class="line">    synchronized (SharedPreferencesImpl.this) &#123;</div><div class="line">        // We optimistically don&apos;t make a deep copy until</div><div class="line">        // a memory commit comes in when we&apos;re already</div><div class="line">        // writing to disk.</div><div class="line">        if (mDiskWritesInFlight &gt; 0) &#123;</div><div class="line">            // We can&apos;t modify our mMap as a currently</div><div class="line">            // in-flight write owns it.  Clone it before</div><div class="line">            // modifying it.</div><div class="line">            // noinspection unchecked</div><div class="line">            mMap = new HashMap&lt;String, Object&gt;(mMap);</div><div class="line">        &#125;</div><div class="line">        mcr.mapToWriteToDisk = mMap;</div><div class="line">        mDiskWritesInFlight++;</div><div class="line"></div><div class="line">        boolean hasListeners = mListeners.size() &gt; 0;</div><div class="line">        if (hasListeners) &#123;</div><div class="line">            mcr.keysModified = new ArrayList&lt;String&gt;();</div><div class="line">            mcr.listeners =</div><div class="line">                            new HashSet&lt;OnSharedPreferenceChangeListener&gt;(mListeners.keySet());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        synchronized (this) &#123;</div><div class="line">            if (mClear) &#123;</div><div class="line">                if (!mMap.isEmpty()) &#123;</div><div class="line">                    mcr.changesMade = true;</div><div class="line">                    mMap.clear();</div><div class="line">               &#125;</div><div class="line">              mClear = false;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">           for (Map.Entry&lt;String, Object&gt; e : mModified.entrySet()) &#123;</div><div class="line">                String k = e.getKey();</div><div class="line">                Object v = e.getValue();</div><div class="line">                // &quot;this&quot; is the magic value for a removal mutation. In addition,</div><div class="line">                // setting a value to &quot;null&quot; for a given key is specified to be</div><div class="line">                // equivalent to calling remove on that key.</div><div class="line">                if (v == this || v == null) &#123;</div><div class="line">                    if (!mMap.containsKey(k)) &#123;</div><div class="line">                       continue;</div><div class="line">                    &#125;</div><div class="line">                    mMap.remove(k);</div><div class="line">                &#125; else &#123;</div><div class="line">                    if (mMap.containsKey(k)) &#123;</div><div class="line">                        Object existingValue = mMap.get(k);</div><div class="line">                        if (existingValue != null &amp;&amp; existingValue.equals(v)) &#123;</div><div class="line">                            continue;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    mMap.put(k, v);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                 = true;</div><div class="line">                if (hasListeners) &#123;</div><div class="line">                    mcr.keysModified.add(k);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            mModified.clear();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return mcr;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>首先是一个SharedPreferencesImpl.this的同步锁，所有代码都被这个同步锁包裹。</li>
<li>对写操作的数量做了判断，如果大于0，就做一个mMap的copy，并增加计数器。</li>
<li>对监听数量做了判断。</li>
<li>对EditorImpl加同步锁，在这两重锁的作用下，同一个线程中如果有后续的get操作，都会被阻塞。</li>
<li>先处理clear的情况，所以这次clear不会情调本次写操作的数据，只会清除掉之前的数据</li>
<li>遍历mModified，处理各个key，value，将mModified中的值更新到mMap当中。</li>
<li>标记mcr.changesMade为true，表示有更新</li>
<li>清空mModified，并返回MemoryCommitResult mcr。</li>
</ul>
<h4 id="异步写入MemoryCommitResult"><a href="#异步写入MemoryCommitResult" class="headerlink" title="异步写入MemoryCommitResult"></a>异步写入MemoryCommitResult</h4><p>这是apply函数中的一部分。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">final Runnable awaitCommit = new Runnable() &#123;</div><div class="line">                    public void run() &#123;</div><div class="line">                        try &#123;</div><div class="line">                            mcr.writtenToDiskLatch.await();</div><div class="line">                        &#125; catch (InterruptedException ignored) &#123;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;;</div><div class="line"></div><div class="line">            QueuedWork.add(awaitCommit);</div><div class="line"></div><div class="line">            Runnable postWriteRunnable = new Runnable() &#123;</div><div class="line">                    public void run() &#123;</div><div class="line">                        awaitCommit.run();</div><div class="line">                        QueuedWork.remove(awaitCommit);</div><div class="line">                    &#125;</div><div class="line">                &#125;;</div></pre></td></tr></table></figure></p>
<p>这一段的主要作用是将mcr.writtenToDiskLatch.await放入线程队列中异步执行。在执行的过程中会阻塞住线程，并且在执行结束后从队列中删除这个任务。</p>
<h4 id="SharedPreferencesImpl-this-enqueueDiskWrite"><a href="#SharedPreferencesImpl-this-enqueueDiskWrite" class="headerlink" title="SharedPreferencesImpl.this.enqueueDiskWrite"></a>SharedPreferencesImpl.this.enqueueDiskWrite</h4><p>将mcr写到磁盘中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">private void enqueueDiskWrite(final MemoryCommitResult mcr,</div><div class="line">                              final Runnable postWriteRunnable) &#123;</div><div class="line">    final Runnable writeToDiskRunnable = new Runnable() &#123;</div><div class="line">            public void run() &#123;</div><div class="line">                synchronized (mWritingToDiskLock) &#123;</div><div class="line">                    writeToFile(mcr);</div><div class="line">                &#125;</div><div class="line">                synchronized (SharedPreferencesImpl.this) &#123;</div><div class="line">                    mDiskWritesInFlight--;</div><div class="line">                &#125;</div><div class="line">                if (postWriteRunnable != null) &#123;</div><div class="line">                    postWriteRunnable.run();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">    final boolean isFromSyncCommit = (postWriteRunnable == null);</div><div class="line"></div><div class="line">    // Typical #commit() path with fewer allocations, doing a write on</div><div class="line">    // the current thread.</div><div class="line">    if (isFromSyncCommit) &#123;</div><div class="line">        boolean wasEmpty = false;</div><div class="line">        synchronized (SharedPreferencesImpl.this) &#123;</div><div class="line">            wasEmpty = mDiskWritesInFlight == 1;</div><div class="line">        &#125;</div><div class="line">        if (wasEmpty) &#123;</div><div class="line">            writeToDiskRunnable.run();</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    QueuedWork.singleThreadExecutor().execute(writeToDiskRunnable);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>writeToDiskRunnable是真正执行写操作的runnable，其中首先使用同步锁保护，执行writeToFile操作，然后使用同步锁保护，将写操作的计数减一。</p>
<p>postWriteRunnable是apply时才有的，如果时apply调用了enqueueDiskWrite，则执行传过来的postWriteRunnable。</p>
<p>如果是commit调用了enqueueDiskWrite，执行if (isFromSyncCommit) 包裹的内容，直接调用writeToDiskRunnable.run()，将数据写入磁盘；如果是apply调用了enqueueDiskWrite，将其交给单线程的thread executor去执行。</p>
<p>####<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">private void writeToFile(MemoryCommitResult mcr) &#123;</div><div class="line">    // Rename the current file so it may be used as a backup during the next read</div><div class="line">    if (mFile.exists()) &#123;//如果文件已经存在</div><div class="line">        if (!mcr.changesMade) &#123;//并且changesMade为false，说明没有什么更新和变化</div><div class="line">            // If the file already exists, but no changes were</div><div class="line">            // made to the underlying map, it&apos;s wasteful to</div><div class="line">            // re-write the file.  Return as if we wrote it</div><div class="line">            // out.</div><div class="line">            mcr.setDiskWriteResult(true);//写入文件结果为true</div><div class="line">            return;//直接返回</div><div class="line">        &#125;</div><div class="line">        if (!mBackupFile.exists()) &#123;//如果备份文件不存在，试着将mFile重命名，作为备份文件。这样如果本次写操作失败了，还有备份文件可以恢复。</div><div class="line">            if (!mFile.renameTo(mBackupFile)) &#123;//如果重命名失败了</div><div class="line">                Log.e(TAG, &quot;Couldn&apos;t rename file &quot; + mFile</div><div class="line">                      + &quot; to backup file &quot; + mBackupFile);</div><div class="line">                mcr.setDiskWriteResult(false);//报错，并表示写入文件结果为false</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            mFile.delete();//如果重命名成功了，删除mFile</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Attempt to write the file, delete the backup and return true as atomically as</div><div class="line">    // possible.  If any exception occurs, delete the new file; next time we will restore</div><div class="line">    // from the backup.</div><div class="line">    try &#123;</div><div class="line">        FileOutputStream str = createFileOutputStream(mFile);//创建新的mFile</div><div class="line">        if (str == null) &#123;</div><div class="line">            mcr.setDiskWriteResult(false);//如果失败的话，将写入文件的结果设为false，并返回</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        XmlUtils.writeMapXml(mcr.mapToWriteToDisk, str);//将mcr的mapToWriteToDisk写入到新的mFile当中</div><div class="line">        FileUtils.sync(str);</div><div class="line">        str.close();//关闭文件流</div><div class="line">        ContextImpl.setFilePermissionsFromMode(mFile.getPath(), mMode, 0);//根据mMode设置权限</div><div class="line">        try &#123;</div><div class="line">            final StructStat stat = Os.stat(mFile.getPath());</div><div class="line">            synchronized (this) &#123;//处理相关的变量</div><div class="line">                mStatTimestamp = stat.st_mtime;</div><div class="line">                mStatSize = stat.st_size;</div><div class="line">            &#125;</div><div class="line">        &#125; catch (ErrnoException e) &#123;</div><div class="line">            // Do nothing</div><div class="line">        &#125;</div><div class="line">        // Writing was successful, delete the backup file if there is one.</div><div class="line">        mBackupFile.delete();//删除备份文件</div><div class="line">        mcr.setDiskWriteResult(true);//标记写入成功</div><div class="line">        return;//返回</div><div class="line">    &#125; catch (XmlPullParserException e) &#123;</div><div class="line">        Log.w(TAG, &quot;writeToFile: Got exception:&quot;, e);</div><div class="line">    &#125; catch (IOException e) &#123;</div><div class="line">        Log.w(TAG, &quot;writeToFile: Got exception:&quot;, e);</div><div class="line">    &#125;</div><div class="line">    // Clean up an unsuccessfully written file</div><div class="line">    if (mFile.exists()) &#123;//如果在以上的写入过程中除了问题，删除mFile</div><div class="line">        if (!mFile.delete()) &#123;</div><div class="line">            Log.e(TAG, &quot;Couldn&apos;t clean up partially-written file &quot; + mFile);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    mcr.setDiskWriteResult(false);//标记写入失败</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>至此，写入操作就分析完了。可以看出，每次调用put的时候并没有真的将数据写入磁盘中，而是在调用commit或者apply时，将整个文件重写一遍。所以，在修改多个条目时，应该将所有的put操作执行完，最后调用依次commit或者apply。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>SharedPreferences的读取，是一个异步的过程，在context.getSharedPreferences时，已经将整个xml文件都读取出来了。另外，会使用ArrayMap对SharedPreferences进行缓存，以SharedPreferences的name作为key。</p>
<p>SharedPreferences的写入是通过editor完成的。有两种方式写入，异步的apply和同步的commit。所以如果是在主线程执行写入操作，要考虑到ANR的问题，最好使用apply。</p>
<p>所有的线程读取的时候都会加SharedPreferencesImpl.this锁，editor写入内存的时候（写入SharedPreferencesImpl.this.mMap）也会加SharedPreferencesImpl.this锁，另外editor调用put，clear, remove方法的时候都会加上EditorImpl.this锁，这些是线程安全的保证，只有在commit/apply后才会写入内存（mMap, xml内容缓存的map变量）和磁盘。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/11/01/oneday-ShardPreferences/" data-id="cje6pjw1s003iweyx0diwz8pl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-everyday/">Android_everyday</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/11/02/Sort/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          各种排序算法
        
      </div>
    </a>
  
  
    <a href="/2016/10/31/oneday-AsyncTask/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">AsyncTask</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/Android-everyday/">Android_everyday</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/Android开发工程师/">Android开发工程师</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/AndroidRom/">AndroidRom</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Anrom/">Anrom</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Anrom/rom7-0/">rom7.0</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Android开发工程师/">Android开发工程师</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SEAndroid/">SEAndroid</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/cjdns/">cjdns</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/cjdns/cjdns源码分析/">cjdns源码分析</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/cjdns-cjdns源码分析/">cjdns - cjdns源码分析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/music/">music</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/net/">net</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/net/iptables/">iptables</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/树莓派/">树莓派</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/树莓派/配置/">配置</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/算法/Java/">Java</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/Java/">Java</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android-everyday/">Android_everyday</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android开发工程师/">Android开发工程师</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Anrom/">Anrom</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C-C/">C/C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SEAndroid/">SEAndroid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SELinux/">SELinux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cjdns/">cjdns</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cjdns源码分析/">cjdns源码分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iptables/">iptables</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/music/">music</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raspberry配置/">raspberry配置</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rom/">rom</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shadowsocks-vps/">shadowsocks/vps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tool/">tool</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/填坑/">填坑</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/排序算法/">排序算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构/">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/查找算法/">查找算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/树莓派raspberry/">树莓派raspberry</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Android-everyday/" style="font-size: 16.67px;">Android_everyday</a> <a href="/tags/Android开发工程师/" style="font-size: 15.56px;">Android开发工程师</a> <a href="/tags/Anrom/" style="font-size: 14.44px;">Anrom</a> <a href="/tags/C-C/" style="font-size: 14.44px;">C/C++</a> <a href="/tags/Java/" style="font-size: 18.89px;">Java</a> <a href="/tags/Linux/" style="font-size: 13.33px;">Linux</a> <a href="/tags/SEAndroid/" style="font-size: 10px;">SEAndroid</a> <a href="/tags/SELinux/" style="font-size: 10px;">SELinux</a> <a href="/tags/cjdns/" style="font-size: 14.44px;">cjdns</a> <a href="/tags/cjdns源码分析/" style="font-size: 14.44px;">cjdns源码分析</a> <a href="/tags/git/" style="font-size: 11.11px;">git</a> <a href="/tags/hexo/" style="font-size: 13.33px;">hexo</a> <a href="/tags/iptables/" style="font-size: 10px;">iptables</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/music/" style="font-size: 10px;">music</a> <a href="/tags/raspberry配置/" style="font-size: 10px;">raspberry配置</a> <a href="/tags/rom/" style="font-size: 10px;">rom</a> <a href="/tags/shadowsocks-vps/" style="font-size: 10px;">shadowsocks/vps</a> <a href="/tags/tool/" style="font-size: 11.11px;">tool</a> <a href="/tags/填坑/" style="font-size: 13.33px;">填坑</a> <a href="/tags/排序算法/" style="font-size: 11.11px;">排序算法</a> <a href="/tags/数据结构/" style="font-size: 10px;">数据结构</a> <a href="/tags/查找算法/" style="font-size: 11.11px;">查找算法</a> <a href="/tags/树莓派raspberry/" style="font-size: 11.11px;">树莓派raspberry</a> <a href="/tags/算法/" style="font-size: 12.22px;">算法</a> <a href="/tags/设计模式/" style="font-size: 17.78px;">设计模式</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">March 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">February 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/01/29/cjnds-asymmetric-cryptography/">握手过程中，非对称密钥的应用</a>
          </li>
        
          <li>
            <a href="/2017/12/04/how-to-fix-rebase-still-in-progress/">如何解决报错“prior sync failed; rebase still in progress”</a>
          </li>
        
          <li>
            <a href="/2017/11/22/cjdns-3steps-lladdrsession/">使用SocketAddress来维护的EndpointsBySockaddr map机制中EndpointsBySockaddr session的建立过程</a>
          </li>
        
          <li>
            <a href="/2017/09/05/cjdns-cryptoauth/">cjdns源码分析--CryptoAuth</a>
          </li>
        
          <li>
            <a href="/2017/09/04/how-to-read-staff/">如何看懂五线谱</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Chris King<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>