<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="Chris King" />



<meta name="description" content="结合ConvertView,ViewHolder和源码中的RecycleBin机制分析了ListView的优化，并给出了在滑动时不加载图片的代码实现。">
<meta property="og:type" content="article">
<meta property="og:title" content="如何优化listView">
<meta property="og:url" content="http://yoursite.com/2016/10/10/oneday-listview/index.html">
<meta property="og:site_name" content="IChrisKing">
<meta property="og:description" content="结合ConvertView,ViewHolder和源码中的RecycleBin机制分析了ListView的优化，并给出了在滑动时不加载图片的代码实现。">
<meta property="og:updated_time" content="2016-11-02T05:56:31.500Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何优化listView">
<meta name="twitter:description" content="结合ConvertView,ViewHolder和源码中的RecycleBin机制分析了ListView的优化，并给出了在滑动时不加载图片的代码实现。">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="IChrisKing" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>如何优化listView | IChrisKing</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: undefined
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Chris King</a></h1>
        </hgroup>

        
        <p class="header-subtitle">#IMNOTCHRISLEE</p>
        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜單</li>
                        <li>標籤</li>
                        
                        <li>友情鏈接</li>
                        
                        
                        <li>關於我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主頁</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">標籤雲</a></li>
                        
                            <li><a href="/about/">關於我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="https://chrisking310@gmail.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="https://github.com/IChrisKing" title="GitHub"></a>
                            
                                <a class="fa 新浪博客" href="http://blog.sina.com.cn/u/1733434252" title="新浪博客"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android-everyday/">Android_everyday</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android开发工程师/">Android开发工程师</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Anrom/">Anrom</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C-C/">C/C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SEAndroid/">SEAndroid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SELinux/">SELinux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/anrom/">anrom</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cjdns/">cjdns</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cjdns源码分析/">cjdns源码分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iptables/">iptables</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/">network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raspberry配置/">raspberry配置</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shadowsocks-vps/">shadowsocks/vps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tool/">tool</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/填坑/">填坑</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/排序算法/">排序算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构/">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/查找算法/">查找算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/树莓派raspberry/">树莓派raspberry</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络/">网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://anromos.github.io/">Anrom OS</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://github.com/AnromOS">Team GitHub</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">Android ROM 开发</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Chris King</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Chris King</a></h1>
            </hgroup>
            
            <p class="header-subtitle">#IMNOTCHRISLEE</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主頁</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">標籤雲</a></li>
                
                    <li><a href="/about/">關於我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="https://chrisking310@gmail.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/IChrisKing" title="GitHub"></a>
                            
                                <a class="fa 新浪博客" target="_blank" href="http://blog.sina.com.cn/u/1733434252" title="新浪博客"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="標籤" friends="友情鏈接" about="關於我"/>
</nav>
      <div class="body-wrap"><article id="post-oneday-listview" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/10/10/oneday-listview/" class="article-date">
      <time datetime="2016-10-10T15:00:34.000Z" itemprop="datePublished">2016-10-10</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      如何优化listView
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Android/">Android</a><a class="article-category-link" href="/categories/Android/Android-everyday/">Android_everyday</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-everyday/">Android_everyday</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><a href="http://www.jianshu.com/p/8fd5fa90ee6c" target="_blank" rel="external">如何优化ListView的性能？</a></p>
<h2 id="重用ConvertView和使用ViewHolder模式"><a href="#重用ConvertView和使用ViewHolder模式" class="headerlink" title="重用ConvertView和使用ViewHolder模式"></a>重用ConvertView和使用ViewHolder模式</h2><p>这两项是优化listview的重要方法，基本上已经是写自定义adapter的标配了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">static class ViewHolder &#123;</div><div class="line">	TextView text;</div><div class="line">	ImageView icon;</div><div class="line">&#125;</div><div class="line">public View getView(int position, View convertView, ViewGroup parent) </div><div class="line">&#123;</div><div class="line">	ViewHolder holder;</div><div class="line">	if (convertView == null) &#123;</div><div class="line">	convertView = mInflater.inflate(R.layout.list_item_icon_text,parent, false);</div><div class="line">	holder = new ViewHolder();</div><div class="line">	holder.text = (TextView)	convertView.findViewById(R.id.text);</div><div class="line">	holder.icon = (ImageView) convertView.findViewById(R.id.icon);</div><div class="line">	convertView.setTag(holder);</div><div class="line">&#125; else &#123;</div><div class="line">	holder = (ViewHolder) convertView.getTag();</div><div class="line">&#125;</div><div class="line"></div><div class="line">//set values to the viewHolder</div><div class="line">holder.text.setText(DATA[position]);</div><div class="line">holder.icon.setImageBitmap((position &amp; 1) == 1 ? mIcon1 : </div><div class="line">mIcon2);</div><div class="line">return convertView;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到优化ListView的性能很多时候都是在getView中完成的。</p>
<p>先说ViewHolder:ViewHolder的使用，降低了进行findViewById的次数，当convertView不为空的情况下，可以直接执行set value的操作。</p>
<p>然后说convertView：convertView是getView函数的第二个参数。也就是说，getView对convertView的复用，是依靠调用它的函数传入一个convertView实现的。那么是哪里调用了getView函数呢？</p>
<h2 id="ListView的复用机制"><a href="#ListView的复用机制" class="headerlink" title="ListView的复用机制"></a>ListView的复用机制</h2><p>ListView中有一个RecycleBin类复负回收不可见且可能被再次使用的ItemView，由ScrapView存储。</p>
<p>RecycleBin机制是ListView能够实现成百上千条数据都不会OOM最重要的一个原因。它是写在AbsListView中的一个内部类，所以所有继承自AbsListView的子类，也就是ListView和GridView，都可以使用这个机制。RecycleBin有几个重要的函数:</p>
<h3 id="fillActiveViews"><a href="#fillActiveViews" class="headerlink" title="fillActiveViews"></a>fillActiveViews</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">         * Fill ActiveViews with all of the children of the AbsListView.</div><div class="line">         *</div><div class="line">         * @param childCount The minimum number of views mActiveViews should hold</div><div class="line">         * @param firstActivePosition The position of the first view that will be stored in</div><div class="line">         *        mActiveViews</div><div class="line">         */</div><div class="line">        void fillActiveViews(int childCount, int firstActivePosition) &#123;</div><div class="line">            if (mActiveViews.length &lt; childCount) &#123;</div><div class="line">                mActiveViews = new View[childCount];</div><div class="line">            &#125;</div><div class="line">            mFirstActivePosition = firstActivePosition;</div><div class="line"></div><div class="line">            //noinspection MismatchedReadAndWriteOfArray</div><div class="line">            final View[] activeViews = mActiveViews;</div><div class="line">            for (int i = 0; i &lt; childCount; i++) &#123;</div><div class="line">                View child = getChildAt(i);</div><div class="line">                AbsListView.LayoutParams lp = (AbsListView.LayoutParams) child.getLayoutParams();</div><div class="line">                // Don&apos;t put header or footer views into the scrap heap</div><div class="line">                if (lp != null &amp;&amp; lp.viewType != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">                    // Note:  We do place AdapterView.ITEM_VIEW_TYPE_IGNORE in active views.</div><div class="line">                    //        However, we will NOT place them into scrap views.</div><div class="line">                    activeViews[i] = child;</div><div class="line">                    // Remember the position so that setupChild() doesn&apos;t reset state.</div><div class="line">                    lp.scrappedFromPosition = firstActivePosition + i;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>这个方法接收两个参数，第一个参数表示要存储的view的数量，第二个参数表示ListView中第一个可见元素的position值。RecycleBin当中使用mActiveViews这个数组来存储View，调用这个方法后就会根据传入的参数来将ListView中的指定元素存储到mActiveViews数组当中。</p>
<h3 id="getActiveView"><a href="#getActiveView" class="headerlink" title="getActiveView"></a>getActiveView</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/**</div><div class="line"> * Get the view corresponding to the specified position. The view will be removed from</div><div class="line"> * mActiveViews if it is found.</div><div class="line"> *</div><div class="line"> * @param position The position to look up in mActiveViews</div><div class="line"> * @return The view if it is found, null otherwise</div><div class="line"> */</div><div class="line">View getActiveView(int position) &#123;</div><div class="line">    int index = position - mFirstActivePosition;</div><div class="line">    final View[] activeViews = mActiveViews;</div><div class="line">    if (index &gt;=0 &amp;&amp; index &lt; activeViews.length) &#123;</div><div class="line">        final View match = activeViews[index];</div><div class="line">        activeViews[index] = null;</div><div class="line">        return match;</div><div class="line">    &#125;</div><div class="line">    return null;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>getActiveView() 这个方法和fillActiveViews()是对应的，用于从mActiveViews数组当中获取数据。该方法接收一个position参数，表示元素在ListView当中的位置，方法内部会自动将position值转换成mActiveViews数组对应的下标值。需要注意的是，mActiveViews当中所存储的View，一旦被获取了之后就会从mActiveViews当中移除，下次获取同样位置的View将会返回null，也就是说mActiveViews不能被重复利用。</p>
<h3 id="addScrapView"><a href="#addScrapView" class="headerlink" title="addScrapView()"></a>addScrapView()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">         * Puts a view into the list of scrap views.</div><div class="line">         * &lt;p&gt;</div><div class="line">         * If the list data hasn&apos;t changed or the adapter has stable IDs, views</div><div class="line">         * with transient state will be preserved for later retrieval.</div><div class="line">         *</div><div class="line">         * @param scrap The view to add</div><div class="line">         * @param position The view&apos;s position within its parent</div><div class="line">         */</div><div class="line">        void addScrapView(View scrap, int position) &#123;</div><div class="line">            final AbsListView.LayoutParams lp = (AbsListView.LayoutParams) scrap.getLayoutParams();</div><div class="line">            if (lp == null) &#123;</div><div class="line">                // Can&apos;t recycle, but we don&apos;t know anything about the view.</div><div class="line">                // Ignore it completely.</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            lp.scrappedFromPosition = position;</div><div class="line"></div><div class="line">            // Remove but don&apos;t scrap header or footer views, or views that</div><div class="line">            // should otherwise not be recycled.</div><div class="line">            final int viewType = lp.viewType;</div><div class="line">            if (!shouldRecycleViewType(viewType)) &#123;</div><div class="line">                // Can&apos;t recycle. If it&apos;s not a header or footer, which have</div><div class="line">                // special handling and should be ignored, then skip the scrap</div><div class="line">                // heap and we&apos;ll fully detach the view later.</div><div class="line">                if (viewType != ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">                    getSkippedScrap().add(scrap);</div><div class="line">                &#125;</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            scrap.dispatchStartTemporaryDetach();</div><div class="line"></div><div class="line">            // The the accessibility state of the view may change while temporary</div><div class="line">            // detached and we do not allow detached views to fire accessibility</div><div class="line">            // events. So we are announcing that the subtree changed giving a chance</div><div class="line">            // to clients holding on to a view in this subtree to refresh it.</div><div class="line">            notifyViewAccessibilityStateChangedIfNeeded(</div><div class="line">                    AccessibilityEvent.CONTENT_CHANGE_TYPE_SUBTREE);</div><div class="line"></div><div class="line">            // Don&apos;t scrap views that have transient state.</div><div class="line">            final boolean scrapHasTransientState = scrap.hasTransientState();</div><div class="line">            if (scrapHasTransientState) &#123;</div><div class="line">                if (mAdapter != null &amp;&amp; mAdapterHasStableIds) &#123;</div><div class="line">                    // If the adapter has stable IDs, we can reuse the view for</div><div class="line">                    // the same data.</div><div class="line">                    if (mTransientStateViewsById == null) &#123;</div><div class="line">                        mTransientStateViewsById = new LongSparseArray&lt;&gt;();</div><div class="line">                    &#125;</div><div class="line">                    mTransientStateViewsById.put(lp.itemId, scrap);</div><div class="line">                &#125; else if (!mDataChanged) &#123;</div><div class="line">                    // If the data hasn&apos;t changed, we can reuse the views at</div><div class="line">                    // their old positions.</div><div class="line">                    if (mTransientStateViews == null) &#123;</div><div class="line">                        mTransientStateViews = new SparseArray&lt;&gt;();</div><div class="line">                    &#125;</div><div class="line">                    mTransientStateViews.put(position, scrap);</div><div class="line">                &#125; else &#123;</div><div class="line">                    // Otherwise, we&apos;ll have to remove the view and start over.</div><div class="line">                    getSkippedScrap().add(scrap);</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                if (mViewTypeCount == 1) &#123;</div><div class="line">                    mCurrentScrap.add(scrap);</div><div class="line">                &#125; else &#123;</div><div class="line">                    mScrapViews[viewType].add(scrap);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                if (mRecyclerListener != null) &#123;</div><div class="line">                    mRecyclerListener.onMovedToScrapHeap(scrap);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>用于将一个废弃的View进行缓存，该方法接收一个View参数，当有某个View确定要废弃掉的时候(比如滚动出了屏幕)，就应该调用这个方法来对View进行缓存，RecycleBin当中使用mScrapViews和mCurrentScrap这两个List来存储废弃View。</p>
<h3 id="getScrapView"><a href="#getScrapView" class="headerlink" title="getScrapView"></a>getScrapView</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * @return A view from the ScrapViews collection. These are unordered.</div><div class="line"> */</div><div class="line">View getScrapView(int position) &#123;</div><div class="line">    final int whichScrap = mAdapter.getItemViewType(position);</div><div class="line">    if (whichScrap &lt; 0) &#123;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line">    if (mViewTypeCount == 1) &#123;</div><div class="line">        return retrieveFromScrap(mCurrentScrap, position);</div><div class="line">    &#125; else if (whichScrap &lt; mScrapViews.length) &#123;</div><div class="line">        return retrieveFromScrap(mScrapViews[whichScrap], position);</div><div class="line">    &#125;</div><div class="line">    return null;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>用于从废弃缓存中取出一个View，这些废弃缓存中的View是没有顺序可言的，因此getScrapView()方法中的算法也非常简单，就是直接从mCurrentScrap当中获取尾部的一个scrap view进行返回。</p>
<h2 id="ListView的绘制流程"><a href="#ListView的绘制流程" class="headerlink" title="ListView的绘制流程"></a>ListView的绘制流程</h2><p>上面讲到的getView和RecycleBin都只是提供了缓存数据，优化ListView的方法，如何调用这些方法来实现优化的目的呢？要看ListView的绘制过程中，对这些方法的使用了<br>ListView也是继承自View，所以，他的执行流程也会经过三步：onMeasure()用于测量View的大小，onLayout()用于确定View的布局，onDraw()用于将View绘制到界面上。在ListView当中，onMeasure()并没有什么特殊的地方，因为它终归是一个View，占用的空间最多并且通常也就是整个屏幕。onDraw()在ListView当中也没有什么意义，因为ListView本身并不负责绘制，而是由ListView当中的子元素来进行绘制的。那么ListView大部分的功能其实都是在onLayout()方法中进行。但其实，ListView的onLayout是在其父类AbsListView中实现的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Subclasses should NOT override this method but</div><div class="line"> *  &#123;@link #layoutChildren()&#125; instead.</div><div class="line"> */</div><div class="line">@Override</div><div class="line">protected void onLayout(boolean changed, int l, int t, int r, int b) &#123;</div><div class="line">    super.onLayout(changed, l, t, r, b);</div><div class="line"></div><div class="line">    mInLayout = true;</div><div class="line"></div><div class="line">    final int childCount = getChildCount();</div><div class="line">    if (changed) &#123;</div><div class="line">        for (int i = 0; i &lt; childCount; i++) &#123;</div><div class="line">            getChildAt(i).forceLayout();</div><div class="line">        &#125;</div><div class="line">        mRecycler.markChildrenDirty();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    layoutChildren();</div><div class="line">    mInLayout = false;</div><div class="line"></div><div class="line">    mOverscrollMax = (b - t) / OVERSCROLL_LIMIT_DIVISOR;</div><div class="line"></div><div class="line">    // TODO: Move somewhere sane. This doesn&apos;t belong in onLayout().</div><div class="line">    if (mFastScroll != null) &#123;</div><div class="line">        mFastScroll.onItemCountChanged(getChildCount(), mItemCount);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个函数，前面主要判断了一下ListView的大小或者位置有没有发生变化，如果变化了，就强制重绘。然后就是核心的一行：layoutChildren();然而这个函数的实现，又在ListView中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div></pre></td><td class="code"><pre><div class="line">protected void layoutChildren() &#123;</div><div class="line">    final boolean blockLayoutRequests = mBlockLayoutRequests;</div><div class="line">    if (blockLayoutRequests) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mBlockLayoutRequests = true;</div><div class="line"></div><div class="line">    try &#123;</div><div class="line">        super.layoutChildren();</div><div class="line"></div><div class="line">        invalidate();</div><div class="line"></div><div class="line">        if (mAdapter == null) &#123;</div><div class="line">            resetList();</div><div class="line">            invokeOnItemScrollListener();</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        final int childrenTop = mListPadding.top;</div><div class="line">        final int childrenBottom = mBottom - mTop - mListPadding.bottom;</div><div class="line">        final int childCount = getChildCount();</div><div class="line"></div><div class="line">        int index = 0;</div><div class="line">        int delta = 0;</div><div class="line"></div><div class="line">        View sel;</div><div class="line">        View oldSel = null;</div><div class="line">        View oldFirst = null;</div><div class="line">        View newSel = null;</div><div class="line"></div><div class="line">        // Remember stuff we will need down below</div><div class="line">        switch (mLayoutMode) &#123;</div><div class="line">        case LAYOUT_SET_SELECTION:</div><div class="line">            index = mNextSelectedPosition - mFirstPosition;</div><div class="line">            if (index &gt;= 0 &amp;&amp; index &lt; childCount) &#123;</div><div class="line">                newSel = getChildAt(index);</div><div class="line">            &#125;</div><div class="line">            break;</div><div class="line">        case LAYOUT_FORCE_TOP:</div><div class="line">        case LAYOUT_FORCE_BOTTOM:</div><div class="line">        case LAYOUT_SPECIFIC:</div><div class="line">        case LAYOUT_SYNC:</div><div class="line">            break;</div><div class="line">        case LAYOUT_MOVE_SELECTION:</div><div class="line">        default:</div><div class="line">            // Remember the previously selected view</div><div class="line">            index = mSelectedPosition - mFirstPosition;</div><div class="line">            if (index &gt;= 0 &amp;&amp; index &lt; childCount) &#123;</div><div class="line">                oldSel = getChildAt(index);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // Remember the previous first child</div><div class="line">            oldFirst = getChildAt(0);</div><div class="line"></div><div class="line">            if (mNextSelectedPosition &gt;= 0) &#123;</div><div class="line">                delta = mNextSelectedPosition - mSelectedPosition;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // Caution: newSel might be null</div><div class="line">            newSel = getChildAt(index + delta);</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        boolean dataChanged = mDataChanged;</div><div class="line">        if (dataChanged) &#123;</div><div class="line">            handleDataChanged();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Handle the empty set by removing all views that are visible</div><div class="line">        // and calling it a day</div><div class="line">        if (mItemCount == 0) &#123;</div><div class="line">            resetList();</div><div class="line">            invokeOnItemScrollListener();</div><div class="line">            return;</div><div class="line">        &#125; else if (mItemCount != mAdapter.getCount()) &#123;</div><div class="line">            throw new IllegalStateException(&quot;The content of the adapter has changed but &quot;</div><div class="line">                    + &quot;ListView did not receive a notification. Make sure the content of &quot;</div><div class="line">                    + &quot;your adapter is not modified from a background thread, but only from &quot;</div><div class="line">                    + &quot;the UI thread. Make sure your adapter calls notifyDataSetChanged() &quot;</div><div class="line">                    + &quot;when its content changes. [in ListView(&quot; + getId() + &quot;, &quot; + getClass()</div><div class="line">                    + &quot;) with Adapter(&quot; + mAdapter.getClass() + &quot;)]&quot;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        setSelectedPositionInt(mNextSelectedPosition);</div><div class="line"></div><div class="line">        AccessibilityNodeInfo accessibilityFocusLayoutRestoreNode = null;</div><div class="line">        View accessibilityFocusLayoutRestoreView = null;</div><div class="line">        int accessibilityFocusPosition = INVALID_POSITION;</div><div class="line"></div><div class="line">        // Remember which child, if any, had accessibility focus. This must</div><div class="line">        // occur before recycling any views, since that will clear</div><div class="line">        // accessibility focus.</div><div class="line">        final ViewRootImpl viewRootImpl = getViewRootImpl();</div><div class="line">        if (viewRootImpl != null) &#123;</div><div class="line">            final View focusHost = viewRootImpl.getAccessibilityFocusedHost();</div><div class="line">            if (focusHost != null) &#123;</div><div class="line">                final View focusChild = getAccessibilityFocusedChild(focusHost);</div><div class="line">                if (focusChild != null) &#123;</div><div class="line">                    if (!dataChanged || isDirectChildHeaderOrFooter(focusChild)</div><div class="line">                            || focusChild.hasTransientState() || mAdapterHasStableIds) &#123;</div><div class="line">                        // The views won&apos;t be changing, so try to maintain</div><div class="line">                        // focus on the current host and virtual view.</div><div class="line">                        accessibilityFocusLayoutRestoreView = focusHost;</div><div class="line">                        accessibilityFocusLayoutRestoreNode = viewRootImpl</div><div class="line">                                .getAccessibilityFocusedVirtualView();</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    // If all else fails, maintain focus at the same</div><div class="line">                    // position.</div><div class="line">                    accessibilityFocusPosition = getPositionForView(focusChild);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        View focusLayoutRestoreDirectChild = null;</div><div class="line">        View focusLayoutRestoreView = null;</div><div class="line"></div><div class="line">        // Take focus back to us temporarily to avoid the eventual call to</div><div class="line">        // clear focus when removing the focused child below from messing</div><div class="line">        // things up when ViewAncestor assigns focus back to someone else.</div><div class="line">        final View focusedChild = getFocusedChild();</div><div class="line">        if (focusedChild != null) &#123;</div><div class="line">            // TODO: in some cases focusedChild.getParent() == null</div><div class="line"></div><div class="line">            // We can remember the focused view to restore after re-layout</div><div class="line">            // if the data hasn&apos;t changed, or if the focused position is a</div><div class="line">            // header or footer.</div><div class="line">            if (!dataChanged || isDirectChildHeaderOrFooter(focusedChild)</div><div class="line">                    || focusedChild.hasTransientState() || mAdapterHasStableIds) &#123;</div><div class="line">                focusLayoutRestoreDirectChild = focusedChild;</div><div class="line">                // Remember the specific view that had focus.</div><div class="line">                focusLayoutRestoreView = findFocus();</div><div class="line">                if (focusLayoutRestoreView != null) &#123;</div><div class="line">                    // Tell it we are going to mess with it.</div><div class="line">                    focusLayoutRestoreView.onStartTemporaryDetach();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            requestFocus();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Pull all children into the RecycleBin.</div><div class="line">        // These views will be reused if possible</div><div class="line">        final int firstPosition = mFirstPosition;</div><div class="line">        final RecycleBin recycleBin = mRecycler;</div><div class="line">        if (dataChanged) &#123;</div><div class="line">            for (int i = 0; i &lt; childCount; i++) &#123;</div><div class="line">                recycleBin.addScrapView(getChildAt(i), firstPosition+i);</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            recycleBin.fillActiveViews(childCount, firstPosition);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Clear out old views</div><div class="line">        detachAllViewsFromParent();</div><div class="line">        recycleBin.removeSkippedScrap();</div><div class="line"></div><div class="line">        switch (mLayoutMode) &#123;</div><div class="line">        case LAYOUT_SET_SELECTION:</div><div class="line">            if (newSel != null) &#123;</div><div class="line">                sel = fillFromSelection(newSel.getTop(), childrenTop, childrenBottom);</div><div class="line">            &#125; else &#123;</div><div class="line">                sel = fillFromMiddle(childrenTop, childrenBottom);</div><div class="line">            &#125;</div><div class="line">            break;</div><div class="line">        case LAYOUT_SYNC:</div><div class="line">            sel = fillSpecific(mSyncPosition, mSpecificTop);</div><div class="line">            break;</div><div class="line">        case LAYOUT_FORCE_BOTTOM:</div><div class="line">            sel = fillUp(mItemCount - 1, childrenBottom);</div><div class="line">            adjustViewsUpOrDown();</div><div class="line">            break;</div><div class="line">        case LAYOUT_FORCE_TOP:</div><div class="line">            mFirstPosition = 0;</div><div class="line">            sel = fillFromTop(childrenTop);</div><div class="line">            adjustViewsUpOrDown();</div><div class="line">            break;</div><div class="line">        case LAYOUT_SPECIFIC:</div><div class="line">            sel = fillSpecific(reconcileSelectedPosition(), mSpecificTop);</div><div class="line">            break;</div><div class="line">        case LAYOUT_MOVE_SELECTION:</div><div class="line">            sel = moveSelection(oldSel, newSel, delta, childrenTop, childrenBottom);</div><div class="line">            break;</div><div class="line">        default:</div><div class="line">            if (childCount == 0) &#123;</div><div class="line">                if (!mStackFromBottom) &#123;</div><div class="line">                    final int position = lookForSelectablePosition(0, true);</div><div class="line">                    setSelectedPositionInt(position);</div><div class="line">                    sel = fillFromTop(childrenTop);</div><div class="line">                &#125; else &#123;</div><div class="line">                    final int position = lookForSelectablePosition(mItemCount - 1, false);</div><div class="line">                    setSelectedPositionInt(position);</div><div class="line">                    sel = fillUp(mItemCount - 1, childrenBottom);</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                if (mSelectedPosition &gt;= 0 &amp;&amp; mSelectedPosition &lt; mItemCount) &#123;</div><div class="line">                    sel = fillSpecific(mSelectedPosition,</div><div class="line">                            oldSel == null ? childrenTop : oldSel.getTop());</div><div class="line">                &#125; else if (mFirstPosition &lt; mItemCount) &#123;</div><div class="line">                    sel = fillSpecific(mFirstPosition,</div><div class="line">                            oldFirst == null ? childrenTop : oldFirst.getTop());</div><div class="line">                &#125; else &#123;</div><div class="line">                    sel = fillSpecific(0, childrenTop);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Flush any cached views that did not get reused above</div><div class="line">        recycleBin.scrapActiveViews();</div><div class="line"></div><div class="line">        if (sel != null) &#123;</div><div class="line">            // The current selected item should get focus if items are</div><div class="line">            // focusable.</div><div class="line">            if (mItemsCanFocus &amp;&amp; hasFocus() &amp;&amp; !sel.hasFocus()) &#123;</div><div class="line">                final boolean focusWasTaken = (sel == focusLayoutRestoreDirectChild &amp;&amp;</div><div class="line">                        focusLayoutRestoreView != null &amp;&amp;</div><div class="line">                        focusLayoutRestoreView.requestFocus()) || sel.requestFocus();</div><div class="line">                if (!focusWasTaken) &#123;</div><div class="line">                    // Selected item didn&apos;t take focus, but we still want to</div><div class="line">                    // make sure something else outside of the selected view</div><div class="line">                    // has focus.</div><div class="line">                    final View focused = getFocusedChild();</div><div class="line">                    if (focused != null) &#123;</div><div class="line">                        focused.clearFocus();</div><div class="line">                    &#125;</div><div class="line">                    positionSelector(INVALID_POSITION, sel);</div><div class="line">                &#125; else &#123;</div><div class="line">                    sel.setSelected(false);</div><div class="line">                    mSelectorRect.setEmpty();</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                positionSelector(INVALID_POSITION, sel);</div><div class="line">            &#125;</div><div class="line">            mSelectedTop = sel.getTop();</div><div class="line">        &#125; else &#123;</div><div class="line">            final boolean inTouchMode = mTouchMode == TOUCH_MODE_TAP</div><div class="line">                    || mTouchMode == TOUCH_MODE_DONE_WAITING;</div><div class="line">            if (inTouchMode) &#123;</div><div class="line">                // If the user&apos;s finger is down, select the motion position.</div><div class="line">                final View child = getChildAt(mMotionPosition - mFirstPosition);</div><div class="line">                if (child != null) &#123;</div><div class="line">                    positionSelector(mMotionPosition, child);</div><div class="line">                &#125;</div><div class="line">            &#125; else if (mSelectorPosition != INVALID_POSITION) &#123;</div><div class="line">                // If we had previously positioned the selector somewhere,</div><div class="line">                // put it back there. It might not match up with the data,</div><div class="line">                // but it&apos;s transitioning out so it&apos;s not a big deal.</div><div class="line">                final View child = getChildAt(mSelectorPosition - mFirstPosition);</div><div class="line">                if (child != null) &#123;</div><div class="line">                    positionSelector(mSelectorPosition, child);</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                // Otherwise, clear selection.</div><div class="line">                mSelectedTop = 0;</div><div class="line">                mSelectorRect.setEmpty();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // Even if there is not selected position, we may need to</div><div class="line">            // restore focus (i.e. something focusable in touch mode).</div><div class="line">            if (hasFocus() &amp;&amp; focusLayoutRestoreView != null) &#123;</div><div class="line">                focusLayoutRestoreView.requestFocus();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Attempt to restore accessibility focus, if necessary.</div><div class="line">        if (viewRootImpl != null) &#123;</div><div class="line">            final View newAccessibilityFocusedView = viewRootImpl.getAccessibilityFocusedHost();</div><div class="line">            if (newAccessibilityFocusedView == null) &#123;</div><div class="line">                if (accessibilityFocusLayoutRestoreView != null</div><div class="line">                        &amp;&amp; accessibilityFocusLayoutRestoreView.isAttachedToWindow()) &#123;</div><div class="line">                    final AccessibilityNodeProvider provider =</div><div class="line">                            accessibilityFocusLayoutRestoreView.getAccessibilityNodeProvider();</div><div class="line">                    if (accessibilityFocusLayoutRestoreNode != null &amp;&amp; provider != null) &#123;</div><div class="line">                        final int virtualViewId = AccessibilityNodeInfo.getVirtualDescendantId(</div><div class="line">                                accessibilityFocusLayoutRestoreNode.getSourceNodeId());</div><div class="line">                        provider.performAction(virtualViewId,</div><div class="line">                                AccessibilityNodeInfo.ACTION_ACCESSIBILITY_FOCUS, null);</div><div class="line">                    &#125; else &#123;</div><div class="line">                        accessibilityFocusLayoutRestoreView.requestAccessibilityFocus();</div><div class="line">                    &#125;</div><div class="line">                &#125; else if (accessibilityFocusPosition != INVALID_POSITION) &#123;</div><div class="line">                    // Bound the position within the visible children.</div><div class="line">                    final int position = MathUtils.constrain(</div><div class="line">                            accessibilityFocusPosition - mFirstPosition, 0,</div><div class="line">                            getChildCount() - 1);</div><div class="line">                    final View restoreView = getChildAt(position);</div><div class="line">                    if (restoreView != null) &#123;</div><div class="line">                        restoreView.requestAccessibilityFocus();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Tell focus view we are done mucking with it, if it is still in</div><div class="line">        // our view hierarchy.</div><div class="line">        if (focusLayoutRestoreView != null</div><div class="line">                &amp;&amp; focusLayoutRestoreView.getWindowToken() != null) &#123;</div><div class="line">            focusLayoutRestoreView.onFinishTemporaryDetach();</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        mLayoutMode = LAYOUT_NORMAL;</div><div class="line">        mDataChanged = false;</div><div class="line">        if (mPositionScrollAfterLayout != null) &#123;</div><div class="line">            post(mPositionScrollAfterLayout);</div><div class="line">            mPositionScrollAfterLayout = null;</div><div class="line">        &#125;</div><div class="line">        mNeedSync = false;</div><div class="line">        setNextSelectedPositionInt(mSelectedPosition);</div><div class="line"></div><div class="line">        updateScrollIndicators();</div><div class="line"></div><div class="line">        if (mItemCount &gt; 0) &#123;</div><div class="line">            checkSelectionChanged();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        invokeOnItemScrollListener();</div><div class="line">    &#125; finally &#123;</div><div class="line">        if (!blockLayoutRequests) &#123;</div><div class="line">            mBlockLayoutRequests = false;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>太长了，将第一次layout时用到的重要部分单独提取出来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">protected void layoutChildren() &#123;</div><div class="line">	...</div><div class="line">          final int childCount = getChildCount();</div><div class="line">	</div><div class="line"></div><div class="line">	...</div><div class="line">          boolean dataChanged = mDataChanged;</div><div class="line">	...</div><div class="line">          if (dataChanged) &#123;</div><div class="line">		...</div><div class="line">          &#125; else &#123;</div><div class="line">              recycleBin.fillActiveViews(childCount, firstPosition);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">	...</div><div class="line">          switch (mLayoutMode) &#123;</div><div class="line">          case LAYOUT_SET_SELECTION:</div><div class="line">              ...</div><div class="line">          case LAYOUT_SYNC:</div><div class="line">              ...</div><div class="line">          case LAYOUT_FORCE_BOTTOM:</div><div class="line">              ...</div><div class="line">          case LAYOUT_FORCE_TOP:</div><div class="line">              ...</div><div class="line">          case LAYOUT_SPECIFIC:</div><div class="line">              ...</div><div class="line">          case LAYOUT_MOVE_SELECTION:</div><div class="line">              ...</div><div class="line">          default:</div><div class="line">              if (childCount == 0) &#123;</div><div class="line">                  if (!mStackFromBottom) &#123;</div><div class="line">                      ...</div><div class="line">                      sel = fillFromTop(childrenTop);</div><div class="line">                  &#125; else &#123;</div><div class="line">                      ...</div><div class="line">                  &#125;</div><div class="line">              &#125; else &#123;</div><div class="line">                  ...</div><div class="line">              &#125;</div><div class="line">              break;</div><div class="line">          &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>ListView当中目前还没有任何子View，数据都还是由Adapter管理的，并没有展示到界面上，因此getChildCount()方法得到的值肯定是0。接着会根据dataChanged这个布尔型的值来判断执行逻辑，dataChanged只有在数据源发生改变的情况下才会变成true，其它情况都是false，因此这里调用RecycleBin的fillActiveViews()方法。按理来说，调用fillActiveViews()方法是为了将ListView的子View进行缓存的，可是目前ListView中还没有任何的子View，因此这一行暂时还起不了任何作用。<br>接下来根据mLayoutMode的值来决定布局模式，默认情况下都是普通模式LAYOUT_NORMAL，因此会进入到default语句当中。而下面又会紧接着进行两次if判断，childCount目前是等于0的，并且默认的布局顺序是从上往下，因此会进入到fillFromTop()方法中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">private View fillFromTop(int nextTop) &#123;</div><div class="line">    mFirstPosition = Math.min(mFirstPosition, mSelectedPosition);</div><div class="line">    mFirstPosition = Math.min(mFirstPosition, mItemCount - 1);</div><div class="line">    if (mFirstPosition &lt; 0) &#123;</div><div class="line">        mFirstPosition = 0;</div><div class="line">    &#125;</div><div class="line">    return fillDown(mFirstPosition, nextTop);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>基本上，只是调用了fillDown<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">private View fillDown(int pos, int nextTop) &#123;</div><div class="line">    View selectedView = null;</div><div class="line"></div><div class="line">    int end = (mBottom - mTop);</div><div class="line">    if ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">        end -= mListPadding.bottom;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    while (nextTop &lt; end &amp;&amp; pos &lt; mItemCount) &#123;</div><div class="line">        // is this the selected item?</div><div class="line">        boolean selected = pos == mSelectedPosition;</div><div class="line">        View child = makeAndAddView(pos, nextTop, true, mListPadding.left, selected);</div><div class="line"></div><div class="line">        nextTop = child.getBottom() + mDividerHeight;</div><div class="line">        if (selected) &#123;</div><div class="line">            selectedView = child;</div><div class="line">        &#125;</div><div class="line">        pos++;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    setVisibleRangeHint(mFirstPosition, mFirstPosition + getChildCount() - 1);</div><div class="line">    return selectedView;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里使用了一个while循环来执行重复逻辑，一开始nextTop的值是第一个子元素顶部距离整个ListView顶部的像素值，pos则是刚刚传入的mFirstPosition的值，而end是ListView底部减去顶部所得的像素值，mItemCount则是Adapter中的元素数量。因此一开始的情况下nextTop必定是小于end值的，并且pos也是小于mItemCount值的。那么每执行一次while循环，pos的值都会加1，并且nextTop也会增加，当nextTop大于等于end时，也就是子元素已经超出当前屏幕了，或者pos大于等于mItemCount时，也就是所有Adapter中的元素都被遍历结束了，就会跳出while循环。<br>while循环中，主要调用了makeAndAddView()方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">private View makeAndAddView(int position, int y, boolean flow, int childrenLeft,</div><div class="line">        boolean selected) &#123;</div><div class="line">    View child;</div><div class="line"></div><div class="line"></div><div class="line">    if (!mDataChanged) &#123;</div><div class="line">        // Try to use an existing view for this position</div><div class="line">        child = mRecycler.getActiveView(position);</div><div class="line">        if (child != null) &#123;</div><div class="line">            // Found it -- we&apos;re using an existing child</div><div class="line">            // This just needs to be positioned</div><div class="line">            setupChild(child, position, y, flow, childrenLeft, selected, true);</div><div class="line"></div><div class="line">            return child;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Make a new view for this position, or convert an unused view if possible</div><div class="line">    child = obtainView(position, mIsScrap);</div><div class="line"></div><div class="line">    // This needs to be positioned and measured</div><div class="line">    setupChild(child, position, y, flow, childrenLeft, selected, mIsScrap[0]);</div><div class="line"></div><div class="line">    return child;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先尝试从RecycleBin当中快速获取一个active view，不过很遗憾的是目前RecycleBin当中还没有缓存任何的View，所以这里得到的值肯定是null。那么取得了null之后就会继续向下运行，会调用obtainView()方法来再次尝试获取一个View，这次的obtainView()方法是可以保证一定返回一个View的，于是下面立刻将获取到的View传入到了setupChild()方法当中。这个方法在AbsListView.java中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">  View obtainView(int position, boolean[] isScrap) &#123;</div><div class="line">...</div><div class="line">      final View scrapView = mRecycler.getScrapView(position);</div><div class="line">      final View child = mAdapter.getView(position, scrapView, this);</div><div class="line">      if (scrapView != null) &#123;</div><div class="line">          if (child != scrapView) &#123;</div><div class="line">              // Failed to re-bind the data, return scrap to the heap.</div><div class="line">              mRecycler.addScrapView(scrapView, position);</div><div class="line">          &#125; else &#123;</div><div class="line">              isScrap[0] = true;</div><div class="line"></div><div class="line">              // Finish the temporary detach started in addScrapView().</div><div class="line">              child.dispatchFinishTemporaryDetach();</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">...</div><div class="line"></div><div class="line">      return child;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>调用了RecycleBin的getScrapView()方法来尝试获取一个废弃缓存中的View，赋值给scrapView,同样的道理，这里肯定是获取不到的，getScrapView()方法会返回一个null。然后调用mAdapter的getView()方法来去获取一个View，赋值给child。如果scrapView不为空，且不等于child，就更新recyclerBin。在首次layout的时候， 必定是每行都需要去调用mAdapter的getView()方法来去获取View，也就是调用到了前面章节介绍到的getView方法。这个View会赋值给child并作为函数结果返回，并最终传入到setupChild()方法当中。其实也就是说，第一次layout过程当中，所有的子View都是调用LayoutInflater的inflate()方法加载出来的，这样就会相对比较耗时，但是不用担心，后面就不会再有这种情况了.接着看setupChild方法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">private void setupChild(View child, int position, int y, boolean flowDown, int childrenLeft,</div><div class="line">        boolean selected, boolean recycled) &#123;</div><div class="line">    ...</div><div class="line">    if ((recycled &amp;&amp; !p.forceAdd) || (p.recycledHeaderFooter</div><div class="line">            &amp;&amp; p.viewType == AdapterView.ITEM_VIEW_TYPE_HEADER_OR_FOOTER)) &#123;</div><div class="line">        ...</div><div class="line">    &#125; else &#123;</div><div class="line">        ...</div><div class="line">        addViewInLayout(child, flowDown ? -1 : 0, p, true);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>刚才调用obtainView()方法获取到的子元素View，这里调用了addViewInLayout()方法将它添加到了ListView当中。那么根据fillDown()方法中的while循环，会让子元素View将整个ListView控件填满然后就跳出，也就是说即使我们的Adapter中有一千条数据，ListView也只会加载第一屏的数据，剩下的数据反正目前在屏幕上也看不到，所以不会去做多余的加载工作，这样就可以保证ListView中的内容能够迅速展示到屏幕上。<br>那么到此为止，第一次Layout过程结束。</p>
<h3 id="第二次layout"><a href="#第二次layout" class="headerlink" title="第二次layout"></a>第二次layout</h3><p>View，在展示到界面上之前都会经历至少两次onMeasure()和两次onLayout()的过程。</p>
<p>还是从layoutChildren()方法开始：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">protected void layoutChildren() &#123;</div><div class="line">        	...</div><div class="line">            final int childCount = getChildCount();</div><div class="line"></div><div class="line">            ...</div><div class="line">            if (dataChanged) &#123;</div><div class="line">                ...</div><div class="line">            &#125; else &#123;</div><div class="line">                recycleBin.fillActiveViews(childCount, firstPosition);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // Clear out old views</div><div class="line">            detachAllViewsFromParent();</div><div class="line">            recycleBin.removeSkippedScrap();</div><div class="line"></div><div class="line">            switch (mLayoutMode) &#123;</div><div class="line">            case LAYOUT_SET_SELECTION:</div><div class="line">                ...</div><div class="line">            case LAYOUT_SYNC:</div><div class="line">                ...</div><div class="line">            case LAYOUT_FORCE_BOTTOM:</div><div class="line">                ...</div><div class="line">            case LAYOUT_FORCE_TOP:</div><div class="line">                ...</div><div class="line">            case LAYOUT_SPECIFIC:</div><div class="line">                ...</div><div class="line">            case LAYOUT_MOVE_SELECTION:</div><div class="line">                ...</div><div class="line">            default:</div><div class="line">                if (childCount == 0) &#123;</div><div class="line">                    ...</div><div class="line">                &#125; else &#123;</div><div class="line">                    if (mSelectedPosition &gt;= 0 &amp;&amp; mSelectedPosition &lt; mItemCount) &#123;</div><div class="line">                        sel = fillSpecific(mSelectedPosition,</div><div class="line">                                oldSel == null ? childrenTop : oldSel.getTop());</div><div class="line">                    &#125; else if (mFirstPosition &lt; mItemCount) &#123;</div><div class="line">                        sel = fillSpecific(mFirstPosition,</div><div class="line">                                oldFirst == null ? childrenTop : oldFirst.getTop());</div><div class="line">                    &#125; else &#123;</div><div class="line">                        sel = fillSpecific(0, childrenTop);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>同样还是调用getChildCount()方法来获取子View的数量，只不过现在得到的值不会再是0了，而是ListView中一屏可以显示的子View数量，因为我们刚刚在第一次Layout过程当中向ListView添加了这么多的子View。下面调用了RecycleBin的fillActiveViews()方法，这次效果可就不一样了，因为目前ListView中已经有子View了，这样所有的子View都会被缓存到RecycleBin的mActiveViews数组当中，后面将会用到它们。<br>接下来将会是非常非常重要的一个操作，调用了detachAllViewsFromParent()方法。这个方法会将所有ListView当中的子View全部清除掉，从而保证第二次Layout过程不会产生一份重复的数据。这样把已经加载好的View又清除掉，待会还要再重新加载一遍，这不是严重影响效率吗？不用担心，还记得我们刚刚调用了RecycleBin的fillActiveViews()方法来缓存子View吗，待会儿将会直接使用这些缓存好的View来进行加载，而并不会重新执行一遍inflate过程，因此效率方面并不会有什么明显的影响。<br>在接下来的判断逻辑当中，由于不再等于0了，因此会进入到else语句当中。而else语句中又有三个逻辑判断，第一个逻辑判断不成立，因为默认情况下我们没有选中任何子元素，mSelectedPosition应该等于-1。第二个逻辑判断通常是成立的，因为mFirstPosition的值一开始是等于0的，只要adapter中的数据大于0条件就成立。那么进入到fillSpecific()方法当中，代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">private View fillSpecific(int position, int top) &#123;</div><div class="line">    boolean tempIsSelected = position == mSelectedPosition;</div><div class="line">    View temp = makeAndAddView(position, top, true, mListPadding.left, tempIsSelected);</div><div class="line">    // Possibly changed again in fillUp if we add rows above this one.</div><div class="line">    mFirstPosition = position;</div><div class="line"></div><div class="line">    View above;</div><div class="line">    View below;</div><div class="line"></div><div class="line">    final int dividerHeight = mDividerHeight;</div><div class="line">    if (!mStackFromBottom) &#123;</div><div class="line">        above = fillUp(position - 1, temp.getTop() - dividerHeight);</div><div class="line">        // This will correct for the top of the first view not touching the top of the list</div><div class="line">        adjustViewsUpOrDown();</div><div class="line">        below = fillDown(position + 1, temp.getBottom() + dividerHeight);</div><div class="line">        int childCount = getChildCount();</div><div class="line">        if (childCount &gt; 0) &#123;</div><div class="line">            correctTooHigh(childCount);</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        below = fillDown(position + 1, temp.getBottom() + dividerHeight);</div><div class="line">        // This will correct for the bottom of the last view not touching the bottom of the list</div><div class="line">        adjustViewsUpOrDown();</div><div class="line">        above = fillUp(position - 1, temp.getTop() - dividerHeight);</div><div class="line">        int childCount = getChildCount();</div><div class="line">        if (childCount &gt; 0) &#123;</div><div class="line">             correctTooLow(childCount);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (tempIsSelected) &#123;</div><div class="line">        return temp;</div><div class="line">    &#125; else if (above != null) &#123;</div><div class="line">        return above;</div><div class="line">    &#125; else &#123;</div><div class="line">        return below;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>fillSpecific()这算是一个新方法了，不过其实它和fillUp()、fillDown()方法功能也是差不多的，主要的区别在于，fillSpecific()方法会优先将指定位置的子View先加载到屏幕上，然后再加载该子View往上以及往下的其它子View。那么由于这里我们传入的position就是第一个子View的位置，于是fillSpecific()方法的作用就基本上和fillDown()方法是差不多的了，核心函数依然是makeAndAddView</p>
<p><a href="http://m.blog.csdn.net/article/details?id=44996879" target="_blank" rel="external">详细分析</a></p>
<h2 id="滑动时不加载图片"><a href="#滑动时不加载图片" class="headerlink" title="滑动时不加载图片"></a>滑动时不加载图片</h2><p><a href="http://www.aichengxu.com/view/507689" target="_blank" rel="external">示例</a></p>

      
    </div>
    
  </div>
  
    


    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2016/10/26/pattern-singleton/">
                    Android中的设计模式之单例模式
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2016/10/08/oneday-context/">
                    Android中的context详解
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目錄</strong>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#重用ConvertView和使用ViewHolder模式"><span class="toc-number">1.</span> <span class="toc-text">重用ConvertView和使用ViewHolder模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ListView的复用机制"><span class="toc-number">2.</span> <span class="toc-text">ListView的复用机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fillActiveViews"><span class="toc-number">2.1.</span> <span class="toc-text">fillActiveViews</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getActiveView"><span class="toc-number">2.2.</span> <span class="toc-text">getActiveView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#addScrapView"><span class="toc-number">2.3.</span> <span class="toc-text">addScrapView()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getScrapView"><span class="toc-number">2.4.</span> <span class="toc-text">getScrapView</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ListView的绘制流程"><span class="toc-number">3.</span> <span class="toc-text">ListView的绘制流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#第二次layout"><span class="toc-number">3.1.</span> <span class="toc-text">第二次layout</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#滑动时不加载图片"><span class="toc-number">4.</span> <span class="toc-text">滑动时不加载图片</span></a></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隱藏目錄"  title="點擊按鈕隱藏或者顯示文章目錄">

    <script>
        yiliaConfig.toc = ["隱藏目錄", "顯示目錄", !!"false"];
    </script>





    
      <div class="duoshuo" id="comments">
    <div id="comment-box" ></div>
    <div class="ds-thread" id="ds-thread" data-thread-key="2016/10/10/oneday-listview/" data-title="如何优化listView" data-url="http://yoursite.com/2016/10/10/oneday-listview/"></div>
    <script>
        var duoshuoQuery = {short_name:"ichrisking"};
        var loadComment = function(){
            var d = document, s = d.createElement('script');
            s.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
            s.async = true; s.charset = 'UTF-8';
            (d.head || d.body).appendChild(s);
        }

        
    </script>
    
    <script> loadComment(); </script>

</div>
    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2016/10/26/pattern-singleton/" title="上一篇: Android中的设计模式之单例模式">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2016/10/08/oneday-context/" title="下一篇: Android中的context详解">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/08/30/rom7-0-phone/">rom7.0-phone</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/28/cjdns-SuperNode/">cjdns_SuperNode</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/25/rom7.0-build/">Android7.0Rom编译相关</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/02/cjdns_RouteGen/">cjdns源码分析--RouteGen</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/31/build-intranet-test/">一个简单的内外网连通实验</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/25/cjdns_IpTunnel/">cjdns源码分析--IpTunnel</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/27/about-iptables/">iptables在anet项目中的运用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/21/how-to-build-git-on-raspberry/">在树莓派上搭建私有git</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/15/raspberry-add-camera-dev/">树莓派摄像头没有/dev/video0设备节点的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/12/ping-pong/">cjdns源码分析--SwitchPing的发送，接收与回复</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/04/contentprovider/">Android中的ContentProvider,ContentResolver,ContentObserver</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/21/pattern-proxy/">Android中的设计模式之代理模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/20/pattern-decorator/">Android中的设计模式之装饰者模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/13/activity-launch-mode/">activity启动模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/12/bin-tree/">二叉搜索树</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/29/pattern-builder/">Android中的设计模式之建造模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/23/pattern-strategy/">Android中的设计模式之策略模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/22/pattern-prototype/">Android中的设计模式之原型模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/21/Search/">各种查找算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/21/pattern-adapter/">Android中的设计模式之适配器模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/17/pattern-factory/">Android中的设计模式之工厂模式系列</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/10/pattern-flyweight/">Android中的设计模式之享元模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/09/pattern-memento/">Android中的设计模式之备忘录模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/08/pattern-template-method/">Android中的设计模式之模板方法模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/07/pattern-observer/">Android中的设计模式之观察者模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/04/pattern-composite/">Android中的设计模式之组合模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/02/Sort/">各种排序算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/01/oneday-ShardPreferences/">ShardPreferences</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/31/oneday-AsyncTask/">AsyncTask</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/26/pattern-singleton/">Android中的设计模式之单例模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/10/oneday-listview/">如何优化listView</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/08/oneday-context/">Android中的context详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/27/android-parcelable/">activity之间传递数据的方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/26/oneday-handler/">android的Handler机制详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/22/oneday-activity-lifecycle/">Activity生命周期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/22/pass-by-value-or-reference/">Java中的值传递和引用传递</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/22/oneday_BroadcastReceiver/">BroadcastReceiver</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/21/oneday_service/">Android中的Service</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/21/sunjdk/">如何安装sunjdk，并用它替代openjdk</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/19/mvp_in_android/">MVP in Android</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/19/java_synchronized/">Java并发</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/18/java_list_hashmap/">Java集合框架</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/09/java_basic/">Java基础知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/08/pattern-design/">设计模式概述</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/31/Binder/">Binder</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/24/Fragment/">Fragment</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/24/Android-TouchEvent/">Android事件分发机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/23/ANR-and-FC/">ANR与FC</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/23/Android-performance-optimization/">Android性能优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/23/how_to_use_locate_image_file_in_hexo/">如何在hexo中使用本地图片</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/23/reinstall-hexo-after-reinstall-OS/">重装系统后，修复hexo</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/22/Android_memory_leak/">Android内存泄漏</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/18/Android1_1/">Android基础知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/05/build_shadowsocks/">配置shadowsocks</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/24/change-hexo-theme-to-maupassant/">对我的Blog做了点改动</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/23/AnromOS_deploy/">Anrom日常发布方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/21/AnromOS_Web_Build/">AnromOS发布网站的搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/19/make_blog_with_hexo/">使用hexo搭建blog</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/08/rsync/">拷貝代碼利器rsync</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/31/add_jar_into_android_mk_file/">給Android系統應用加jar包</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/16/port22_Connection_refused/">port 22: Connection refused</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/01/SEAndroid/">SEAndroid in Android5.x</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/06/11/access_ssl_with_okhttp/">使用OkHttp访问ssl（https）网络</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/04/20/build_java_jar_based_on_android_code/">如何使用android源码来制作java的jar包</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/02/04/save_discarding_commits/">找回差點丟失的commit</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/01/16/build_new_project_in_work_zone/">如何爲辦公區新建一個項目</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/01/06/add_new_function_in_local_service/">爲android添加一個新的service函數</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/03/21/deny_connect_with_usb/">源碼中實現禁止手機鏈接usb</a></li><li class="post-list-item"><a class="post-list-link" href="/2014/02/14/add_tomoyo_to_android_system/">移植TOMOYO的步驟</a></li><li class="post-list-item"><a class="post-list-link" href="/2013/06/09/make_deamon_thead_in_android/">爲android編寫一個deamon進程</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2017 Chris King
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、簡單且強大的網誌框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="簡而不減 Hexo 雙欄網誌主題  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到訪數"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本頁閱讀量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回頂部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看評論"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="轉到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
             categories: ".article-category a, a.tag-list-link", 
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>